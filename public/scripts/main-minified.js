"PIXI"in window&&(PIXI.RenderTexture.prototype.renderToCanvas=function(e){var t=this.renderer.gl,i=this.textureBuffer.width,s=this.textureBuffer.height,o=new Uint8Array(4*i*s),t=(t.bindFramebuffer(t.FRAMEBUFFER,this.textureBuffer.frameBuffer),t.readPixels(0,0,i,s,t.RGBA,t.UNSIGNED_BYTE,o),t.bindFramebuffer(t.FRAMEBUFFER,null),e.resize(i,s),e.context.getImageData(0,0,i,s));return t.data.set(o),e.context.putImageData(t,0,0),e.canvas},PIXI.RenderTexture.prototype.renderToDataTexture=function(e){var t=this.renderer.gl,i=this.textureBuffer.width,s=this.textureBuffer.height,o=new Uint8Array(4*i*s),t=(t.bindFramebuffer(t.FRAMEBUFFER,this.textureBuffer.frameBuffer),t.readPixels(0,0,i,s,t.RGBA,t.UNSIGNED_BYTE,o),t.bindFramebuffer(t.FRAMEBUFFER,null),e.image);t&&(t.width=i,t.height=s,t.data=o)}),THREE.BoxGeometry=function(e,t,i,s,o,n,N,a){function r(e,t,i,s,o,n,a,r){var h,l,E,d=x.widthSegments,R=x.heightSegments,P=o/2,c=n/2,u=x.vertices.length,O=("x"===e&&"y"===t||"y"===e&&"x"===t?h="z":"x"===e&&"z"===t||"z"===e&&"x"===t?(h="y",R=x.depthSegments):("z"===e&&"y"===t||"y"===e&&"z"===t)&&(h="x",d=x.depthSegments),d+1),L=R+1,S=o/d,T=n/R,D=new THREE.Vector3;for(D[h]=0<a?1:-1,E=0;E<L;E++)for(l=0;l<O;l++){var m=new THREE.Vector3;m[e]=(l*S-P)*i,m[t]=(E*T-c)*s,m[h]=a,x.vertices.push(m)}for(E=0;E<R;E++)for(l=0;l<d;l++){var p,f=l+O*E,g=l+O*(E+1),y=l+1+O*(E+1),I=l+1+O*E,w=new THREE.Vector2(l/d,1-E/R),_=new THREE.Vector2(l/d,1-(E+1)/R),M=new THREE.Vector2((l+1)/d,1-(E+1)/R),A=new THREE.Vector2((l+1)/d,1-E/R),v=0==l&&2==d||1==d&&i*s==-1;(p=(v=N?!v:v)?new THREE.Face3(f+u,g+u,y+u):new THREE.Face3(f+u,g+u,I+u)).normal.copy(D),p.vertexNormals.push(D.clone(),D.clone(),D.clone()),p.materialIndex=r,x.faces.push(p),x.faceVertexUvs[0].push(v?[w,_,M]:[w,_,A]),(p=v?new THREE.Face3(f+u,y+u,I+u):new THREE.Face3(g+u,y+u,I+u)).normal.copy(D),p.vertexNormals.push(D.clone(),D.clone(),D.clone()),p.materialIndex=r,x.faces.push(p),x.faceVertexUvs[0].push(v?[w.clone(),M.clone(),A]:[_.clone(),M,A.clone()])}}THREE.Geometry.call(this),N=N||!1,this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:s,heightSegments:o,depthSegments:n},this.widthSegments=s||1,this.heightSegments=o||1,this.depthSegments=n||1,a=a||0;var x=this,s=e/2,o=t/2,n=i/2;if(r("z","y",-1,-1,i,t,s,0),r("z","y",1,-1,i,t,-s,1),r("x","z",1,1,e,i,o,2),r("x","z",1,-1,e,i,-o,3),r("x","y",1,-1,e,t,n,4),r("x","y",-1,-1,e,t,-n,5),this.mergeVertices(),0!=a)for(var h,l,E=this.vertices.length,d=a/t*.5;E--;)l=(h=this.vertices[E]).y/t,h.x*=1+d*l,h.z*=1+d*l},THREE.BoxGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.BoxGeometry.prototype.constructor=THREE.BoxGeometry,THREE.PlaneBufferGeometry=function(e,t,i,s,o){THREE.BufferGeometry.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:s};for(var n=e/2,a=t/2,r=i||1,h=s||1,l=r+1,E=h+1,d=e/r,R=t/h,P=new Float32Array(l*E*3),c=new Float32Array(l*E*3),u=new Float32Array(l*E*2),O=0,L=0,S=0,T;S<E;S++)for(var D=S*R-a,m=0;m<l;m++){P[O]=m*d-n,P[O+1]=-D,c[O+2]=1,u[L]=m/r,u[L+1]=1-S/h,O+=3,L+=2}for(var O=0,p=new(65535<P.length/3?Uint32Array:Uint16Array)(r*h*6),S=0;S<h;S++)for(var m=0;m<r;m++){var f=m+l*S,g=m+l*(S+1),y=m+1+l*(S+1),I=m+1+l*S,w=0==m&&2==r;(w=o?!w:w)?(p[O]=f,p[O+1]=g,p[O+2]=I,p[O+3]=g):(p[O]=f,p[O+1]=g,p[O+2]=y,p[O+3]=f),p[O+4]=y,p[O+5]=I,O+=6}this.addAttribute("index",new THREE.BufferAttribute(p,1)),this.addAttribute("position",new THREE.BufferAttribute(P,3)),this.addAttribute("normal",new THREE.BufferAttribute(c,3)),this.addAttribute("uv",new THREE.BufferAttribute(u,2))},THREE.PlaneBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype),THREE.PlaneBufferGeometry.prototype.constructor=THREE.PlaneBufferGeometry,THREE.PlaneGeometry=function(e,t,i,s){THREE.Geometry.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:s},this.fromBufferGeometry(new THREE.PlaneBufferGeometry(e,t,i,s))},THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.PlaneGeometry.prototype.constructor=THREE.PlaneGeometry;var THREEx=THREEx||{},$$=(THREEx.WindowResize=function(e,t){var i=function(){e.setSize(window.innerWidth,window.innerHeight),t.aspect=window.innerWidth/window.innerHeight,t.updateProjectionMatrix()};return window.addEventListener("resize",i,!1),{stop:function(){window.removeEventListener("resize",i)}}},window.SPLODER||(window.SPLODER={}),SPLODER.ACTION_DEFAULT=0,SPLODER.ACTION_DESELECT=1,SPLODER.ACTION_SELECT_POINT=2,SPLODER.ACTION_SELECT_ITEM=3,SPLODER.ACTION_SELECT_WINDOW=4,SPLODER.ACTION_SELECT_ALL=5,SPLODER.ACTION_SELECTION_START=6,SPLODER.ACTION_SELECTION_MOVE=7,SPLODER.ACTION_SELECTION_DUPLICATE=8,SPLODER.ACTION_SELECTION_MIRROR_H=9,SPLODER.ACTION_SELECTION_MIRROR_V=10,SPLODER.ACTION_SELECTION_ROTATE=11,SPLODER.ACTION_SELECTION_RELEASE=12,SPLODER.ACTION_SELECTION_DELETE=13,SPLODER.ACTION_CLIPBOARD_COPY=14,SPLODER.ACTION_CLIPBOARD_PASTE=15,SPLODER.ACTION_CREATE=16,SPLODER.ACTION_TWEAK=17,SPLODER.ACTION_CHANGE=18,SPLODER.ACTION_CHANGE_COMPLETE=19,SPLODER.ACTION_SET_CURRENTSTATE=20,SPLODER.ACTION_CLEAR_STATE=21,SPLODER.ACTION_CLEAR_PROPERTY=22,SPLODER.ACTION_UNDO=23,SPLODER.ACTION_REDO=24,SPLODER.ACTION_CONNECT=25,SPLODER.ACTION_DISCONNECT=26,SPLODER.ACTION_CONTEXT_CHANGE=27,SPLODER.ACTION_RETURNED_ERROR=32,SPLODER._documentConnected=!1,SPLODER._holdInterval=0,SPLODER.bind=function(e,t){return function(){t.apply(e,arguments)}},SPLODER.bindWithFuncRef=function(e,t,i){var s=function(){t.call(e,arguments[0],s,i)};return s},SPLODER.bindInteractions=function(e,t,i,s,o){e&&t&&(e.interactive=!0,e.buttonMode=!0,i&&(e.mousedown=e.touchstart=SPLODER.bind(t,i)),s&&(e.mousemove=e.touchmove=SPLODER.bind(t,s)),o)&&(e.mouseup=e.mouseupoutside=e.touchend=e.touchendoutside=SPLODER.bind(t,o))},SPLODER.connectButtons=function(t,e,i,s,o){var n,a,r=(e=e||document).getElementsByTagName("a");if(i){for(a=0;a<r.length;a++)n=r.item(a),SPLODER._connectButton(t,n,i,s,o);if(!SPLODER._documentConnected){if(s)for(a=0;a<document.forms.length;a++)document.forms[a].onchange=function(e){s.call(t,e.target)};var e=function(){clearInterval(SPLODER._holdInterval)};document.addEventListener("mouseup",e),document.addEventListener("touchend",e),SPLODER._documentConnected=!0}}},SPLODER._connectButton=function(i,s,t,e,o){var n,a,r=!1,h,l=function(e){clearInterval(SPLODER._holdInterval),n=Date.now(),r=!0,SPLODER._holdInterval=setInterval(function(){E.call(null,e)},125)},E=function(e){e&&e.target&&500<Date.now()-n&&(t.call(i,e.target.dataset.id,e.target,e.target.dataset.value,e),a=!0)},d=function(e){var t;clearInterval(SPLODER._holdInterval),r&&e.target.parentNode==s&&(r=!1,o)&&(t=e.target,o.call(i,t.dataset.id,t,t.dataset.value,e))};s.onclick||(s.onclick=function(e){!a&&e&&t.call(i,e.target.dataset.id,e.target,e.target.dataset.value,e),a=!1},s.addEventListener("mousedown",l),s.addEventListener("mouseout",d),s.addEventListener("mouseup",d),s.addEventListener("touchstart",l),s.addEventListener("touchend",d))},SPLODER.clearClassListById=function(e){var e=document.getElementById(e);e&&(e.className="")},SPLODER.getClassListById=function(e){return SPLODER.getClassList(document.getElementById(e))},SPLODER.hasClass=function(e,t){var e=SPLODER.getClassListById(e);return e?e.contains(t):void 0},SPLODER.setClass=function(e,t,i){var e=SPLODER.getClassListById(e);e&&(i?e.remove(t):e.add(t))},SPLODER.getClassList=function(e){return e?e.classList:void 0},SPLODER.enableButtons=function(){arguments.length&&SPLODER.setButtonsState(arguments,!0)},SPLODER.disableButtons=function(){arguments.length&&SPLODER.setButtonsState(arguments,!1)},SPLODER.setButtonsState=function(e,t){for(var i=0;i<e.length;i++){var s=document.querySelector('[data-id="'+e[i]+'"]'),o,o;s&&(o=s.classList)&&(t?o.remove("disabled"):o.add("disabled"),o=s.parentNode.parentNode)&&"LABEL"==o.nodeName&&(t?o.classList.remove("disabled"):o.classList.add("disabled"),"INPUT"==o.firstChild.nodeName)&&(o.firstChild.disabled=!t)}},SPLODER.buttonIsEnabled=function(e){var e=document.querySelector('[data-id="'+e+'"]');return!!e&&!e.classList.contains("disabled")},SPLODER.hide=function(e){for(var t=$$$(e),i=t.length;i--;)t[i].classList.add("hidden")},SPLODER.parseFloatArray=function(e){if(e instanceof Array)for(var t=e.length;t--;){var i=e[t],s=parseFloat(i);e[t]=isNaN(s)?i:s}return e},SPLODER.shallowCopyUniforms=function(e,t,i){for(var s in t)e.hasOwnProperty(s)&&(i&&-1!=i.indexOf(s)?t[s]=e[s]:t[s].value=e[s].value)},SPLODER.setAttrib=function(e,t,i,s,o,n){s=s||0,o=o||255,e.setAttrib(t,Math.min(o,Math.max(s,i)),n)},SPLODER.incrementAttrib=function(e,t,i,s,o,n){var a=e.getAttrib(t,n);isNaN(a)&&(a=Math.max(0,s)),isNaN(i)||(isNaN(s)&&(s=-1e4),isNaN(o)&&(o=1e4),e.setAttrib(t,Math.max(s,Math.min(o,a+i)),n))},SPLODER.modAttrib=function(e,t,i,s,o){var n=e.getAttrib(t,o);isNaN(n)&&(n=0),isNaN(s)&&(s=360),isNaN(i)||e.setAttrib(t,(n+i)%s,o)},SPLODER.toggleAttrib=function(e,t,i){var s=e.getAttrib(t,i);e.setAttrib(t,1===parseInt(s)?0:1,i)},SPLODER.weightedValue=function(e){e=e||0;for(var t,i,s,o=0,t=1;t<arguments.length;t+=2)o+=((i=arguments[t])-1)*(s=arguments[t+1]);return o+1+e},SPLODER.lerp=function(e,t,i){return e+(t-e)*(i=Math.max(0,Math.min(1,i)))},SPLODER.easeInQuad=function(e,t,i,s){return i*(e/=s)*e+t},SPLODER.easeOutQuad=function(e,t,i,s){return-i*(e/=s)*(e-2)+t},SPLODER.easeInCubic=function(e,t,i,s){return i*(e/=s)*e*e+t},SPLODER.easeOutCubic=function(e,t,i,s){return e/=s,i*(--e*e*e+1)+t},SPLODER.util={},SPLODER.util.modulo=function(e,t){return(e%t+t)%t},SPLODER.util.zeroPad=function(e,t){for(var i=e+"";i.length<t;)i="0"+i;return i},SPLODER.util.isIE=function(){return-1!==navigator.appVersion.indexOf("MSIE")||-1!==navigator.appVersion.indexOf("Trident")},SPLODER.util.supports_html5_storage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},function(){return document.querySelector.apply(document,arguments)}),$$$=function(){return document.querySelectorAll.apply(document,arguments)},Stats=(SPLODER.AtlasLoader=function(e){THREE.Loader.call(this,e),this.withCredentials=!1},SPLODER.AtlasLoader.prototype=Object.create(THREE.Loader.prototype),SPLODER.AtlasLoader.prototype.constructor=SPLODER.AtlasLoader,SPLODER.AtlasLoader.prototype.load=function(i,s,o,n,a,r){var h=new XMLHttpRequest,l=0;h.onreadystatechange=function(){var e,t;h.readyState===h.DONE?200===h.status||0===h.status?(h.responseText?(t=(e=JSON.parse(h.responseText)).metadata,o&&o(e,t,r)):(THREE.error("SPLODER.AtlasLoader: "+s+" seems to be unreachable or the file is empty."),a&&a(h.status,r)),i.onLoadComplete()):(THREE.error("SPLODER.AtlasLoader: Couldn't load "+s+" ("+h.status+")"),a&&a(h.status)):h.readyState===h.LOADING?n&&(0===l&&(l=h.getResponseHeader("Content-Length")),n({total:l,loaded:h.responseText.length,data:r})):h.readyState===h.HEADERS_RECEIVED&&void 0!==n&&(l=h.getResponseHeader("Content-Length"))},h.open("GET",s,!0),h.withCredentials=this.withCredentials,h.send(null)},SPLODER.Geom={},SPLODER.Geom.pointWithinRect=function(e,t,i,s){return e>=i.x*(s=s||1)&&t>=i.y*s&&e<=(i.x+i.width)*s&&t<=(i.y+i.height)*s},SPLODER.Geom.distanceBetweenXY=function(e,t){var i=e.x-t.x,e=e.y-t.y;return Math.sqrt(i*i+e*e)},SPLODER.Geom.distanceBetweenXZ=function(e,t){return Math.sqrt(SPLODER.Geom.distanceBetweenSquaredXZ(e,t))},SPLODER.Geom.distanceBetween=function(e,t,i,s){return Math.sqrt(SPLODER.Geom.distanceBetweenSquared(e,t,i,s))},SPLODER.Geom.distanceBetweenSquared=function(e,t,i,s){var i=i-e,e=s-t;return i*i+e*e},SPLODER.Geom.distanceBetweenSquaredXZ=function(e,t){var i=e.x-t.x,e=e.z-t.z;return i*i+e*e},SPLODER.Geom.angleBetween=function(e,t,i,s){return Math.atan2(s-t,i-e)},SPLODER.Geom.closestPtPointSegment=function(e,t,i){var i=i.clone().sub(t),e=e.clone().sub(t).dot(i);return e/=i.dot(i),t.clone().add(i.multiplyScalar(e))},SPLODER.Geom.ccw=function(e,t,i,s,o,n){return(s-t)*(o-e)<(n-t)*(i-e)},SPLODER.Geom.lineIntersectsLine=function(e,t,i,s,o,n,a,r){var h=SPLODER.Geom.ccw;return h(e,t,o,n,a,r)!=h(i,s,o,n,a,r)&&h(e,t,i,s,o,n)!=h(e,t,i,s,a,r)},SPLODER.Geom.lineLineIntersect=function(e,t,i,s,o,n,a,r){var i,s,a,r,o,h,i=i-e,s=s-t,a=a-o,r=r-n,l,E,o,h=(a*(t-n)-r*(e-o))/(-a*s+i*r);return 0<=(o=(-s*(e-o)+i*(t-n))/(-a*s+i*r))&&o<=1&&0<=h&&h<=1&&{x:e+h*i,y:t+h*s}},SPLODER.Geom.lineSide=function(e,t,i,s,o,n){return 0<(e-i)*(n-s)-(t-s)*(o-i)?1:-1},SPLODER.Geom.rectIntersectsLine=function(e,t,i,s,o,n){var a=e.x,r=e.y,h=a+e.width,e=r+e.height,l,E,d;return!(t<a&&s<a||i<r&&o<r||h<t&&h<s||e<i&&e<o)&&(l=SPLODER.Geom.lineIntersectsLine,E=SPLODER.Geom.lineSide,d=[],l(t,i,s,o,a,r,h,r)&&(isNaN(n)||E(t,i,a,r,h,r)==n)&&d.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,a,r,h,r)),l(t,i,s,o,h,r,h,e)&&(isNaN(n)||E(t,i,h,r,h,e)==n)&&d.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,h,r,h,e)),l(t,i,s,o,h,e,a,e)&&(isNaN(n)||E(t,i,h,e,a,e)==n)&&d.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,h,e,a,e)),l(t,i,s,o,a,e,a,r)&&(isNaN(n)||E(t,i,a,e,a,r)==n)&&d.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,a,e,a,r)),d)},SPLODER.Geom.gridPointsAlongLine=function(e,t,i,s){for(var o=[],n=Math.abs(i-e),a=e<i?1:-1,r=Math.abs(s-t),h=t<s?1:-1,l=(r<n?n:-r)/2,E=0;o.push(e),o.push(t),e!==i||t!==s;){var d=l;if(-n<d&&(l-=r,e+=a),d<r&&(l+=n,t+=h),512<++E){console.log(o);break}}return o},SPLODER.Geom.resolvePenetrationCircleRect=function(e,t,i,s){var o=e.x,n=e.y,a,r,h,l,E=i.x*(s=s||1),d=i.y*s,R=E+i.width*s,i=d+i.height*s,s=.5*(E+R),P=.5*(d+i),c,P;return!(R<o-t||i<n-t||o+t<E||n+t<d)&&(o<R&&n<i&&E<o&&d<n&&(console.log("INSIDE"),Math.abs(s-o)>Math.abs(P-n)?o=e.x=s<o?R+t:E-t:n=e.y=P<n?i+t:d-t),E<=o&&o<=R?(e.y=n<=P?d-t:i+t,!0):d<=n&&n<=i?(e.x=o<=s?E-t:R+t,!0):((P=o<E&&n<d?(c=SPLODER.Geom.distanceBetween(o,n,E,d),SPLODER.Geom.angleBetween(o,n,E,d)):R<o&&n<d?(c=SPLODER.Geom.distanceBetween(o,n,R,d),SPLODER.Geom.angleBetween(o,n,R,d)):R<o&&i<n?(c=SPLODER.Geom.distanceBetween(o,n,R,i),SPLODER.Geom.angleBetween(o,n,R,i)):(c=SPLODER.Geom.distanceBetween(o,n,E,i),SPLODER.Geom.angleBetween(o,n,E,i)))<0&&(P+=2*Math.PI),c<t&&(e.x+=(c-=t)*Math.cos(P),e.y+=c*Math.sin(P),!0)))},SPLODER.Geom.polygonArea=function(e){for(var t=0,i=0;i<e.length;i+=2)j=(i+2)%e.length,t=(t+=e[i]*e[j+1])-e[j]*e[i+1];return t/2},SPLODER.Geom.polygonIsClockwise=function(e){return 0<SPLODER.Geom.polygonArea(e)},SPLODER.Geom.polygonIsClosed=function(e){return 6<=e.length&&e[0]==e[e.length-2]&&e[1]==e[e.length-1]},SPLODER.Geom.closePolygon=function(e){4<=e.length&&!SPLODER.Geom.polygonIsClosed(e)&&e.push(e[0],e[1])},SPLODER.ShapeUtils={},SPLODER.ShapeUtils.errorOccured=new signals.Signal,SPLODER.ShapeUtils._compare=function(e,t){var i=e.area(),s=t.area();return i<s?1:s<i?-1:e.type>t.type?1:e.type<t.type?-1:0},SPLODER.ShapeUtils.sortByAreaDesc=function(e){e instanceof Array&&e.sort(SPLODER.ShapeUtils._compare)},SPLODER.ShapeUtils.getBounds=function(e){if(e instanceof Array){var t=e.length,i={x:0,y:0,width:0,height:0,size:0,depth:0};if(t){for(var s,o=1e4,n=1e4,a=-1e4,r=-1e4,h=0;t--;)(s=e[t])instanceof SPLODER.Item&&(o=Math.min(o,s.x),n=Math.min(n,s.y),a=Math.max(a,s.x+s.width),r=Math.max(r,s.y+s.height),h+=s.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH));h/=e.length,i.x=o,i.y=n,i.width=a-o,i.height=r-n,i.size=Math.max(0-o,0-n,a,r),i.depth=h}return i}},SPLODER.ShapeUtils.scaleRect=function(e,t){e.x*=t,e.y*=t,e.width*=t,e.height*=t},SPLODER.ShapeUtils.getFilledGrid=function(e,t){for(var i,s,o,n,a,r,h=[],l=e.width+2,E=e.height+2,r=l*E;r--;)s=r%l,o=Math.floor(r/l),h.unshift(0==s||s==l-1||0==o||o==E-1?-1:0);for(r=t.length;r--;)for(i=t[r],o=0;o<i.height;o++)for(s=0;s<i.width;s++)n=i.x-e.x+s+1,a=i.y-e.y+o+1,h[a*l+n]=-1;var d=function(e,t,i,s,o,n){var a;0<(n=n||[])[t*l+e]||e<0||t<0||l-1<e||E-1<t||(n[t*l+e]=1,("g"==i?0<h[t*l+e]:h[t*l+e]==i)&&(h[t*l+e]=s,d(e,t-1,i,s,o,n),d(e+1,t,i,s,o,n),d(e,t+1,i,s,o,n),d(e-1,t,i,s,o,n),o)&&(d(e-1,t-1,i,s,o,n),d(e+1,t-1,i,s,o,n),d(e-1,t+1,i,s,o,n),d(e+1,t+1,i,s,o,n)))};d(0,0,-1,1,!0);for(var R,P=2,c=2;-1!=h.indexOf(0);)s=(R=h.indexOf(0))%l,o=Math.floor(R/l),d(s,o,0,c),c++,P++;for(c=-2;-1!=h.indexOf(-1);)s=(R=h.indexOf(-1))%l,o=Math.floor(R/l),d(s,o,-1,c),c--;var u=h.concat();d(0,0,"g",0),r=h.length;for(var O=!1;r--;)if(0<h[r]){if(O=!0,!(l<16||E<16))break;u[r]=-2}if(h=u,O&&(console.log("PROBABLE TRIANGULATION ERROR"),SPLODER.ShapeUtils.errorOccured.dispatch(e),16<=l)&&16<=E){var L=Math.floor(h.indexOf(-2)/l)*l,S=L+Math.floor(l/2);if(0<=L)for(S+=l,r=L+=l;r<S;r++)2==h[r]&&(h[r]=P)}return{grid:h,w:l}},SPLODER.ShapeUtils.getSegments=function(a,e,t,r){var e,h,l,E=[],d=0,R=0,P=(r=r||0,0),c=2*a.length,h,l,u;return e&&(d=e.x-1,R=e.y-1,r=e.width+2),-1!=(e=a.indexOf(t))&&(h=e%r,l=Math.floor(e/r),(u=function(e,t,i,s,o){if(o=o||1,!(c<=++P))if(void 0===s)u(e+1,t,i,1,1);else if(e==h&&t==l)E.push(d+e,R+t);else{var n=function(e,t){return t*r+e};switch(s){case 0:a[n(e,t-1)]!=i?(E.push(d+e,R+t),u(e+1,t,i,1)):a[n(e-1,t-1)]!=i?u(e,t-1,i,0,o+1):a[n(e-1,t)]!=i&&(E.push(d+e,R+t),u(e-1,t,i,3));break;case 1:a[t*r+e]!=i?(E.push(d+e,R+t),u(e,t+1,i,2)):a[n(e,t-1)]!=i?u(e+1,t,i,1,o+1):a[n(e-1,t-1)]!=i&&(E.push(d+e,R+t),u(e,t-1,i,0));break;case 2:a[n(e-1,t)]!=i?(E.push(d+e,R+t),u(e-1,t,i,3)):a[t*r+e]!=i?u(e,t+1,i,2,o+1):a[n(e,t-1)]!=i&&(E.push(d+e,R+t),u(e+1,t,i,1));break;case 3:return a[n(e-1,t-1)]!=i?(E.push(d+e,R+t),void u(e,t-1,i,0)):a[n(e-1,t)]!=i?void u(e-1,t,i,3,o+1):void(a[t*r+e]!=i&&(E.push(d+e,R+t),u(e,t+1,i,2)))}}})(h,l,t)),E},SPLODER.ShapeUtils.getCoordsFromSegments=function(e,t,i,s,o){if(!e)return e;o=o||0;for(var n,a,r,h,l,E,d=[],R=.001,P=[],a=(e=e.concat()).length,c;0<=a;){for(n=e.length;0<=n;)n!=a&&e[n]==e[a]&&e[n+1]==e[a+1]&&P.unshift(a),n-=2;a-=2}for(n=P.length;n--;)0<(c=P[n])&&c<e.length-1?(r=e[c],h=e[c+1],l=(e[c-2]+r+e[c+2])/3-r,E=(e[c-1]+h+e[c+3])/3-h,l<0?E<0?(e[c+1]-=R,e.splice(c+2,0,r-R,h)):(e[c]-=R,e.splice(c+2,0,r,h+R)):E<0?(e[c]+=R,e.splice(c+2,0,r,h-R)):(e[c+1]+=R,e.splice(c+2,0,r+R,h))):console.log("ERROR: UNHANDLED TRACE CONDITION. END POINT OF POLY IS DUPE!");var u,O=s==SPLODER.Geom.polygonIsClockwise(e);for(n=0;n<e.length;n+=2)r=e[n],h=e[n+1],(u=O?d.unshift:d.push).call(d,r*i,h*i);if(SPLODER.Geom.closePolygon(d),0!=o){for(var L=1e4,S=-1e4,T=1e4,D=-1e4,n=0;n<d.length;n+=2)r=d[n],h=d[n+1],L=Math.min(L,r),S=Math.max(S,r),T=Math.min(T,h),D=Math.max(D,h);for(n=0;n<d.length;n+=2)r=d[n],h=d[n+1],r==L?d[n]-=o:r==S&&(d[n]+=o),h==T?d[n+1]-=o:h==D&&(d[n+1]+=o)}return d},SPLODER.ShapeUtils.buildTree=function(e){for(var t,i,s,o,n,a=(SPLODER.ShapeUtils.sortByAreaDesc(e),[[],[],[]]),t=e.length;t--;)(o=e[t]).removeAllChildren(),o.parentNode=null,o.type<3&&(a[o.type].unshift(o),2==o.type)&&1==o.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR)&&a[0].unshift(o);for(s=0;s<3;s++)for(i=(e=a[s]).length;i--;)if(o=e[i],0<i)for(t=i;t--;)if((n=e[t]).baseX<=o.baseX&&n.baseY<=o.baseY&&n.baseX+n.width>=o.baseX+o.width&&n.baseY+n.height>=o.baseY+o.height){n.addChild(o);break}},SPLODER.ShapeUtils.getDescendants=function(e){var o=function(e){for(var t=[],i=e.children,s=0;s<i.length;s++)t=t.concat(o(i[s]));return t.concat(i)},e=o(e);return SPLODER.ShapeUtils.sortByAreaDesc(e),e},SPLODER.ShapeUtils.getShapes=function(e,t,i,s){for(var o,n,a,r,h,l,E=(s=s||e,SPLODER.ShapeUtils.buildTree(s),[[],[],[]]),o=e.length,d=function(e){if(!e)return!1;if(e.getAttrib(SPLODER.Item.PROPERTY_CEIL))return!0;if(e.children)for(var t=e.children.length;t--;)if(d(e.children[t]))return!0};o--;)r=e[o],(!t||r.getAttrib(SPLODER.Item.PROPERTY_CEIL)||d(r))&&r.type<3&&(t&&r.type!=SPLODER.Item.TYPE_WALL||E[r.type].unshift(r));var R=[],P,c,u,O,L,S,T,D,m;for(perimSegments=[],holeSegments=[],a=0;a<3;a++){n=(e=E[a]).length;for(;n--;){if(S=(h=e[n]).x*i,T=h.y*i,l=h.children,t)for(o=l.length;o--;)if(l[o].getAttrib(SPLODER.Item.PROPERTY_CEIL)||d(l[o])){if(0==a&&l[o].type==SPLODER.Item.TYPE_LIQUID){var p=l[o];l.splice(o,1);for(var f=0;f<p.children.length;f++)d(p.children[f])&&(l=l.concat(p.children[f]))}}else l.splice(o,1);var g=new THREE.Path,y=0,c=null;if(l){for(u=(c=(P=SPLODER.ShapeUtils.getFilledGrid(h,l)).grid).w,O=2;-1!=c.indexOf(O);){if((L=SPLODER.ShapeUtils.getSegments(c,h,O,u)).length&&(D=SPLODER.ShapeUtils.getCoordsFromSegments(L,!0,i)).length)for(perimSegments.push(D),g.moveTo(D[0]-S,D[1]-T),o=2;o<D.length;o+=2)g.lineTo(D[o]-S,D[o+1]-T),y++;O++}for(O=-2;-1!=c.indexOf(O);){if((L=SPLODER.ShapeUtils.getSegments(c,h,O,u)).length&&(D=SPLODER.ShapeUtils.getCoordsFromSegments(L,!1,i,!0,-.001)).length)for(holeSegments.push(D),g.moveTo(D[0]-S,D[1]-T),o=2;o<D.length;o+=2)g.lineTo(D[o]-S,D[o+1]-T),y++;O--}}else for(D=[0,0,h.width*i,0,h.width*i,h.height*i,0,h.height*i,0,0],g.moveTo(D[0],D[1]),o=2;o<D.length;o+=2)g.lineTo(D[o],D[o+1]);(m=g.toShapes(!0,!1)).userData={parentNode:h,grid:c},R.push(m)}}return R},SPLODER.ShapeUtils.getPaddedGrid=function(e,t,i,s){for(var o,n,a=[],r=2*s,h=0;h<i+r;h++)for(var l=0;l<t+r;l++)a[o=h*(i+r)+l]=l<s||h<s||t+s<=l||i+s<=h?0:e[n=(h-s)*i+(l-s)];return a},SPLODER.ShapeUtils.getGeometryFromTexture=function(e,t,i,s){for(var o,n,a,r=t[1],h=t[0],l=t[2],E=t[3],t=(i=i||1,s=s||i,document.createElement("canvas")),d=(t.width=l+2,t.height=E+2,t.getContext("2d")),R=(d.drawImage(e,h,r,l,E,1,1,t.width-2,t.height-2),[]),P,c=d.getImageData(0,0,l+=2,E+=2).data,u=0,O=0,L=1e4,S=1e4,n=0;n<E;n++)for(o=0;o<l;o++).5<c[4*(a=n*l+o)+3]?(R[a]=1,u=Math.min(o,u),L=Math.max(o,L),O=Math.min(n,O),S=Math.max(n,S)):R[a]=0;var T=.5*l*i,D=.5*E*i,e=SPLODER.ShapeUtils.getSegments(R,null,1,l);if(e.length){var m=SPLODER.ShapeUtils.getCoordsFromSegments(e,!0,i,!0,.01);if(m.length){var p=new THREE.Path;p.moveTo(m[0]-T,0-m[1]+D);for(var f=2;f<m.length;f+=2)p.lineTo(m[f]-T,0-m[f+1]+D)}}var h=p.toShapes(!0,!0),r={bevelEnabled:!1,amount:s};try{var g=new THREE.ExtrudeGeometry(h,r);return SPLODER.MeshUtils.applyVoxelMapping(g,l-2,E-2,i,u,O,L-u,S-O),g}catch(e){console.log(e.stack)}},SPLODER.MeshUtils={},SPLODER.MeshUtils.getPlaneGeometry=function(e,t,i,s,o,n,a,r){n=n||1,a=a||1;var e=new THREE.PlaneGeometry(e,t,n,a,r);return i=i||0,s=s||0,o=o||0,e.applyMatrix((new THREE.Matrix4).makeTranslation(i,s,o)),e},SPLODER.MeshUtils.getBoxGeometry=function(e,t,i,s,o,n,a,r,h,l,E){a=a||1,r=r||1,h=h||1;var e=new THREE.BoxGeometry(e,t,i,a,r,h,l,E);return s=s||0,o=o||0,n=n||0,e.applyMatrix((new THREE.Matrix4).makeTranslation(s,o,n)),e},SPLODER.MeshUtils.transformUVs=function(e,t,i,s,o,n,a,r,h,l,E,d,R,P,c,u,O,L,S,T){t=t||0,i=i||0;for(var D,m,p,f,g,y,I,w,_,M,A,v=e.faceVertexUvs,g=v.length;g--;)for(y=(w=v[g]).length;y--;)for(_=w[y],D=s,m=o,p=n,f=a,0<(M=e.faces[y]).normal.y||M.normal.y<0&&T?(D=u,m=O,p=L,f=S):M.normal.y<0?(D=s,m=o+a-1,p=n,f=1):M.normal.x<0?(D=d,m=R,p=P,f=c):0<M.normal.x?(D=d+P,m=R,p=0-P,f=c):M.normal.z<0&&(D=r,m=h,p=l,f=E),D+=.01,m+=.01,0<p?p-=.02:(p+=.02,D-=.02),f-=.02,I=_.length;I--;){var A,N=(A=_[I]).x,x=1-A.y;A.x=t+D+p*N,A.y=i+m+f*x,A.x/=16,A.y/=16,A.y=1-A.y}e.uvsNeedUpdate=!0},SPLODER.MeshUtils.applyVoxelMapping=function(e,t,i,s){e.computeBoundingBox();for(var o,n,a,r,h,l,E,d,R,P=e.faceVertexUvs,o=P.length,c=["a","b","c"];o--;)for(n=(r=P[o]).length;n--;)for(h=r[n],R=(l=e.faces[n]).normal,a=h.length;a--;){var E=e.vertices[l[c[a]]],d=h[a],u=E.x+t*s*.5,E=E.y+i*s*.5;u/=t*s,E/=i*s,R.x<0?u+=.001:0<R.x&&(u-=.001),R.y<0?E+=.001:0<R.y&&(E-=.001),d.x=u,d.y=E}e.uvsNeedUpdate=!0},SPLODER.MeshUtils.offsetUVsRecursive=function(e,t,i){var s,o,n,a,r,h;if(i instanceof THREE.Mesh){for(var l=i.geometry.faceVertexUvs,n=l.length;n--;)for(o=(a=l[n]).length;o--;)for(s=(r=a[o]).length;s--;)(h=r[s]).x*=16,h.y=1-h.y,h.y*=16,h.x+=e,h.y+=t,h.x/=16,h.y/=16,h.y=1-h.y;i.geometry.uvsNeedUpdate=!0}if(i.children)for(s=i.children.length;s--;)SPLODER.MeshUtils.offsetUVsRecursive(e,t,i.children[s])},SPLODER.MeshUtils.destroyMesh=function(e,t){if(e instanceof THREE.Group||e instanceof THREE.Mesh){if(e.children)for(var i,s=e.children.length;s--;)i=e.children[s],e.remove(i),SPLODER.MeshUtils.destroyMesh(i,t);var o;e.userData&&e.userData.biped&&e.userData.biped.destroy(),e instanceof THREE.Mesh&&(e.geometry.dispose(),e.geometry=null,o=e.material,t||(o.defines=o.uniforms=o.defaultAttributeValues=o.vertexShader=o.fragmentShader=null,e.material.dispose()),e.material=null)}},SPLODER.SceneAssets=function(){var r=null,o=16,h=1,l=null,s=null,E={},d=[],R=[],P=[],c=[],u=[],n=0,e=0,a=0,O=0,L=!0,S=this,t=(this.prepared=null,this.forcedUpdateOnly=!0,function(){var e,t,i,s,o=E;for(o.time={type:"f",value:0},o.lightMap={type:"t",value:l.texture},o.lightMapSize={type:"v4",value:l.size},o.cameraAngle={type:"v3",value:new THREE.Vector3},o.pixelRatio={type:"f",value:h},o.lights={type:"fv",value:[]},e=0;e<96;e++)o.lights.value.push(0);for(s=r.types,e=0;e<s.length;e++)if("shader"==r.materials[e]){d[e]=document.getElementById("vertexShader_"+s[e]).innerHTML,R[e]=document.getElementById("fragmentShader_"+s[e]).innerHTML,P[e]=THREE.UniformsUtils.merge([THREE.UniformsLib.fog]),c[e]&&(i=c[e],P[e].textureMap={type:"t",value:i},P[e].textureMapSize={type:"v2",value:new THREE.Vector2(i.image.width,i.image.height)});for(var n,i=r.types[e],a=r.uniformsKeys[i],t=0;t<a.length;t++)if(n=a[t],-1!=r.globalUniformsKeys.indexOf(n))P[e][n]=o[n];else switch(n){case"textureSet":P[e].textureSet={type:"fv1",value:[1,1,1]};break;case"frames":P[e].frames={type:"fv1",value:[0,0,16,16,0,0,16,16,0,0,16,16]};break;case"selected":case"ceiling":case"nofollow":case"noOverlap":case"spherical":P[e][n]={type:"1i",value:0}}u[e]=new THREE.ShaderMaterial({uniforms:P[e],vertexShader:d[e],fragmentShader:R[e],fog:!0,side:r.side[e],vertexColors:r.colors[e],transparent:r.transparent[e]})}else"basic"==r.materials[e]&&(u[e]=new THREE.MeshBasicMaterial({blending:THREE.AdditiveBlending,side:THREE.DoubleSide,color:255,transparent:r.transparent[e],depthWrite:r.depth[e],depthTest:r.depth[e]}))}),T=function(){++e==n&&(t(),S.prepared.dispatch(!0))},D=function(){for(var e,t,i=r.maps,s=0;s<i.length;s++)(e=i[s])&&(n++,(t=c[s]=THREE.ImageUtils.loadTexture(e.src,null,SPLODER.bind(S,T))).wrapS=e.wrapS,t.wrapT=e.wrapT,t.magFilter=e.magFilter,t.minFilter=e.minFilter,e.repeat)&&t.repeat.set(1/o,1/o);l=(new SPLODER.ShaderLightMap).init()},m=function(e,t,i){s[i]=e.frames,++O==a&&D()},i=function(){for(var e,t,i=r.atlases,s=0;s<i.length;s++)(e=i[s])&&(a++,(t=new SPLODER.AtlasLoader).load(t,i[s],SPLODER.bind(this,m),null,null,s))};this.init=function(e,t){return o=e,h=t,s=[],this.prepared=new signals.Signal,this},this.load=function(){var e=document.getElementById("assets_manifest").innerHTML;r=JSON.parse(e),i()},this.setLightMapDirty=function(){L=!0},this.updateLightMap=function(e,t,i){if((!this.forcedUpdateOnly||i)&&L){l.update(e,t);for(var s=0;s<u.length;s++)u[s].needsUpdate=!0;L=!1}},this.assignUniformValue=function(e,t){E[e]&&(E[e].value=t)},this.getNewMaterial=function(e){var t=u[e],i=t.clone();return t instanceof THREE.ShaderMaterial&&SPLODER.shallowCopyUniforms(P[e],i.uniforms,r.globalUniformsKeys),i},this.setAltTexture=function(e,t){P[t]&&(e.uniforms.textureMap=P[t].textureMap,e.uniforms.textureMapSize=P[t].textureMapSize)},this.getSpritesheetTexture=function(e){return c[e]},this.getTextureFrames=function(e,t){return s[e]?s[e][Math.min(t,s[e].length-1)]:void 0},this.getTextureSet=function(e,t){switch(t=void 0===t?e.type:t){case SPLODER.Item.TYPE_WALL:case SPLODER.Item.TYPE_PLATFORM:var i=e.getAttribs(SPLODER.Item.PROPERTY_FLOORTEXTURE,SPLODER.Item.PROPERTY_BOTTOMWALLTEXTURE,SPLODER.Item.PROPERTY_BOTTOMWALLCORNICETEXTURE),s=e.getAttribs(SPLODER.Item.PROPERTY_CEILTEXTURE,SPLODER.Item.PROPERTY_TOPWALLTEXTURE,SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE);return-1==i[2]&&(i[2]=i[1]),-1==s[0]&&(s[0]=i[0]),-1==s[1]&&(s[1]=i[1]),-1==s[2]&&(s[2]=s[1]),[i,s];case SPLODER.Item.TYPE_PANEL:case SPLODER.Item.TYPE_ITEM:var i=e.getAttribs(SPLODER.Item.PROPERTY_TEXTURE1,SPLODER.Item.PROPERTY_TEXTURE2,SPLODER.Item.PROPERTY_TEXTURE3);return-1==i[1]&&(i[1]=i[0]),-1==i[2]&&(i[2]=i[0]),i;case SPLODER.Item.TYPE_BIPED:return[e.getAttribs(SPLODER.Item.PROPERTY_TEXTURE1)]}},this.getTotalTextures=function(e){return s[e]?s[e].length:0},this.setTime=function(e){E.time.value=e}},SPLODER.SceneAssets.TYPE_WALLS=0,SPLODER.SceneAssets.TYPE_LIQUIDS=1,SPLODER.SceneAssets.TYPE_PANELS=2,SPLODER.SceneAssets.TYPE_SKIES=3,SPLODER.SceneAssets.TYPE_ITEMS=4,SPLODER.SceneAssets.TYPE_BIPEDS=5,SPLODER.SceneAssets.TYPE_LIQUIDMASK=6,SPLODER.SceneAssets.itemTypeMap=[0,0,1,2,4,5],SPLODER.Treenode=function(){this.defaults=null;var t=this,i=null,s=[];this.addChild=function(e){var t;-1==s.indexOf(e)&&(s.push(e),e.parentNode=this)},this.removeChild=function(e){var e=s.indexOf(e);-1!=e&&s.splice(e,1)},this.removeAllChildren=function(){for(var e,t=s.length;t--;)(e=s[t]).parentNode==this&&(e.parentNode=null);s=[]},Object.defineProperty(this,"numChildren",{get:function(){return s.length}}),Object.defineProperty(this,"children",{get:function(){return s.concat()}}),Object.defineProperty(this,"parentNode",{get:function(){return i},set:function(e){i&&i.removeChild(t),(i=e)&&i.addChild(this)}}),Object.defineProperty(this,"root",{get:function(){return i?i.root:t}})},SPLODER.Treenode.applyAttribs=function(e,t){if(t instanceof Array)for(var i=0;i<t.length;i++)e.setAttrib(i,t[i])},SPLODER.States=function(){var o;this.init=function(){return o=[[]],this},this.initWithValues=function(e){if(this.init(),e instanceof Array)for(var t=e.length;t--;)this.setValue(t,e[t],0)},this.clearState=function(e){o[e]=[]},this.hasState=function(e){return isNaN(e)&&(e=0),o[e]instanceof Array&&o[e].length},this.hasFrame=function(e,t){return 0<=e&&0<=t&&o[t]instanceof Array&&null!=o[t][e]},this.hasFrames=function(e){if(0<=e)for(var t=1;t<o.length;t++)if(o[t]instanceof Array&&null!=o[t][e])return!0;return!1},this.offsetFrames=function(e,t){if(0<=e)for(var i=1;i<o.length;i++)o[i]instanceof Array&&!isNaN(o[i][e])&&(o[i][e]+=t)},this.hasValue=function(e,t){return isNaN(t)&&(t=0),o[t]instanceof Array&&null!=o[t][e]&&null!=o[t][e]},this.getValue=function(e,t){return isNaN(t)&&(t=0),o[t]instanceof Array?o[t][e]:null},this.setValue=function(e,t,i){isNaN(i)&&(i=0),o[i]||(o[i]=[]),o[i][e]=t},this.serialize=function(){return JSON.stringify(o)},this.unserialize=function(t){var e,i;try{(e=JSON.parse(t))instanceof Array?o=e:this.init()}catch(e){if(console.log("JSON ERROR:",e),console.log(t),(t="string"==typeof t?t.split(","):t)instanceof Array)for(var s=0;s<t.length;s++)(i=t[s])&&("number"==typeof i?this.setValue(s,i):-1!=i.indexOf(".")?this.setValue(s,parseFloat(i)):isNaN(i)?this.setValue(s,i):this.setValue(s,parseInt(i)))}}},SPLODER.Rect=function(e,t,i,s,o){this.id=null,this.type=e||0,this.x=t||0,this.y=i||0,this.width=s||0,this.height=o||0;var n=this;Object.defineProperty(this,"area",{value:function(){return 4<=n.type?0:n.width*n.height},writable:!1}),this.clone=function(){var e=new SPLODER.Rect(this.type,this.x,this.y,this.width,this.height);return e.id=this.id,e}},SPLODER.Rect.prototype.serialize=function(){return[this.id,this.type,this.x,this.y,this.width,this.height].join(",")},SPLODER.Rect.prototype.unserialize=function(e,t,i){if(e){var s=["id","type","x","y","width","height"];i&&(s=s.concat(i));for(var o=e.split(","),n=0;n<o.length;n++)!s[n]||0==n&&t||(this[s[n]]=parseInt(o[n]))}},SPLODER.Item=function(e,t,i,s,o,n){SPLODER.Treenode.call(this),SPLODER.Rect.call(this,e,t,i,s,o);var a=t||0,r=i||0,h=(this.defaults=SPLODER.Item.defaultsByType[this.type],this.states=new SPLODER.States,0),l=this;Object.defineProperty(this,"x",{get:function(){var e=l.type;return e!=SPLODER.Item.TYPE_PLATFORM&&e!=SPLODER.Item.TYPE_ITEM&&e!=SPLODER.Item.TYPE_BIPED?a:a+l.getAttrib(SPLODER.Item.PROPERTY_OFFSET_X)},set:function(e){var t;isNaN(e)||((t=l.type)!=SPLODER.Item.TYPE_PLATFORM&&t!=SPLODER.Item.TYPE_ITEM&&t!=SPLODER.Item.TYPE_BIPED||0==l.currentState?a=e:l.setAttrib(SPLODER.Item.PROPERTY_OFFSET_X,e-a))}}),Object.defineProperty(this,"y",{get:function(){var e=l.type;return e!=SPLODER.Item.TYPE_PLATFORM&&e!=SPLODER.Item.TYPE_ITEM&&e!=SPLODER.Item.TYPE_BIPED?r:r+l.getAttrib(SPLODER.Item.PROPERTY_OFFSET_Y)},set:function(e){var t;isNaN(e)||((t=l.type)!=SPLODER.Item.TYPE_PLATFORM&&t!=SPLODER.Item.TYPE_ITEM&&t!=SPLODER.Item.TYPE_BIPED||0==l.currentState?r=e:l.setAttrib(SPLODER.Item.PROPERTY_OFFSET_Y,e-r))}}),Object.defineProperty(this,"baseX",{get:function(){return a}}),Object.defineProperty(this,"baseY",{get:function(){return r}}),Object.defineProperty(this,"currentState",{get:function(){return l.type!=SPLODER.Item.TYPE_PLATFORM||l.root==l?h:l.root?l.root.currentState:0},set:function(e){isNaN(e)||(l.type!=SPLODER.Item.TYPE_PLATFORM||l.root==l?h=e:l.root?l.root.currentState=e:h=0)}}),this.getAttrib=function(e,t){return isNaN(t)&&(t=this.currentState),this.type!=SPLODER.Item.TYPE_PLATFORM||this.root==this||e!=SPLODER.Item.PROPERTY_OFFSET_X&&e!=SPLODER.Item.PROPERTY_OFFSET_Y?this.states.hasValue(e,t)?this.states.getValue(e,t):this.states.hasValue(e,0)?this.states.getValue(e,0):this.parentNode?this.parentNode.getAttrib(e):this.defaults&&this.defaults.hasOwnProperty(e)?this.defaults[e]:-1:this.root.getAttrib(e)},this.hasOwnAttrib=function(e,t){return isNaN(t)&&(t=this.currentState),this.states.hasValue(e,t)||this.states.hasValue(e,0)},this.setAttrib=function(e,t,i){isNaN(i)&&(i=this.currentState),this.states.setValue(e,t=null!==t&&t==t?t:void 0,i)},this.clearAttrib=function(e,t){isNaN(t)&&(t=this.currentState),this.states.setValue(e,void 0,t)},this.getAttribs=function(){if(arguments&&0<arguments.length){for(var e=[],t=0;t<arguments.length;t++)e.push(l.getAttrib(arguments[t]));return e}},n?this.states.initWithValues(n):this.states.init(),this.clone=function(){var e=new SPLODER.Item(this.type,this.baseX,this.baseY,this.width,this.height);return e.id=this.id,e.states.unserialize(this.states.serialize()),e},this.serialize=function(){return[this.id,this.type,this.baseX,this.baseY,this.width,this.height].join(",")+","+this.states.serialize()},this.unserialize=function(e,t){var i,t;e&&(SPLODER.Rect.prototype.unserialize.call(this,e,t),t=e.split(",").slice(6).join(","),this.states.unserialize(t),this.defaults=SPLODER.Item.defaultsByType[this.type])}},SPLODER.Item.prototype=Object.create(SPLODER.Rect.prototype),SPLODER.Item.prototype.constructor=SPLODER.Item,SPLODER.Item.PROPERTY_TYPE=0,SPLODER.Item.TYPE_WALL=0,SPLODER.Item.TYPE_PLATFORM=1,SPLODER.Item.TYPE_LIQUID=2,SPLODER.Item.TYPE_PANEL=3,SPLODER.Item.TYPE_ITEM=4,SPLODER.Item.TYPE_BIPED=5,SPLODER.Item.TYPE_LIGHT=6,SPLODER.Item.TYPE_FILTER_WALL_LIQUID=7,SPLODER.Item.typeStrings=["wall","platform","liquid","panel","item","biped","light"],SPLODER.Item.PROPERTY_ROTATION=0,SPLODER.Item.PROPERTY_FLOORDEPTH=1,SPLODER.Item.PROPERTY_CEILDEPTH=2,SPLODER.Item.PROPERTY_OFFSET_X=3,SPLODER.Item.PROPERTY_OFFSET_Y=4,SPLODER.Item.PROPERTY_TEXTURE1=5,SPLODER.Item.PROPERTY_TEXTURE2=6,SPLODER.Item.PROPERTY_TEXTURE3=7,SPLODER.Item.PROPERTY_FLOORTEXTURE=5,SPLODER.Item.PROPERTY_BOTTOMWALLTEXTURE=6,SPLODER.Item.PROPERTY_BOTTOMWALLCORNICETEXTURE=7,SPLODER.Item.PROPERTY_CEILTEXTURE=8,SPLODER.Item.PROPERTY_TOPWALLTEXTURE=9,SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE=10,SPLODER.Item.PROPERTY_LIGHTLEVEL=11,SPLODER.Item.PROPERTY_LIGHTEFFECT=12,SPLODER.Item.PROPERTY_LIQUIDLEVEL=13,SPLODER.Item.PROPERTY_LIQUIDTYPE=14,SPLODER.Item.PROPERTY_LIQUID_HASFLOOR=17,SPLODER.Item.PROPERTY_POWER=11,SPLODER.Item.PROPERTY_COLOR=12,SPLODER.Item.PROPERTY_CEIL=15,SPLODER.Item.PROPERTY_CEIL_SKY=16,SPLODER.Item.PROPERTY_HEALTH=18,SPLODER.Item.PROPERTY_STRENGTH=19,SPLODER.Item.PROPERTY_RANGE=20,SPLODER.Item.PROPERTY_ARMOR=21,SPLODER.Item.PROPERTY_SPEED=22,SPLODER.Item.PROPERTY_SCORE=23,SPLODER.Item.PROPERTY_SOLID=24,SPLODER.Item.PROPERTY_GRAVITY=25,SPLODER.Item.PROPERTY_AUTOCREATE=26,SPLODER.Item.PROPERTY_LIBRARY=27,SPLODER.Item.PROPERTY_TOPLEFT=30,SPLODER.Item.PROPERTY_TOPRIGHT=31,SPLODER.Item.PROPERTY_BOTTOMRIGHT=32,SPLODER.Item.PROPERTY_BOTTOMLEFT=33,SPLODER.Item.defaults=[],SPLODER.Item.defaultsByType=[],(e=>{e.defaults[e.PROPERTY_ROTATION]=0,e.defaults[e.PROPERTY_FLOORDEPTH]=64,e.defaults[e.PROPERTY_CEILDEPTH]=80,e.defaults[e.PROPERTY_OFFSET_X]=0,e.defaults[e.PROPERTY_OFFSET_Y]=0,e.defaults[e.PROPERTY_LIGHTLEVEL]=160,e.defaults[e.PROPERTY_LIGHTEFFECT]=0,e.defaults[e.PROPERTY_FLOORTEXTURE]=7,e.defaults[e.PROPERTY_BOTTOMWALLTEXTURE]=7,e.defaults[e.PROPERTY_BOTTOMWALLCORNICETEXTURE]=-1,e.defaults[e.PROPERTY_CEILTEXTURE]=-1,e.defaults[e.PROPERTY_TOPWALLTEXTURE]=-1,e.defaults[e.PROPERTY_TOPWALLCORNICETEXTURE]=-1,e.defaults[e.PROPERTY_CEIL]=1,e.defaults[e.PROPERTY_CEIL_SKY]=0,e.defaults[e.PROPERTY_LIQUIDLEVEL]=62,e.defaults[e.PROPERTY_LIQUIDTYPE]=0,e.defaults[e.PROPERTY_LIQUID_HASFLOOR]=1,e.defaults[SPLODER.Item.PROPERTY_HEALTH]=100,e.defaults[SPLODER.Item.PROPERTY_STRENGTH]=20,e.defaults[SPLODER.Item.PROPERTY_RANGE]=20,e.defaults[SPLODER.Item.PROPERTY_ARMOR]=0,e.defaults[SPLODER.Item.PROPERTY_SPEED]=10,e.defaults[SPLODER.Item.PROPERTY_SCORE]=10,e.defaults[SPLODER.Item.PROPERTY_SOLID]=1,e.defaults[SPLODER.Item.PROPERTY_GRAVITY]=1,e.defaults[SPLODER.Item.PROPERTY_AUTOCREATE]=1,e.defaults[SPLODER.Item.PROPERTY_LIBRARY]=0;for(var t=e.TYPE_WALL;t<=e.TYPE_LIGHT;t++)e.defaultsByType[t]=e.defaults.concat();e.defaultsByType[e.TYPE_PLATFORM][e.PROPERTY_FLOORDEPTH]=66,e.defaultsByType[e.TYPE_PLATFORM][e.PROPERTY_CEILDEPTH]=2,e.defaultsByType[e.TYPE_LIQUID][e.PROPERTY_FLOORDEPTH]=56,e.defaultsByType[e.TYPE_LIQUID][e.PROPERTY_CEIL]=0,e.defaultsByType[e.TYPE_LIQUID][e.PROPERTY_FLOORTEXTURE]=1,e.defaultsByType[e.TYPE_PANEL][e.PROPERTY_TEXTURE1]=70,e.defaultsByType[e.TYPE_PANEL][e.PROPERTY_TEXTURE2]=-1,e.defaultsByType[e.TYPE_PANEL][e.PROPERTY_TEXTURE3]=-1,e.defaultsByType[e.TYPE_ITEM][e.PROPERTY_TEXTURE1]=34,e.defaultsByType[e.TYPE_ITEM][e.PROPERTY_TEXTURE2]=-1,e.defaultsByType[e.TYPE_ITEM][e.PROPERTY_TEXTURE3]=-1,e.defaultsByType[e.TYPE_LIGHT][e.PROPERTY_COLOR]=0,e.defaultsByType[e.TYPE_LIGHT][e.PROPERTY_POWER]=20})(SPLODER.Item),SPLODER.BipedPoses=function(){var L,S,T,D,m,p,f,g,y,I,w,_,M,A,v,N,x,Y,C,b,V,u,U={},t={},F=this,O=(this.initWithElements=function(t,e,i,s,o,n,a,r,h,l,E,d,R,P){L=t,S=e,T=i,D=s,p=(m=o).children[0],f=n,y=r,I=(g=a).children[0],w=y.children[0],M=l,A=(_=h).children[0],v=M.children[0],N=E,x=d,Y=R,C=P,O(),b="",V=0;var c=t.currentState;return u=setInterval(function(){var e;c!=t.currentState&&(c=t.currentState)<(e=["idle","walk","attack","defend","ouch","die","push","dance","shrug","facepalm","sit","watch"]).length&&F.pose(e[c]),F.update()},10),this},function(e){U[(e=e||S).uuid]=e.rotation.clone(),t[e.uuid]=e.position.clone(),e.children.forEach(O)}),G=function(e){(e=e||S).rotation.copy(U[e.uuid]),e.position.copy(t[e.uuid]),e.children.forEach(G)};this.pose=function(e){e!=b&&(b=e,V=Date.now())},this.update=function(e){G();var s,t,i,o,n,a,r,h,l,E=Date.now()-V,d=L.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/255,R=L.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128,P=2-R,c=L.getAttrib(SPLODER.Biped.PROPERTY_HEIGHT)/800+.3,u=L.getAttrib(SPLODER.Biped.PROPERTY_WEIGHT)/400+.5,O;switch(b){case"run":s=E/50,t=Math.sin(s),i=Math.cos(s);case"walk":s||(s=E/150,t=Math.sin(s),i=Math.cos(s)),T.rotation.x+=-.2,T.rotation.z+=.05*t*R,D.rotation.x+=.1+.1*t,D.rotation.z+=0-.05*t*R,y.position.y-=Math.min(0,8*i),g.position.y+=Math.max(0,8*i),y.rotation.x+=.2+.35*t*u,g.rotation.x+=.2-.35*t*u,w.rotation.x+=.5-y.rotation.x-U[w.uuid].x,I.rotation.x+=.5-g.rotation.x-U[I.uuid].x,N.rotation.x+=-.2-.1*t,x.rotation.x+=-.2-.1*t,r=a=1,Y&&(a*=.5),C&&(r*=.25),_.rotation.x+=.35*t*r-.2,_.rotation.z+=Math.abs(.15*i)*R,M.rotation.x+=-.2-.35*t*a,M.rotation.z+=0-Math.abs(.15*i)*R,A.rotation.x+=y.rotation.x*r-.75,v.rotation.x+=g.rotation.x*a-.75,Y&&(v.rotation.y-=.35),C&&(A.rotation.z-=.75,A.rotation.y+=.35-.3*t),p.rotation.y+=0-.25*Math.sin(.25*s),p.rotation.x-=.1+.1*t,p.rotation.z+=.05*t*R*2,f.emote(":)");break;case"idle":s=E/500,t=Math.sin(s),i=Math.cos(s),T.rotation.z+=.03*t*R,D.rotation.z+=0-.03*t*R,p.rotation.z-=0-.03*t*R,g.rotation.z-=.03*t*R,y.rotation.z-=.03*t*R,_.rotation.z+=.03*t*R,M.rotation.z+=.03*t*R,A.rotation.x-=.2,v.rotation.x-=.2,T.rotation.x+=.03*t*P-t*d*.05,D.rotation.x+=0-.03*t*P+t*d*.1,p.rotation.x-=0-.03*t*P+t*d*.1,g.rotation.x-=(.03*t-.03)*P+t*d*.05,y.rotation.x-=(.03*t-.03)*P+t*d*.05,g.rotation.z+=t*d*.05,y.rotation.z-=t*d*.05,I.rotation.x-=.03*t*P-t*d*.2,w.rotation.x-=.03*t*P-t*d*.2,S.position.y-=t*d*2,_.rotation.x+=.03*t*P,M.rotation.x+=.03*t*P,A.rotation.x-=.2*P,v.rotation.x-=.2*P,C&&(_.rotation.x-=.5+.2*t,A.rotation.z-=.95,A.rotation.y=.25+.05*t),f.emote(":|");break;case"attack":n=1,400<E&&(n-=.01*(E-400)),s=(250+E)/150,s-=Math.sin(s),t=Math.sin(s),i=Math.cos(s),D.rotation.y-=.8*t*n,D.rotation.z+=.2*t*n,S.rotation.y+=.2*(-1.57+i)*n,m.rotation.y-=.2*(-1.57+i)*n,Y?(M.rotation.z+=1.25*i*n,M.rotation.x-=(1.57-1.57*i)*n,v.rotation.x+=.65*i*n):(M.rotation.z+=.5*i,M.rotation.y-=t,M.rotation.x+=+t,v.rotation.x-=+t+.95),C?(_.rotation.x-=.5+.2*t,_.rotation.y+=.8*t*n,A.rotation.z-=.95,A.rotation.x-=.25,A.rotation.y+=.35):_.rotation.x-=+t,f.emote(">:("),500<E&&F.pose("idle");break;case"defend":n=1,900<E&&(n-=.01*(E-900)),h=2-d,s=Math.min(250,E)/150,t=Math.sin(s),i=Math.cos(s),D.rotation.y-=.4*t*n*h,D.rotation.x-=.2*t*n*h,m.rotation.x-=.75*t*n,p.rotation.x+=.75*t*n,p.position.z-=8*t*n,p.position.y-=8*t*n,M.position.z+=8*t*n*h,M.rotation.x-=.75*t*n*h,M.rotation.y+=.75*t*n*h,M.rotation.z+=.5*t*n*h,v.rotation.x-=.75*t*n,v.rotation.y-=.5*t*n,_.rotation.x-=+t*n*h,_.rotation.y-=1.5*t*n*h,A.rotation.x-=.75*t*n,A.rotation.y+=2.5*t*n,y.rotation.x+=.25*t*n,w.rotation.x-=.25*t*n,g.rotation.x-=.15*t*n,I.rotation.x+=.15*t*n,Y&&(M.rotation.y+=d),C&&(_.rotation.y-=d),f.emote("=O"),1e3<E&&F.pose("idle");break;case"watch":var s=E/100,t=Math.sin(s),i=Math.cos(s),l=S.parent.rotation.y;l<2*Math.PI&&(l+=2*Math.PI),p.rotation.x-=0-.03*t,p.rotation.y=0-l-.5*Math.PI-SPLODER.Geom.angleBetween(editor.previewArea.camera.position.x,editor.previewArea.camera.position.z,S.parent.position.x,S.parent.position.z),p.rotation.y<0-Math.PI&&(p.rotation.y+=2*Math.PI),p.rotation.y=Math.max(-1,Math.min(1,p.rotation.y));break;case"ouch":n=1,300<E&&(n-=.01*(E-300)),s=E/100,t=Math.sin(s),i=Math.cos(s),D.rotation.x-=.4*t*n,S.rotation.x-=.4*t*n*d,S.rotation.z+=.4*t*n,S.position.y+=32*t*n,m.rotation.x+=.75*t*n,p.rotation.x-=.5*t*n,p.position.z-=16*t*n,p.position.y-=8*t*n,y.rotation.z-=+t*n,g.rotation.z+=+t*n,r=a=n,M.rotation.z-=2*t*a,_.rotation.z+=2*t*r,M.position.x+=8*t*n,_.position.x-=8*t*n,f.emote("o_o"),400<E&&(f.emote(":|"),F.pose("idle"));break;case"sit":s=1.5,t=Math.sin(s),i=Math.cos(s),h=1.5-.4*d,l=2-d,S.position.y-=56,T.rotation.x-=.3*t*h,D.rotation.x+=.1*t*l,y.rotation.x-=.8*t*h,g.rotation.x-=.8*t*h,w.rotation.x+=.5*t*h,I.rotation.x+=.5*t*h;break;case"die":s=SPLODER.easeInCubic(E,0,1,1e3),t=Math.sin(Math.min(125,E)/125),S.rotation.z=.5*t,S.rotation.y+=SPLODER.easeOutCubic(Math.min(500,E),0,6.28318,500),S.rotation.x=SPLODER.lerp(S.rotation.x,0-.5*Math.PI,2*s),S.position.y-=SPLODER.lerp(0,160*c,2*s),T.position.z*=1-Math.min(1,s),D.position.z*=1-Math.min(1,s),y.rotation.x=SPLODER.lerp(y.rotation.x,0-.5*Math.PI,2*s),g.rotation.x=SPLODER.lerp(g.rotation.x,0-.5*Math.PI,2*s),y.rotation.z=0-.5*t,g.rotation.z=t,M.rotation.z=0-t,M.rotation.x=SPLODER.lerp(M.rotation.x,0-.5*Math.PI,2*s),_.rotation.z=t,_.rotation.x=SPLODER.lerp(_.rotation.x,0-.5*Math.PI,2*s),f.emote("(O"),1e3<E&&(s=SPLODER.easeInCubic(Math.min(500,E-1e3),0,1,500),(O=function(e,t){if(!(3<(t=t||0))){0<t&&(e.rotation.x*=1-s,e.rotation.y*=1-s,t<=2)&&(e.position.z-=6*s);for(var i=e.children.length;i--;)O(e.children[i],t+1)}})(S));break;case"push":s=SPLODER.easeInQuad(E,0,1,125),t=Math.sin(Math.min(200,E)/70),y.rotation.x=0-t,g.rotation.x=.5-1.5*t,w.rotation.x=t,I.rotation.x=t,T.rotation.x=0-.25*t,D.rotation.x=.25*t,S.position.y-=16*t,S.rotation.x+=.1*Math.min(1,s),M.rotation.x=SPLODER.lerp(M.rotation.x,0-.55*Math.PI,s),M.rotation.z=SPLODER.lerp(M.rotation.z,.125*Math.PI,s),v.rotation.x=-2+Math.min(2,s),_.rotation.x=SPLODER.lerp(_.rotation.x,0-.55*Math.PI,s),_.rotation.z=SPLODER.lerp(_.rotation.z,0-.125*Math.PI,s),A.rotation.x=-2+Math.min(2,s),f.emote(">:("),750<E&&(f.emote(":|"),F.pose("idle"));break;case"dance":s=E/250,t=Math.sin(s),o=Math.sin(2*s),i=Math.cos(s),T.rotation.z=.2*t,D.rotation.z=.2*i,m.rotation.z=0-.2*i,m.rotation.x=0-.2*o,p.rotation.x=.2*o-.5*d,p.position.z-=4*o,g.rotation.z=0-.2*t,y.rotation.z=0-.2*t,_.rotation.y=-.5,M.rotation.y=.5,_.position.y+=4-8*t,M.position.y+=4+8*t,A.rotation.x=-1.57,v.rotation.x=-1.57,Y&&(v.rotation.y-=.5,M.rotation.y-=d),C&&(A.rotation.y+=.5,_.rotation.y+=d),f.emote("=D");break;case"shrug":s=E/250,t=Math.sin(s),i=Math.cos(s),p.position.y-=4*t,_.rotation.y=.5*t,M.rotation.y=0-.5*t,_.position.y+=8*t,M.position.y+=8*t,A.rotation.x+=0-t,v.rotation.x+=0-t,f.emote("//-_-"),750<E&&(f.emote(":|"),F.pose("idle"));break;case"facepalm":E<2e3?(s=SPLODER.easeOutQuad(Math.min(E,1e3),0,1e3,750),f.emote("//-_-")):(s=500-SPLODER.easeOutQuad(Math.min(E,2500)-2e3,0,500,500),f.emote(":|")),s=Math.min(2,s/400),t=Math.sin(s),o=E<2e3?Math.sin(E/150):0,i=Math.cos(s),p.rotation.x+=.5*t,p.rotation.y+=.25*o,D.rotation.x+=.25*t,_.rotation.x=0-1.57*t,M.rotation.x=0-1.57*t,_.rotation.y=.85*i-.5,M.rotation.y=.5-.85*i,A.rotation.x+=0-t,v.rotation.x+=0-t,Y&&(v.rotation.x+=.5*t,v.rotation.y-=2*t),C&&(A.rotation.x+=.5*t,A.rotation.y+=2*t),3e3<E&&(f.emote(":|"),F.pose("idle"))}},this.destroy=function(){clearInterval(u),u=null}},SPLODER.BipedFace=function(){var r,h,o,n,a,l,E,d,R,P,c,u,u,O,L,S,T,D,m,p,f,g=this,y=(this.initWithRectAndMaterial=function(e,t,i,s){return r=e,h=t,o=i||0,n=s||0,(a=new THREE.Group).userData.face=this},function(e,t,i,s,o,n,a){var e=SPLODER.MeshUtils.getPlaneGeometry(e,t,i,s,o,n,a),t=new THREE.Mesh(e,h);return t.userData.rect=r,t}),I=(this.build=function(){var e,t=r.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/128,i=(e=(l=y(12,12)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,44,19,4,4),a.add(l),e=(E=y(12,12)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,32,19,4,4),a.add(E),e=(d=y(6,6)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,44,23,4,4),l.add(d),e=(R=y(6,6)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,32,23,4,4),E.add(R),e=(P=y(14,14,0,-7)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,40,29,3,2.5),l.add(P),e=(c=y(14,14,0,-7)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,40,29,3,2.5),E.add(c),e=(u=y(14,2,0,-1,0)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,43,30,5,2),u.rotation.x=100*Math.PI/180,u.position.y=-14,u.position.z=2,P.add(u),(u=u.clone()).rotation.y=Math.PI,P.add(u),e=(u=y(14,2,0,-1,0)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,43,30,5,2),u.rotation.x=100*Math.PI/180,u.position.y=-14,u.position.z=2,c.add(u),(u=u.clone()).rotation.y=Math.PI,c.add(u),e=(O=y(14+SPLODER.weightedValue(0,t,2),4+SPLODER.weightedValue(0,t,2))).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,44,27,4,2),l.add(O),e=(L=y(14+SPLODER.weightedValue(0,t,2),4+SPLODER.weightedValue(0,t,2))).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,40,27,4,2),E.add(L),(S=new THREE.Group).position.y=-16,a.add(S),e=(D=y(16,2,0,0,0,8,1)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,32,27,8,1),D.position.z=.1,S.add(D),e=(m=y(16,2,0,-1,0,8,1)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,32,27.5,8,3),S.add(m),e=(T=y(8,4,0,-2,0)).geometry,SPLODER.MeshUtils.transformUVs(e,o,n,32,31,8,1),S.add(T),T.visible=!1,I(),[":|",":)",";)",":]",":P","(O",":(","-_-",">:(","^-^",">:)",":'(","o_O",":/","=O",":D","XD",":)"]),s=i[0];p=setInterval(function(){s=i[Math.floor(Math.random()*i.length)]},750),f=setInterval(function(){g.emote(s)},10)},function(){var e=r.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128,t=r.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/128,i=r.getAttrib(SPLODER.Biped.PROPERTY_STRENGTH)/128,e=(l.position.x=8+SPLODER.weightedValue(0,e,.5),l.position.y=0,l.position.y-=2*SPLODER.weightedValue(-.5,t,1),l.rotation.z=.1*SPLODER.weightedValue(-.5,t,1),l.scale.set(1,1,1),l.scale.multiplyScalar(SPLODER.weightedValue(0,e,.125)),E.position.x=-8-SPLODER.weightedValue(0,e,.5),E.position.y=0,E.position.y-=2*SPLODER.weightedValue(-.5,t,1),E.rotation.z=-.1*SPLODER.weightedValue(-.5,t,1),E.scale.set(1,1,1),E.scale.multiplyScalar(SPLODER.weightedValue(0,e,.125)),d.position.set(0,-2,.1),R.position.set(0,-2,.1),P.position.set(0,7,.2),P.scale.y=.25,c.position.set(0,7,.2),c.scale.y=.25,O.position.y=8-2*SPLODER.weightedValue(-2,t,1),O.position.z=.3,O.scale.set(1,1,1),O.rotation.z=0,L.position.y=8-2*SPLODER.weightedValue(-2,t,1),L.position.z=.3,L.scale.set(1,1,1),L.rotation.z=0,S.position.y=-16+Math.max(0,SPLODER.weightedValue(0,i,-2)),S.scale.y=1,S.scale.x=SPLODER.weightedValue(.25,t,.5),D.position.y=2,m.position.y=2,function(e,t){e.y=8<t?-2:0});D.geometry.vertices.map(e,null,0),D.geometry.verticesNeedUpdate=!0,m.geometry.vertices.map(e,null,6),m.geometry.verticesNeedUpdate=!0,T.position.y=1,T.position.z=.1,T.rotation.x=.25*-Math.PI,T.visible=!1});this.emote=function(e){var t,i,s=1.5,o=!0;switch(I(),e){case":)":case"=)":t=function(e,t){e.y=Math.sin(.2*e.x-1.57)*s,8<t&&(e.y-=o?2:i+2)},L.rotation.z=.1,O.rotation.z=0-L.rotation.z;break;case"^-^":case"^_^":case"^^":O.position.y+=2,L.position.y+=2,d.position.y+=2,R.position.y+=2,P.scale.y=c.scale.y=.4,S.position.y+=2,S.scale.x=2;break;case":]":case"O:)":t=function(e,t){e.y=2<Math.abs(e.x)?2*Math.sin(.2*e.x-1.57)+1.5:0,8<t&&(e.y-=o?2:i+2)},L.rotation.z=.1,O.rotation.z=0-L.rotation.z,--O.position.y,--L.position.y,d.position.y=1,R.position.y=1,P.scale.y=c.scale.y=.4,S.scale.x=2;break;case":(":t=function(e,t){s=2,e.y=Math.sin(.2*e.x+1.57)*s,8<t&&(e.y-=o?2:i+2)},L.rotation.z=.4,O.rotation.z=0-L.rotation.z;break;case":'(":case":'-(":t=function(e,t){e.y=2<Math.abs(e.x)?0-3*Math.sin(.2*e.x-1.57)-2:0,8<t&&(e.y-=o?2:i+2)},E.rotation.z=.4,l.rotation.z=0-E.rotation.z,L.rotation.z=.3,O.rotation.z=0-L.rotation.z,l.scale.y=E.scale.y=.5,S.position.y+=2,O.scale.y=L.scale.y=1.5,P.scale.y=c.scale.y=1;break;case"<O":case"(O":t=function(e,t){s=2,o?e.y=Math.sin(.2*e.x+1.57)*s+(t<=8?2:0):(i=Math.abs(6*Math.sin(Date.now()/100)),e.y=8<t?i-4:Math.sin(.2*e.x+1.57)*s+1)},E.rotation.z=.4,l.rotation.z=0-E.rotation.z,l.scale.y=E.scale.y=.5,O.scale.y=L.scale.y=1.5,P.scale.y=c.scale.y=1;break;case">:(":case">:[":t=function(e,t){s=2,e.y=Math.sin(.2*e.x+1.57)*s,8<t&&(e.y-=o?2:i+2)},S.scale.x*=1.25,l.scale.y*=.85,E.scale.y*=.85,L.rotation.z=-.4,O.rotation.z=0-L.rotation.z;break;case">:)":t=function(e,t){e.y=2<Math.abs(e.x)?2*Math.sin(.2*e.x-1.57)+1.5:0,8<t&&(e.y-=o?2:i+2)},S.scale.x=2,S.position.y+=2,l.scale.y*=.85,E.scale.y*=.85,L.rotation.z=-.4,O.rotation.z=0-L.rotation.z;break;case"-_-":case"-__-":case"-___-":t=function(e,t){s=1,e.y=Math.cos(.4*e.x-1.57)*s,8<t&&(e.y-=o?2:i+2)},d.position.y=-1,R.position.y=-1,L.rotation.z=-.1,O.rotation.z=0-L.rotation.z,--O.position.y,--L.position.y,P.scale.y=c.scale.y=.6,S.scale.x*=.5;break;case"//-_-":t=function(e,t){s=1,e.y=Math.cos(.4*e.x-1.57)*s,8<t&&(e.y-=o?2:i+2)},L.rotation.z=-.1,O.rotation.z=0-L.rotation.z,O.position.y-=2,L.position.y-=2,P.scale.y=c.scale.y=1,S.scale.x*=1.5;break;case"o_O":case"O_o":case"o_o":t=function(e,t){e.y=-5,8<t&&(e.y-=o?2:i+2)},S.scale.x=.25,S.position.y+=4,l.scale.multiplyScalar(1.1),L.rotation.z=.1,O.rotation.z=0-L.rotation.z,O.position.y+=2,L.position.y+=2,P.scale.y=c.scale.y=.1;break;case":O":case":o":case":-O":case"=O":t=function(e,t){!o&&8<t&&(e.y=0-(.5*i+6))},S.scale.x=.75,l.scale.multiplyScalar(1.1),L.rotation.z=.1,O.rotation.z=0-L.rotation.z,O.position.y+=2,L.position.y+=2,P.scale.y=c.scale.y=.1;break;case":D":case"=D":t=function(e,t){i=Math.max(i,4),e.y=Math.sin(.2*e.x-1.57)*s,8<t&&(e.y-=o?2:i+2),T.position.y=3-i},E.rotation.z=.1,l.rotation.z=0-E.rotation.z,L.rotation.z=.1,O.rotation.z=0-L.rotation.z;break;case"XD":t=function(e,t){i=Math.max(i,4),e.y=Math.sin(.2*e.x-1.57)*s,8<t&&(e.y-=o?2:i+2)},E.rotation.z=.1,l.rotation.z=0-E.rotation.z,L.rotation.z=.3,O.rotation.z=0-L.rotation.z,l.scale.y=E.scale.y=.5,O.scale.y=L.scale.y=1.5,P.scale.y=c.scale.y=1,S.scale.x=1.5;break;case";)":t=function(e,t){i=0,e.y=Math.cos(.5*e.x+1.2)*s*.5+.2*e.x+(8<t?0-(i+2):0)},E.rotation.z=.1,l.rotation.z=0-E.rotation.z,L.rotation.z=.1,O.rotation.z=0-L.rotation.z,l.scale.y=.5,O.scale.y=1.5,P.scale.y=1;break;case":P":t=function(e,t){i=0,2<Math.abs(e.x)&&(e.y=Math.sin(.2*e.x-1.57)+1+(8<t?0-(i+2):0))},E.rotation.z=.1,l.rotation.z=0-E.rotation.z,L.rotation.z=.1,O.rotation.z=0-L.rotation.z,T.visible=!0;break;case":/":t=function(e,t){e.y=Math.cos(.4*e.x-1.57)*s,8<t&&(e.y-=o?2:i+2)},L.rotation.z=-.1,O.rotation.z=0-L.rotation.z,O.position.y+=2,--L.position.y,P.scale.y=c.scale.y=.4;break;default:t=function(e,t){e.y=0,8<t&&(e.y-=o?2:i+2)},L.rotation.z=.1,O.rotation.z=0-L.rotation.z}t&&(i=Math.abs(6*Math.sin(Date.now()/100)),D.geometry.vertices.map(t,null,0),D.geometry.verticesNeedUpdate=!0,o=!1,m.geometry.vertices.map(t,null,6+i),m.geometry.verticesNeedUpdate=!0)},this.destroy=function(){clearInterval(p),clearInterval(f),p=f=null},Object.defineProperty(this,"mesh",{get:function(){return a}})},SPLODER.BipedItem=function(){var o,n,a,r;this.initWithRectAndMaterial=function(e,t,i){return n=e,a=t,r=i,this},this.build=function(){var e,t=n.getAttrib(SPLODER.Biped.PROPERTY_HEIGHT)/255+.5,i=n.getAttrib(SPLODER.Biped.PROPERTY_STRENGTH)/128,s=n.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128,e=SPLODER.ShapeUtils.getGeometryFromTexture(a.uniforms.textureMap.value.image,r,3,8);e&&((o=new THREE.Mesh(e,a)).rotation.x=1.57,o.position.z=11*SPLODER.weightedValue(0,i,.35,s,-.25),o.position.y=0-32*SPLODER.weightedValue(0,t,.5)+4,o.userData.rect=n,a.uniforms.noOverlap.value=1,a.uniformsNeedUpdate=!0)},Object.defineProperty(this,"mesh",{get:function(){return o}})},SPLODER.Biped=function(){var d,R,E,P,c,u,O,L,S,T,D,m,p,p,p,p,f,g,y,y,I,I,p,m,p,m,I,w,_,M,A,v,N,x,Y,_,S,C,o,b=(this.poses=null,this.initWithRectAndMaterial=function(e,t,i,s){return d=e,R=t,c=i||0,u=s||0,(O=new THREE.Group).userData.biped=this,(L=new THREE.Group).userData.biped=this,O.add(L),C=[],o=[t],this},this.setItemMaterials=function(e,t,i,s){P=e,x=t,E=i,N=s,o.push(P,E)},function(e,t,i,s,o,n,a,r){var e=SPLODER.MeshUtils.getPlaneGeometry(e,t,i,s,o,n,a,r),t=new THREE.Mesh(e,R);return t.userData.rect=d,t}),V=function(e,t,i,s,o,n,a,r,h,l,E){var e=SPLODER.MeshUtils.getBoxGeometry(e,t,i,s,o,n,a,r,h,l,E),t=new THREE.Mesh(e,R);return t.userData.rect=d,t},i=(this.build=function(){var e,t,i=d.getAttrib(SPLODER.Biped.PROPERTY_HEIGHT)/255+.5,s=d.getAttrib(SPLODER.Biped.PROPERTY_WEIGHT)/255+.5,o=d.getAttrib(SPLODER.Biped.PROPERTY_STRENGTH)/128,n=d.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128,a=d.getAttrib(SPLODER.Biped.PROPERTY_HEADSIZE)/128,r=d.getAttrib(SPLODER.Biped.PROPERTY_HEADTHICK)/128,h=d.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/128,l=(L.position.y=96*SPLODER.weightedValue(0,i,.5),(S=b(80*SPLODER.weightedValue(0,s,.5),48*SPLODER.weightedValue(0,s,.5,o,.25))).material=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.2}),S.position.y=4,S.rotation.x=0-.5*Math.PI,O.add(S),(S=S.clone()).material=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.1}),S.scale.multiplyScalar(1.5),S.position.y=3,O.add(S),e=(t=(S=V(60*SPLODER.weightedValue(0,s,.5),32*SPLODER.weightedValue(0,i,.5),32*SPLODER.weightedValue(0,s,.5,o,.25),0,-16*SPLODER.weightedValue(0,i,.5),0,2,1,1)).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,3,19,10,5,19,19,10,5,3,19,1,5,3,19,1,1),e[0].x-=4-8*SPLODER.weightedValue(-1,s,1),e[1].x-=4-8*SPLODER.weightedValue(-1,s,1),e[4].x+=4-8*SPLODER.weightedValue(-1,s,1),e[5].x+=4-8*SPLODER.weightedValue(-1,s,1),e[1].y+=8*SPLODER.weightedValue(0,i,.5),e[4].y+=8*SPLODER.weightedValue(0,i,.5),e[8].y+=8*SPLODER.weightedValue(0,i,.5),e[1].z+=4,e[4].z+=4,e[8].z+=4,e[3].z-=12*SPLODER.weightedValue(-.5,s,.5),e[11].z-=12*SPLODER.weightedValue(-.5,s,.5),e[6].z-=12*SPLODER.weightedValue(-.5,s,.5),e[0].z+=64*SPLODER.weightedValue(-.9,s,.25)-4*h,e[5].z+=64*SPLODER.weightedValue(-.9,s,.25)-4*h,e[9].z+=64*SPLODER.weightedValue(-.9,s,.25)-4*h,e[2].z+=16*SPLODER.weightedValue(-.5,h,.5),e[7].z+=16*SPLODER.weightedValue(-.5,h,.5),e[10].z+=16*SPLODER.weightedValue(-.5,h,.5),e[2].x+=16*SPLODER.weightedValue(-.5,h,.5),e[7].x-=16*SPLODER.weightedValue(-.5,h,.5),e[3].x+=8*SPLODER.weightedValue(-.5,h,.5),e[6].x-=9*SPLODER.weightedValue(-.5,h,.5),S.rotation.x-=.1*SPLODER.weightedValue(-.5,h,1),S.position.z-=12*SPLODER.weightedValue(-.5,h,1),L.add(S),e=(t=(T=V(68*SPLODER.weightedValue(0,s,.5),48*SPLODER.weightedValue(0,i,.5),32*SPLODER.weightedValue(0,s,.5,o,.25),0,24*SPLODER.weightedValue(0,i,.5),0,2,2,1)).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,3,11,10,8,19,11,10,8,3,11,1,8,3,11,10,1),e[2].z+=5+2*SPLODER.weightedValue(0,n,.5),e[9].z+=5+2*SPLODER.weightedValue(0,n,.5),e[16].z+=5*SPLODER.weightedValue(0,n,.5),e[17].z-=0,e[2].z+=5*SPLODER.weightedValue(0,s,1),e[9].z+=5*SPLODER.weightedValue(0,s,1),e[16].z+=5*SPLODER.weightedValue(0,s,1),e[0].x-=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[1].x-=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[2].x-=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[3].x-=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[6].x+=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[7].x+=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[8].x+=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[9].x+=0-3*SPLODER.weightedValue(-.75,o,1,s,.25),e[4].x-=8-8*SPLODER.weightedValue(-1,s,1),e[5].x-=8-8*SPLODER.weightedValue(-1,s,1),e[10].x+=8-8*SPLODER.weightedValue(-1,s,1),e[11].x+=8-8*SPLODER.weightedValue(-1,s,1),e[4].z+=80*SPLODER.weightedValue(-.9,s,.25),e[14].z+=80*SPLODER.weightedValue(-.9,s,.25),e[11].z+=80*SPLODER.weightedValue(-.9,s,.25),e[4].y+=Math.min(0,80*SPLODER.weightedValue(-.9,h,.25)),e[14].y+=Math.min(0,80*SPLODER.weightedValue(-.9,h,.25)),e[11].y+=Math.min(0,80*SPLODER.weightedValue(-.9,h,.25)),T.rotation.x+=.3*SPLODER.weightedValue(-.5,h,1),T.position.z-=12*SPLODER.weightedValue(-.5,h,1),L.add(T),(D=V(32*SPLODER.weightedValue(0,s,.8),24*SPLODER.weightedValue(0,i,.5),18*SPLODER.weightedValue(0,s,.8),0,12*SPLODER.weightedValue(0,i,.5),0)).position.y+=42*SPLODER.weightedValue(0,i,.5),SPLODER.MeshUtils.transformUVs(D.geometry,c,u,6,10,4,1,22,10,4,1,6,10,4,1,6,10,1,1),D.rotation.x+=.3*SPLODER.weightedValue(-.5,h,1),T.add(D),(m=V(42*SPLODER.weightedValue(0,s,.25),48*SPLODER.weightedValue(0,r,.25),42*SPLODER.weightedValue(0,s,.25),0,24*SPLODER.weightedValue(0,r,.25),4,1,1,1,!1,0-SPLODER.weightedValue(0,o,16))).position.y+=12*SPLODER.weightedValue(0,i,.5,r,.5),m.position.z+=12*SPLODER.weightedValue(-.5,h,.5),m.rotation.x-=.6*SPLODER.weightedValue(-.5,h,1),h<.25&&(m.rotation.x-=.25-SPLODER.weightedValue(0,h,1)),SPLODER.MeshUtils.transformUVs(m.geometry,c,u,4,1,8,9,20,1,8,9,36,1,8,9,36,11,8,8),m.scale.multiplyScalar(.25+SPLODER.weightedValue(0,a,.25)),D.add(m),p=V(42*SPLODER.weightedValue(0,s,.25),8*SPLODER.weightedValue(0,r,.25),1,0,4*SPLODER.weightedValue(0,r,.25),0,1,1,1,!1),SPLODER.MeshUtils.transformUVs(p.geometry,c,u,4,0,8,1,20,0,8,1,0,0,0,0,0,0,0,0),p.position.y+=48*SPLODER.weightedValue(0,r,.25),p.position.z+=18*SPLODER.weightedValue(0,s,.25),m.add(p),p=V(24,48*SPLODER.weightedValue(0,r,.25),2,33*SPLODER.weightedValue(0,s,.25)-1,24*SPLODER.weightedValue(0,r,.25),0,1,1,1,!0),SPLODER.MeshUtils.transformUVs(p.geometry,c,u,12,1,4,9,16,1,-4,9,0,0,0,0,0,0,0,0),m.add(p),p=V(24,48*SPLODER.weightedValue(0,r,.25),2,-33*SPLODER.weightedValue(0,s,.25)+1,24*SPLODER.weightedValue(0,r,.25),0),SPLODER.MeshUtils.transformUVs(p.geometry,c,u,0,1,4,9,4,1,-4,9,0,0,0,0,0,0,0,0),m.add(p),p=V(1,48*SPLODER.weightedValue(0,r,.25),24,0,24*SPLODER.weightedValue(0,r,.25),-29*SPLODER.weightedValue(0,s,.25)),SPLODER.MeshUtils.transformUVs(p.geometry,c,u,0,0,0,0,0,0,0,0,32,1,4,9,0,0,0,0),m.add(p),(f=(new SPLODER.BipedFace).initWithRectAndMaterial(d,R,c,u)).build(),f.mesh.position.z=26.2*Math.max(.75,SPLODER.weightedValue(0,s,.25,r,.0125)),f.mesh.position.y=24*SPLODER.weightedValue(0,r,.25,o,.125),f.mesh.rotation.x=0-SPLODER.weightedValue(-1,o,.08),f.mesh.scale.y=+SPLODER.weightedValue(0,r,.25),m.add(f.mesh),e=(t=(p=V(50*SPLODER.weightedValue(0,s,.25),64*SPLODER.weightedValue(0,r,.25),44*SPLODER.weightedValue(0,s,.25),0,20*SPLODER.weightedValue(0,r,.25),0,1,2,1,!1,0-SPLODER.weightedValue(0,o,24))).geometry).vertices,SPLODER.MeshUtils.transformUVs(p.geometry,c,u,36,19,8,8,36,19,1,8,36,19,.9,8,36,19,8,1),e[2].y-=20,e[3].y-=20,e[8].y-=20,e[9].y-=20,e[2].z-=8,e[9].z-=8,e[4].z-=20,e[5].z+=20,e[10].z+=20,e[11].z-=20,m.add(p),m=b(96*SPLODER.weightedValue(0,s,.5),84*SPLODER.weightedValue(0,i,.5),0,42*SPLODER.weightedValue(0,i,.5),0),SPLODER.MeshUtils.transformUVs(m.geometry,c,u,64,5,-16,14),m.position.z-=20*SPLODER.weightedValue(0,s,.5,o,.25),m.rotation.x=0-15*Math.PI/180,T.add(m),(m=b(96*SPLODER.weightedValue(0,s,.5),84*SPLODER.weightedValue(0,i,.5),0,42*SPLODER.weightedValue(0,i,.5),0)).rotation.x=0-15*Math.PI/180,m.position.z-=20*SPLODER.weightedValue(0,s,.5,o,.25),m.rotation.y=Math.PI,SPLODER.MeshUtils.transformUVs(m.geometry,c,u,48,5,16,14),T.add(m),e=(t=(p=b(96*SPLODER.weightedValue(0,s,.5),72*SPLODER.weightedValue(0,i,.5),0,-36*SPLODER.weightedValue(0,i,.5),0,2,1)).geometry).vertices,SPLODER.MeshUtils.transformUVs(p.geometry,c,u,64,19,-16,12),e[5].y-=16*SPLODER.weightedValue(0,i,1),e[4].y-=16*SPLODER.weightedValue(0,i,1),e[3].y-=16*SPLODER.weightedValue(0,i,1),e[5].x+=16*SPLODER.weightedValue(0,s,.5),e[3].x-=16*SPLODER.weightedValue(0,s,.5),p.position.z-=20*SPLODER.weightedValue(0,s,.5,o,.25),p.rotation.x=18*Math.PI/180-SPLODER.weightedValue(-.9,h,.5),T.add(p),m=p,e=(t=(p=b(96*SPLODER.weightedValue(0,s,.5),72*SPLODER.weightedValue(0,i,.5),0,-36*SPLODER.weightedValue(0,i,.5),0,2,1)).geometry).vertices,SPLODER.MeshUtils.transformUVs(p.geometry,c,u,48,19,16,12),e[5].y-=16*SPLODER.weightedValue(0,i,1),e[4].y-=16*SPLODER.weightedValue(0,i,1),e[3].y-=16*SPLODER.weightedValue(0,i,1),e[5].x+=16*SPLODER.weightedValue(0,s,.5),e[3].x-=16*SPLODER.weightedValue(0,s,.5),p.rotation.x=18*Math.PI/180-SPLODER.weightedValue(-.9,h,.5),p.position.z-=20*SPLODER.weightedValue(0,s,.5,o,.25),p.position.y+=.5,p.rotation.y=Math.PI,T.add(p),e=(t=(g=V(20*SPLODER.weightedValue(0,s,.5,o,.25),40*SPLODER.weightedValue(0,i,.5),20*SPLODER.weightedValue(0,s,.5,o,.25),0,-16*SPLODER.weightedValue(0,i,.5),0,1,1,1,!0,SPLODER.weightedValue(0,s,64))).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,9,24,4,4,19,24,4,4,9,24,1,4,9,24,1,1),e[2].z-=2,e[7].z-=2,g.position.x+=14*SPLODER.weightedValue(0,s,.25),g.position.y-=28*SPLODER.weightedValue(0,i,.5),g.rotation.x-=.2*SPLODER.weightedValue(0,h,1)*Math.min(1,s),g.rotation.z+=.2*SPLODER.weightedValue(0,h,1)*Math.min(1,s),g.rotation.y+=.2*SPLODER.weightedValue(0,h,1)*Math.min(1,s),S.add(g),e=(t=(y=V(22*SPLODER.weightedValue(0,s,.25,o,.25),32*SPLODER.weightedValue(0,i,.5),20*SPLODER.weightedValue(0,s,.25,o,.25),0,-16*SPLODER.weightedValue(0,i,.5),0,1,3,1,!0)).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,9,28,4,4,19,28,4,4,9,28,1,4,9,28,1,1),e[0].y+=10,e[9].y+=10,e[4].y+=5,e[6].y+=5,e[13].y+=5,e[15].y+=5,e[4].z+=10,e[6].z+=10,e[13].z+=10,e[15].z+=10,y.position.y=-36*SPLODER.weightedValue(0,i,.5),y.rotation.x+=.4*SPLODER.weightedValue(0,h,1),g.add(y),e=(t=(y=V(20*SPLODER.weightedValue(0,s,.5,o,.25),40*SPLODER.weightedValue(0,i,.5),20*SPLODER.weightedValue(0,s,.5,o,.25),0,-16*SPLODER.weightedValue(0,i,.5),0,1,1,1,!1,SPLODER.weightedValue(0,s,64))).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,3,24,4,4,25,24,4,4,3,24,1,4,3,24,1,1),e[2].z-=2,e[7].z-=2,y.position.x-=14*SPLODER.weightedValue(0,s,.25),y.position.y-=28*SPLODER.weightedValue(0,i,.5),y.rotation.y-=.2*SPLODER.weightedValue(0,h,1)*Math.min(1,s),y.rotation.z-=.2*SPLODER.weightedValue(0,h,1)*Math.min(1,s),y.rotation.x-=.2*SPLODER.weightedValue(0,h,1)*Math.min(1,s),S.add(y),e=(t=(I=V(22*SPLODER.weightedValue(0,s,.25,o,.25),32*SPLODER.weightedValue(0,i,.5),20*SPLODER.weightedValue(0,s,.25,o,.25),0,-16*SPLODER.weightedValue(0,i,.5),0,1,3,1)).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,3,28,4,4,25,28,4,4,3,28,1,4,3,28,1,1),e[0].y+=10,e[9].y+=10,e[4].y+=5,e[6].y+=5,e[13].y+=5,e[15].y+=5,e[4].z+=10,e[6].z+=10,e[13].z+=10,e[15].z+=10,I.position.y=-36*SPLODER.weightedValue(0,i,.5),I.rotation.x+=.4*SPLODER.weightedValue(0,h,1),y.add(I),e=(t=(I=V(60*SPLODER.weightedValue(0,s,.5),48*SPLODER.weightedValue(0,i,.5),32*SPLODER.weightedValue(0,s,.5,o,.25),0,-24*SPLODER.weightedValue(0,i,.5),0,3)).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,7,24,2,6,23,24,2,6,7,24,1,6,7,24,1,1),e[2].x+=6*SPLODER.weightedValue(0,n,.25),e[3].x+=6*SPLODER.weightedValue(0,n,.25),e[6].x-=6*SPLODER.weightedValue(0,n,.25),e[7].x-=6*SPLODER.weightedValue(0,n,.25),e[1].z-=12*SPLODER.weightedValue(-.5,s,.5),e[4].z-=12*SPLODER.weightedValue(-.5,s,.5),e[8].z-=12*SPLODER.weightedValue(-.5,s,.5),e[9].z-=12*SPLODER.weightedValue(-.5,s,.5),e[3].z-=24*SPLODER.weightedValue(0,n,.25),e[6].z-=24*SPLODER.weightedValue(0,n,.25),e[14].z-=24*SPLODER.weightedValue(0,n,.25),e[15].z-=24*SPLODER.weightedValue(0,n,.25),e[12].z+=16*SPLODER.weightedValue(0,n,.25),e[13].z+=16*SPLODER.weightedValue(0,n,.25),e[2].z+=8*SPLODER.weightedValue(0,n,.25),e[7].z+=8*SPLODER.weightedValue(0,n,.25),e[0].z+=16*SPLODER.weightedValue(-.5,h,.5),e[5].z+=16*SPLODER.weightedValue(-.5,h,.5),e[10].z+=16*SPLODER.weightedValue(-.5,h,.5),e[11].z+=16*SPLODER.weightedValue(-.5,h,.5),e[0].x+=16*SPLODER.weightedValue(-.5,h,.5),e[5].x-=16*SPLODER.weightedValue(-.5,h,.5),e[2].x+=16*SPLODER.weightedValue(-.5,h,.5),e[7].x-=16*SPLODER.weightedValue(-.5,h,.5),e[1].x+=8*SPLODER.weightedValue(-.5,h,.5),e[4].x-=8*SPLODER.weightedValue(-.5,h,.5),e[3].x+=8*SPLODER.weightedValue(-.5,h,.5),e[6].x-=8*SPLODER.weightedValue(-.5,h,.5),e[3].y+=16*SPLODER.weightedValue(-.5,h,.5),e[6].y+=16*SPLODER.weightedValue(-.5,h,.5),e[14].y+=16*SPLODER.weightedValue(-.5,h,.5),e[15].y+=16*SPLODER.weightedValue(-.5,h,.5),I.position.y=-32*SPLODER.weightedValue(0,i,.5),S.add(I),e=(t=(I=V(16*SPLODER.weightedValue(0,o,.35),42*SPLODER.weightedValue(0,i,.5),20*SPLODER.weightedValue(0,o,.35,n,-.25),0,-20*SPLODER.weightedValue(0,i,.5),0,1,1,1,!0,Math.max(0,SPLODER.weightedValue(0,o,24)))).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,13,11,3,7,16,11,3,7,15,11,1,7,15,11,1,1),e[4].y+=5,e[5].y+=5,e[3].z+=5*SPLODER.weightedValue(0,o,.35,n,-.25),e[6].z+=5*SPLODER.weightedValue(0,o,.35,n,-.25),I.position.x=40*SPLODER.weightedValue(0,s,.5)+SPLODER.weightedValue(0,o,4),I.position.y+=42*SPLODER.weightedValue(0,i,.5),I.rotation.z+=.2*SPLODER.weightedValue(0,h,1),I.rotation.x-=.4*SPLODER.weightedValue(0,h,1),T.add(I),e=(t=(w=V(16*SPLODER.weightedValue(0,o,.35),42*SPLODER.weightedValue(0,i,.5),20*SPLODER.weightedValue(0,o,.35,n,-.25),0,-20*SPLODER.weightedValue(0,i,.5),0,1,1,1,!1,Math.max(0,SPLODER.weightedValue(0,o,24)))).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,0,11,3,7,29,11,3,7,0,11,1,7,0,11,1,1),e[0].y+=5,e[1].y+=5,e[3].z+=5*SPLODER.weightedValue(0,o,.35,n,-.25),e[6].z+=5*SPLODER.weightedValue(0,o,.35,n,-.25),w.position.x=-40*SPLODER.weightedValue(0,s,.5)-SPLODER.weightedValue(0,o,4),w.position.y+=42*SPLODER.weightedValue(0,i,.5),w.rotation.z-=.2*SPLODER.weightedValue(0,h,1),w.rotation.x-=.4*SPLODER.weightedValue(0,h,1),T.add(w),e=(t=(_=V(18*SPLODER.weightedValue(0,o,.35),42*SPLODER.weightedValue(0,i,.5),22*SPLODER.weightedValue(0,o,.35,n,-.25),0,-21*SPLODER.weightedValue(0,i,.5),0,1,4,1,!0)).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,13,18,3,6,16,18,3,6,15,18,1,6,15,18,1,1),e[1].y+=10,e[10].y+=10,e[4].x-=3,e[4].z-=3,e[5].x-=3,e[5].z+=3,e[14].x+=3,e[14].z+=3,e[15].x+=3,e[15].z-=3,e[8].x-=3,e[8].z-=3,e[9].x-=3,e[9].z+=3,e[18].x+=3,e[18].z+=3,e[19].x+=3,e[19].z-=3,_.position.y=-40*SPLODER.weightedValue(0,i,.5),_.rotation.z-=.2*SPLODER.weightedValue(0,h,1),_.rotation.x-=.2*SPLODER.weightedValue(0,h,1),I.add(_),E&&N&&((A=(new SPLODER.BipedItem).initWithRectAndMaterial(d,E,N)).build(),A.mesh.rotation.y=1.57,A.mesh.position.x+=8,_.add(A.mesh)),e=(t=(M=V(18*SPLODER.weightedValue(0,o,.35),42*SPLODER.weightedValue(0,i,.5),22*SPLODER.weightedValue(0,o,.35,n,-.25),0,-21*SPLODER.weightedValue(0,i,.5),0,1,4,1)).geometry).vertices,SPLODER.MeshUtils.transformUVs(t,c,u,0,18,3,6,29,18,3,6,0,18,1,6,0,18,1,1),e[1].y+=10,e[10].y+=10,e[4].x-=3,e[4].z-=3,e[5].x-=3,e[5].z+=3,e[14].x+=3,e[14].z+=3,e[15].x+=3,e[15].z-=3,e[8].x-=3,e[8].z-=3,e[9].x-=3,e[9].z+=3,e[18].x+=3,e[18].z+=3,e[19].x+=3,e[19].z-=3,M.position.y=-40*SPLODER.weightedValue(0,i,.5),M.rotation.z+=.2*SPLODER.weightedValue(0,h,1),M.rotation.x-=.2*SPLODER.weightedValue(0,h,1),w.add(M),(Y=b(21*SPLODER.weightedValue(0,o,.35,n,-.25),22*SPLODER.weightedValue(0,i,.5),0,11*SPLODER.weightedValue(0,i,.5),0)).position.y-=53.25*SPLODER.weightedValue(0,i,.5),Y.position.x+=8.75*SPLODER.weightedValue(0,o,.35),Y.rotation.y=.5*Math.PI,SPLODER.MeshUtils.transformUVs(Y.geometry,c,u,13,24,5,5),_.add(Y),(Y=Y.clone()).rotation.y=.5*-Math.PI,_.add(Y),(_=b(21*SPLODER.weightedValue(0,o,.35,n,-.25),22*SPLODER.weightedValue(0,i,.5),0,11*SPLODER.weightedValue(0,i,.5),0)).position.y-=53.25*SPLODER.weightedValue(0,i,.5),_.position.x-=8.75*SPLODER.weightedValue(0,o,.35),_.rotation.y=.5*-Math.PI,SPLODER.MeshUtils.transformUVs(_.geometry,c,u,13,24,5,5),M.add(_),(_=_.clone()).rotation.y=.5*Math.PI,M.add(_),P&&x&&((v=(new SPLODER.BipedItem).initWithRectAndMaterial(d,P,x)).build(),M.add(v.mesh)),(e=(t=S.geometry).vertices)[0].x-=4*SPLODER.weightedValue(-1,n,1),e[1].x-=4*SPLODER.weightedValue(-1,n,1),e[4].x+=4*SPLODER.weightedValue(-1,n,1),e[5].x+=4*SPLODER.weightedValue(-1,n,1),(e=(t=T.geometry).vertices)[4].x-=4*SPLODER.weightedValue(-1,n,1),e[5].x-=4*SPLODER.weightedValue(-1,n,1),e[10].x+=4*SPLODER.weightedValue(-1,n,1),e[11].x+=4*SPLODER.weightedValue(-1,n,1),e[2].y+=4*SPLODER.weightedValue(-1,n,1),e[9].y+=4*SPLODER.weightedValue(-1,n,1),e[2].z+=4*SPLODER.weightedValue(-1,n,1),e[9].z+=4*SPLODER.weightedValue(-1,n,1),e[0].y-=4*SPLODER.weightedValue(-.5,n,1),e[1].y-=4*SPLODER.weightedValue(-.5,n,1),e[6].y-=4*SPLODER.weightedValue(-.5,n,1),e[7].y-=4*SPLODER.weightedValue(-.5,n,1),e[0].z-=4*SPLODER.weightedValue(-1,n,1,s,.5),e[1].z+=4*SPLODER.weightedValue(-1,n,1,s,.5),e[6].z+=4*SPLODER.weightedValue(-1,n,1,s,.5),e[7].z-=4*SPLODER.weightedValue(-1,n,1,s,.5),I.position.y-=4*SPLODER.weightedValue(-.5,n,1),w.position.y-=4*SPLODER.weightedValue(-.5,n,1),function(e){C.push(e.geometry);for(var t=e.children.length;t--;)l(e.children[t])});l(L),this.poses=(new SPLODER.BipedPoses).initWithElements(d,L,S,T,D,f,g,y,I,w,p,m,v,A)},function(e,t,i){i=i||L,SPLODER.MeshUtils.offsetUVsRecursive(e,t,i)});this.destroy=function(){f&&(f.destroy(),f=null),this.poses&&(this.poses.destroy(),this.poses=null)},Object.defineProperty(this,"skinX",{get:function(){return c},set:function(e){var t;isNaN(e)||(i(e-c,0),c=e)}}),Object.defineProperty(this,"skinY",{get:function(){return u},set:function(e){var t;isNaN(e)||(i(0,e-u),u=e)}}),Object.defineProperty(this,"mesh",{get:function(){return O}}),Object.defineProperty(this,"itemLeft",{get:function(){return A}}),Object.defineProperty(this,"itemRight",{get:function(){return v}}),Object.defineProperty(this,"geometries",{get:function(){return C}}),Object.defineProperty(this,"materials",{get:function(){return o}})},SPLODER.Biped.PROPERTY_SKIN=5,SPLODER.Biped.PROPERTY_HEIGHT=6,SPLODER.Biped.PROPERTY_WEIGHT=7,SPLODER.Biped.PROPERTY_STRENGTH=8,SPLODER.Biped.PROPERTY_GENDER=9,SPLODER.Biped.PROPERTY_HEADSIZE=10,SPLODER.Biped.PROPERTY_HEADTHICK=11,SPLODER.Biped.PROPERTY_BEASTLY=12,SPLODER.Biped.PROPERTY_ITEMFRAME_RIGHT=13,SPLODER.Biped.PROPERTY_ITEMFRAME_LEFT=14,((e,t)=>{e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_SKIN]=0,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_HEIGHT]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_WEIGHT]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_STRENGTH]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_GENDER]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_HEADSIZE]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_HEADTHICK]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_BEASTLY]=64,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_ITEMFRAME_RIGHT]=-1,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_ITEMFRAME_LEFT]=-1})(SPLODER.Item,SPLODER.Biped),SPLODER.ImageMap=function(){var d=0,R,P,c,u,O=(this.canvas=null,this.context=null,this.initWithDefaultValue=function(e){return d=e,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this},function(e){return e--,e=(e=(e=(e=(e|=e>>1)|e>>2)|e>>4)|e>>8)|e>>16,++e}),h=function(e,t,i,s,o){var n,a,r,h,l,E,d;for(o=o||0,r=t.x-R,h=t.y-P,l=r+t.width,E=h+t.height,a=h;a<E;a++)for(n=r;n<l;n++)d=a*c+n,i[d*=4]=Math.min(255,Math.max(0,10*s)),i[1+d]=Math.min(255,Math.max(0,o)),i[2+d]=0,i[3+d]=255},L=function(e,t,i){if(e){var s=e.items.concat();s.reverse();for(var o,n,a,r=e.items.length;r--;)(o=s[r]).type==SPLODER.Item.TYPE_WALL&&(a=o.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=o.getAttrib(SPLODER.Item.PROPERTY_CEIL)?o.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):128,h(i,o,t,Math.max(0,n-a),o.getAttrib(SPLODER.Item.PROPERTY_LIGHTLEVEL)+o.getAttrib(SPLODER.Item.PROPERTY_LIGHTEFFECT)))}};this.getData=function(e,t,i,s){return s=s||0,this.context.getImageData(e,t,1,1).data[s]},this.updateBounds=function(e,t){var e=e.bounds;R=e.x-t,P=e.y-t,c=Math.min(2048,O(e.width+2*t)),u=Math.min(2048,O(e.height+2*t))},this.update=function(e,t,i){var s=e.bounds,s=(R=s.x-(i=i||0),P=s.y-i,c=this.canvas.width=Math.min(2048,O(s.width+2*i)),u=this.canvas.height=Math.min(2048,O(s.height+2*i)),this.canvas.getContext("2d")),o=(s.clearRect(0,0,c,u),new THREE.Color(16776960));o.multiplyScalar(d/255),s.fillStyle="#"+o.getHexString(),s.fillRect(0,0,c,u);var n,a,r,h,o=s.getImageData(0,0,c,u),l=o.data;if(L(e,l,i),0<i&&(s.fillRect(0,0,i,u),s.fillRect(0,0,c,i),s.fillRect(c-i,0,i,u),s.fillRect(0,u-i,c,i)),t)for(var E=t.length,h=0,r=0;r<u;r++){for(a=0;a<12;a++)n=r*c+a,n*=4,h<E&&(l[2+n]=t[h]),h++;if(E<=h)break}h<E&&console.log("WARNING: All lights could not fit into space"),s.putImageData(o,0,0)}},SPLODER.Store=function(){this.id=0,this.items=null,this.bounds=null,this.duplicatedItems=null,this.selection=null,this.nextItemId=1,this.changed=null,this.bookmarked=null,this.ItemClass=SPLODER.Rect,this.init=function(){return this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++,this.items=[],this.bounds={x:0,y:0,width:0,height:0,size:0},this.duplicatedItems=[],this.selection=[],this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.addItem=function(e,t,i,s,o,n){var e=new this.ItemClass(e,t,i,s,o);return e.id=this.nextItemId,this.nextItemId++,this.items.push(e),SPLODER.ShapeUtils.sortByAreaDesc(this.items),n||this.updateBounds(),e},this.updateBounds=function(){this.bounds=SPLODER.ShapeUtils.getBounds(this.items)},this.serialize=function(e){var t=!e;e=e||this.items;for(var i,s=[],o=this.selection,n=[],i=e.length;i--;)s.unshift(e[i].serialize());if(t)for(i=o.length;i--;)n.unshift(o[i].id);return s.join("|").split("null").join("@")+"~"+n.join("|")},this.unserialize=function(e,t){if(e){var i=[],s=[];if(0<=(e=e.split("@").join("null")).indexOf("~")){for(var o,e=e.split("~"),n=e[0].split("|"),a=e[1].split("|"),o=0;o<a.length;o++)a[o]=parseInt(a[o]);if(n.length)for(o=0;o<n.length;o++){var r=new this.ItemClass;r.unserialize(n[o]),isNaN(r.id)||(i.push(r),t||(this.nextItemId=Math.max(this.nextItemId,r.id)),a.length&&0<=a.indexOf(r.id)&&s.push(r))}if(SPLODER.ShapeUtils.sortByAreaDesc(i),SPLODER.ShapeUtils.sortByAreaDesc(s),t)return this.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE),i;this.nextItemId++,this.items=i,this.selection=s,this.updateBounds(),this.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE)}}},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){this.unserialize(e),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){this.unserialize(e),this.changed.dispatch(SPLODER.ACTION_REDO)},this.hasSelection=function(e){return void 0===e?0<this.selection.length:this.selection.length==e},this.selectionType=function(){var e=this.selection;if(0==e.length)return-1;for(var t=e[0].type,i=e.length;i--;)if(e[i].type!=t)return-2;return t},this.deleteSelection=function(){for(var e,t=this.selection,i=this.items,s=t.length;s--;)0<=(e=i.indexOf(t[s]))&&i.splice(e,1);this.selection=[],this.updateBounds()},this.getItemById=function(e){for(var t=this.items,i=t.length;i--;)if(t[i].id==e)return t[i];return null},this.filterType=function(e,t){if(null!=t&&e!==t){if(t!=SPLODER.Item.TYPE_FILTER_WALL_LIQUID)return!1;if(e!=SPLODER.Item.TYPE_WALL&&e!=SPLODER.Item.TYPE_LIQUID)return!1}return!0},this.getItemsUnderPoint=function(e,t,i,s,o,n,a){i=i||0;for(var r,h=(s=s||this.items).length,l=o?[]:null;h--;)if(r=s[h],this.filterType(r.type,n))if((r.type==SPLODER.Item.TYPE_ITEM||r.type==SPLODER.Item.TYPE_BIPED)&&SPLODER.Geom.distanceBetweenSquared(e,t,r.x,r.y)<=4){if(!o)return r;l.push(r)}else if(r.type==SPLODER.Item.TYPE_LIGHT&&SPLODER.Geom.distanceBetweenSquared(e,t,r.x,r.y)<=2){if(!o)return r;l.push(r)}else if(e>=r.x-i&&t>=r.y-i&&e<=r.x+r.width+i&&t<=r.y+r.height+i){if(!o)return a?[r].concat(SPLODER.ShapeUtils.getDescendants(r)):r;l.push(r)}return l&&(SPLODER.ShapeUtils.sortByAreaDesc(l),l.reverse()),l},this.getItemUnderPoint=function(e,t,i,s,o){return this.getItemsUnderPoint(e,t,i,null,!1,s,o)},this.selectionIsUnderPoint=function(e,t,i){return this.getItemsUnderPoint(e,t,i,this.selection)},this.itemIsSelected=function(e,t){return-1!==this.selection.indexOf(e)&&(!t||1==this.selection.length)},this.itemWithIdIsSelected=function(e,t){var e=this.getItemById(e);return!!e&&this.itemIsSelected(e,t)},this.getItemsWithinRect=function(e,t,i,s,o,n){for(var a,r=(n=n||this.items).length,h=[];r--;)a=n[r],this.filterType(a.type,o)&&e<=a.x&&t<=a.y&&e+i>=a.x+a.width&&t+s>=a.y+a.height&&h.push(a);return h},this.getItemsIntersectingRect=function(e,t,i,s,o,n){for(var a,r=(n=n||this.items).length,h=[];r--;)a=n[r],!this.filterType(a.type,o)||a.x>e+i||a.x+a.width<e||a.y>t+s||a.y+a.height<t||h.push(a);return h},this.getItemsByType=function(e){for(var t,i=[],s=this.items.length;s--;)t=this.items[s],this.filterType(t.type,e)&&i.unshift(t);return i}},SPLODER.Store._nextId=1,SPLODER.Store.prototype.onAction=function(e){console.log("ABSTRACT METHOD CALLED: OVERRIDE!",e)},SPLODER.Store.prototype.copySelectionAsClipboard=function(){var e=this.selection,t={modelId:this.id,bounds:SPLODER.ShapeUtils.getBounds(e),data:""};if(e.length){for(var i=[],s=0;s<e.length;s++)item=e[s],i.push(item.serialize());t.data=i.join("|")}return t},SPLODER.Store.prototype.pasteSelectionFromClipboard=function(e,t){if(e&&e.modelId==this.id&&e.data){this.saveUndo();for(var i=e.data.split("|"),s=this.selection=[],o=0;o<i.length;o++)(item=this.addItem()).unserialize(i[o],!0),s.push(item);return this.updateBounds(),!1!==t&&1<s.length&&SPLODER.ShapeUtils.sortByAreaDesc(s),this.changed.dispatch(SPLODER.ACTION_CLIPBOARD_PASTE,s),s}},SPLODER.Store.LIGHT_COLOR_CHOICES=[16777215,16764057,16750950,16724736,16711935,10040319,13311,52479,65280],SPLODER.GameStore=function(){SPLODER.Store.call(this);var t=0;Object.defineProperty(this,"level",{get:function(){return t},set:function(e){isNaN(e)||(t=e)}}),this.ItemClass=SPLODER.Item,this.addItem=function(e,t,i,s,o,n,a){var e=new SPLODER.Item(e,t,i,s,o,n);return e.id=this.nextItemId,this.nextItemId++,this.items.push(e),SPLODER.ShapeUtils.sortByAreaDesc(this.items),a||this.updateBounds(),e},this.onAction=function(e){var e=e[0];e>=SPLODER.ACTION_CREATE&&(this.changed.dispatch(e,-1),SPLODER.ShapeUtils.buildTree(this.items))}},SPLODER.GameStore.prototype=Object.create(SPLODER.Store.prototype),SPLODER.GameStore.prototype.constructor=SPLODER.GameStore,SPLODER.Levels=function(){this.id=null,this.changed=null;var o=this.bookmarked=null,n=this,i=(this.model=null,this.envModel=null,0),a=0,r=1,s=(Object.defineProperty(this,"currentLevel",{get:function(){return a},set:function(e){h(e)}}),this.initWithModels=function(e,t){return this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++,o=[],this.model=e,this.envModel=t,this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.initWithModelAndData=function(e,t){this.initWithModel(e),s(t)},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.getLevelNums=function(){return o.reduce(function(e,t,i){return t&&t instanceof Array&&e.push(i),e},[])},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){s(e,SPLODER.ACTION_UNDO),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){s(e,SPLODER.ACTION_REDO),this.changed.dispatch(SPLODER.ACTION_REDO)},this.serialize=function(){for(var e=[],t=0;t<o.length;t++)e[t]=o[t]instanceof Array?this.model.serialize(o[t]):null;return console.log("SERIALIZING"),console.log(e),e.join("_#_")+"_#_"+i+","+a+","+r},function(e,t){var i=e.split("_#_");o=[];for(var s=0;s<i.length-1;s++)console.log(s,i[s]),o[s]=i[s]&&i[s].length?n.model.unserialize(i[s],!0):s<i.length-1?null:[];var e=SPLODER.parseFloatArray(i[i.length-1].split(","));e.length&&(r=e[2],n.model.nextItemId=r=Math.max(n.model.nextItemId,r),t==SPLODER.ACTION_UNDO?h(e[0],!0):h(e[1],!0)),console.log("current level",a,"max item id",r)}),h=function(e,t){if(a!=e&&!isNaN(e)&&0<=e){if(!o[e]){if(e!=o.length)return;o[e]=[]}t||(o[a]=n.model.items),r=Math.max(n.model.nextItemId,r),n.model.selection=[],n.model.items=o[e],i=a,a=n.envModel.currentLevel=e,t||n.saveUndo(),n.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE)}},l=function(){h(o.length),n.saveUndo(),n.changed.dispatch(SPLODER.ACTION_CHANGE)},E=function(){var e;o[a]instanceof Array&&0<o[a].length&&(e=o[a].concat(),l(),o[a]=n.model.items=e,n.saveUndo(),n.changed.dispatch(SPLODER.ACTION_CHANGE))},d=function(){var e;console.log("DELETING",o[a]),0!=a&&o[a]instanceof Array&&(e=a,h(0),o[e]=null,n.saveUndo(),n.changed.dispatch(SPLODER.ACTION_CHANGE))};this.onAction=function(e){var t=e[0],i=e[1];switch(t){case SPLODER.ACTION_SELECT_ITEM:h(i);break;case SPLODER.ACTION_SELECTION_DUPLICATE:E();break;case SPLODER.ACTION_SELECTION_DELETE:d();break;case SPLODER.ACTION_CREATE:l()}}},SPLODER.EnvModel=function(){this.id=null,this.changed=null;var s=this.bookmarked=null,i=0,o=this,t=(Object.defineProperty(this,"currentLevel",{get:function(){return i},set:function(e){n(e)}}),this.init=function(){return this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++,s=[],this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.initWithData=function(e){this.init(),t(e)},this.setEnv=function(e,t){e=e||0,s[i]||(s[i]=[]),s[i][e]=t},this.getEnvs=function(){return s[i]||[]},this.hasEnv=function(e){return s&&s[i]&&s[i][e]},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){t(e),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){t(e),this.changed.dispatch(SPLODER.ACTION_REDO)},this.serialize=function(){for(var e=[],t=0;t<s.length;t++)e[t]=s[t]instanceof Array?s[t].join(","):"";return e.join("|")},function(e){for(var t=e.split("|"),i=0;i<t.length;i++)s[i]=t[i]?SPLODER.parseFloatArray(t[i].split(",")):[];o.changed.dispatch([SPLODER.EnvModel.ENVIRONMENT,SPLODER.ACTION_CHANGE])}),n=function(e){!isNaN(e)&&0<=e&&(i=e,o.changed.dispatch([SPLODER.EnvModel.ENVIRONMENT,SPLODER.ACTION_CONTEXT_CHANGE,i]))};this.onAction=function(e){var t,i,e;e&&e[0]===SPLODER.ACTION_CHANGE&&(console.log(e),e[2]===SPLODER.EnvModel.PROPERTY_SKY_COLOR)&&(this.saveUndo(),i=e[3],e=e[4]||0,this.setEnv(SPLODER.EnvModel.PROPERTY_SKY_COLOR,i.getHex(),e),this.changed.dispatch([SPLODER.EnvModel.ENVIRONMENT,SPLODER.ACTION_CHANGE,SPLODER.EnvModel.PROPERTY_SKY_COLOR,i]))}},SPLODER.EnvModel.ENVIRONMENT=-10,SPLODER.EnvModel.PROPERTY_SKY_COLOR=0,SPLODER.ModelHistory=function(){var o=null,n=null,a=null,r=null,h=null,l={data:"",modelId:0};this.changed=new signals.Signal,Object.defineProperty(this,"clipboardModelId",{get:function(){return l.modelId}}),Object.defineProperty(this,"hasUndos",{get:function(){return n&&0<n.length}}),Object.defineProperty(this,"hasRedos",{get:function(){return a&&0<a.length}}),this.init=function(){return o=[],n=[],r=[],a=[],h=[],localStorage&&localStorage.getItem("com.sploder.3deditor.history")?this.importHistory(localStorage.getItem("com.sploder.3deditor.history")):this.import("==527,0,-18,-18,36,36,[[@,80]]|509,0,-16,-16,32,32,[[@,64,84,@,@,@,@,@,@,@,@,50,7]]|510,0,-7,-6,14,12,[[@,55],[@,68]]|526,2,-7,-6,14,12,[[@,60]]|532,0,-3,-6,6,9,[[@,63]]|521,0,-7,6,14,2,[[@,63]]|518,0,-7,-10,14,2,[[@,66]]|520,0,-7,8,14,2,[[@,66]]|524,0,-7,-8,14,2,[[@,63]]|517,0,9,-6,2,12,[[@,66]]|522,0,7,-6,2,12,[[@,63]]|523,0,-9,-6,2,12,[[@,63]]|519,0,-11,-6,2,12,[[@,66]]|514,0,7,-10,4,4,[[@,84]]|515,0,-11,6,4,4,[[@,84]]|516,0,7,6,4,4,[[@,84]]|511,0,-11,-10,4,4,[[@,84]]|512,5,13,0,0,0,[[@,72,@,@,@,34,35,36]]|513,6,0,0,0,0,[[@,64]]~==1,1,-46,-2,12,4,0,1,2,0,1,0,0,0,0,0|2,2,-28,-2,12,4,0,2,5,4,0,1,1,1,3,6,1,3,2|3,3,8,-4,12,4,0,1,11,0,1,0,2,2|6,3,0,9,12,4,0,0,3,0,0|4,4,-16,9,10,4,0,1,6,0,1,0,0,5,0,3,3|5,5,-7,-4,8,4,0,1,3,0,1,0,1,12,0,1,3|11,6,4,2,4,4,0,1,5,1,1,,,3~"),this},this.registerModel=function(e){e.bookmarked.add(this.handleBookmark,this),o[e.id]=e},this.getModelById=function(e){return o[e]},this.copyToClipboard=function(){for(var e,t=o.length;t--;)if((e=o[t])&&"hasSelection"in e&&e.hasSelection())return l=e.copySelectionAsClipboard(),this.changed.dispatch(l.modelId),!0;return!1},this.pasteFromClipboard=function(e){if(l.modelId&&l.data){var t=this.getModelById(l.modelId),t,i,s,o,n;if(t)return t=t.pasteSelectionFromClipboard(l),exportHistory,t&&e&&(i=l.bounds.x+.5*l.bounds.width,s=l.bounds.y+.5*l.bounds.height,o=Math.floor(e.x-i),n=Math.floor(e.y-s),t.forEach(function(e){e.x+=o,e.y+=n})),!0}return!1},this.handleBookmark=function(e){this.saveUndo(e)},this.saveUndo=function(e){var t=o[e],t;t&&(t=t.serialize(),n.length&&n[0]==t||(n.unshift(t),r.unshift(e),24<n.length&&(n.pop(),r.pop()),a=[],h=[],this.changed.dispatch(e),localStorage&&localStorage.setItem("com.sploder.3deditor.history",this.exportHistory())))},this.saveAll=function(){for(var e=0;e<o.length;e++)this.saveUndo(e);console.log("SAVED ALL MODELS")},this.restoreUndo=function(){var e,t,i,e;n.length&&r.length&&(t=r[0],i=o[t])&&(e=i.serialize(),n[0]==e&&(n.shift(),r.shift()),n.length&&r.length&&(a.unshift(e),h.unshift(t),e=n.shift(),t=r.shift(),i=o[t])&&(i.restoreUndo(e),this.changed.dispatch(t)),localStorage)&&localStorage.setItem("com.sploder.3deditor.history",this.exportHistory())},this.redo=function(){var e,t,i,s;a.length&&(e=a.shift(),t=h.shift(),i=o[t])&&(s=i.serialize(),n.unshift(s),r.unshift(t),i.redo(e),this.changed.dispatch(t),localStorage)&&localStorage.setItem("com.sploder.3deditor.history",this.exportHistory())},this.restoreModelFromString=function(e,t){var t=o[t];t&&t.redo(e)},this.export=function(){for(var e="",t=0;t<o.length;t++)o[t]&&(e+=o[t].serialize()),t!=o.length-1&&(e+="==");return e.split("NaN,").join(",")},this.import=function(e){for(var t=e.split("=="),i=0;i<o.length;i++)o[i]&&t[i]&&(console.log(o[i]),o[i].unserialize(t[i]))},this.exportHistory=function(){return(n.join("==")+"```"+r.join("==")+"```"+a.join("==")+"```"+h.join("==")).split("NaN,").join(",")},this.importHistory=function(e){var e=e.split("```");n=e[0].split("=="),r=e[1].split("=="),SPLODER.parseFloatArray(r),a=e[2].split("=="),h=e[3].split("=="),SPLODER.parseFloatArray(h)},this.restore=function(){for(var e=[],t=0;t<n.length;t++){var i=r[t];-1==e.indexOf(i)&&(e.push(i),this.restoreModelFromString(n[t],r[t]))}}},SPLODER.FlowNode=function(e,t,i,s,o){SPLODER.Rect.call(this,e,t,i,s,o),this.flowId=0,this.verb="",this.target="",this.amount=0,this.operator="";var n=[];this.children=[],this.childrenTerminal=[],this.defaults=SPLODER.FlowNode.defaultsByType[this.type],this.addChild=function(e,t){-1==this.children.indexOf(e)&&(t=t||0,this.children.push(e),this.childrenTerminal.push(t))},this.removeChild=function(e){var e=this.children.indexOf(e);-1!=e&&(this.children.splice(e,1),this.childrenTerminal.splice(e,1))},this.getAttrib=function(e){return n?isNaN(n[e])?this.defaults&&!isNaN(this.defaults[e])?this.defaults[e]:0:n[e]:-1},this.setAttrib=function(e,t){n&&(n[e]=t)},this.getAttribs=function(){return n},this.clone=function(){var e=new SPLODER.FlowNode(this.type,this.x,this.y,this.width,this.height);return e.id=this.id,e.flowId=this.flowId,e.init().unserialize(this.serialize())},this.serialize=function(){return SPLODER.Rect.prototype.serialize.call(this)+","+[this.flowId,this.children.length].concat(this.children,this.childrenTerminal,n).join(",")},this.unserialize=function(e,t){SPLODER.Rect.prototype.unserialize.call(this,e,t);for(var i=e.split(",").slice(6),s=i.length;s--;)i[s]=parseFloat(i[s]);this.flowId=i.shift();var t=i.shift();t?(this.children=i.slice(0,t),this.childrenTerminal=i.slice(t,t+t)):(this.children=[],this.childrenTerminal=[]),isNaN(this.flowId)&&(this.flowId=0),n=i.slice(2*t)||[],this.defaults=SPLODER.FlowNode.defaultsByType[this.type]},this.toString=function(e,t){if(!e)return"no model found";t=t||0;var i=[],s=SPLODER.FlowNode.typeVerbStrings[this.type],o=this.getAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE),n=this.getAttrib(SPLODER.FlowNode.PROPERTY_OPERATOR),a=this.getAttrib(SPLODER.FlowNode.PROPERTY_TARGET_TYPE),r=this.getAttrib(SPLODER.FlowNode.PROPERTY_TARGET),h=(this.type==SPLODER.FlowNode.TYPE_CONDITION&&o<=5&&(n=0),s&&i.push(s),o&&i.push(SPLODER.FlowNode.subtypeStrings[this.type][o]),n&&i.push(SPLODER.FlowNode.operatorStrings[n]),a&&i.push(SPLODER.FlowNode.targetTypeStrings[a]),a!=SPLODER.FlowNode.TARGET_TYPE_NONE&&void 0!==r&&(this.type==SPLODER.FlowNode.TYPE_ACTION&&a==SPLODER.FlowNode.TARGET_TYPE_NUMBER&&0<=r&&(r="+"+r),i.push(r)),i.concat());if(this.type==SPLODER.FlowNode.TYPE_LOOP)this.children.length&&(i.push("FROM INSTRUCTION"),i.push('"'+e.getItemById(this.children[0]).toString(e,t+999)+'"'));else if(t<24)for(var l=0;l<this.children.length;l++){var E="",d=null,R="",E=this.type==SPLODER.FlowNode.TYPE_TRIGGER?0==this.childrenTerminal[l]?", then with object A (self):":", then with object B:":0==this.childrenTerminal[l]?", then":this.type==SPLODER.FlowNode.TYPE_TRIGGER?", then with B":", "+h.join(" ").split("IF ").join("OTHERWISE IF NOT (")+"), then",d;(d=e.getItemById(this.children[l]))&&(R=d.toString(e,t+1))&&(i.push(E),i.push(R))}return i.join(" ").split("  ").join(" ").split(" , ").join(", ")}},SPLODER.FlowNode._nextId=1,SPLODER.FlowNode.SCOPE_GAME=0,SPLODER.FlowNode.SCOPE_SECTOR=1,SPLODER.FlowNode.SCOPE_PANEL=2,SPLODER.FlowNode.SCOPE_ITEM=3,SPLODER.FlowNode.SCOPE_BIPED=4,SPLODER.FlowNode.TYPE_TRIGGER=1,SPLODER.FlowNode.TYPE_CONDITION=2,SPLODER.FlowNode.TYPE_ACTION=3,SPLODER.FlowNode.TYPE_CONTEXT=4,SPLODER.FlowNode.TYPE_DELAY=5,SPLODER.FlowNode.TYPE_LOOP=6,SPLODER.FlowNode.typeStrings=["","event","condition","action","context","delay","loop"],SPLODER.FlowNode.PROPERTY_SUBTYPE=0,SPLODER.FlowNode.PROPERTY_OPERATOR=1,SPLODER.FlowNode.PROPERTY_TARGET_TYPE=2,SPLODER.FlowNode.PROPERTY_TARGET=3,SPLODER.FlowNode.TRIGGER_EVERYFRAME=1,SPLODER.FlowNode.TRIGGER_START=2,SPLODER.FlowNode.TRIGGER_COLLISION=3,SPLODER.FlowNode.TRIGGER_CRUSH=4,SPLODER.FlowNode.TRIGGER_ENTER=5,SPLODER.FlowNode.TRIGGER_EXIT=6,SPLODER.FlowNode.TRIGGER_EMPTY=7,SPLODER.FlowNode.TRIGGER_NEAR=8,SPLODER.FlowNode.TRIGGER_SEE=9,SPLODER.FlowNode.TRIGGER_TEXT=10,SPLODER.FlowNode.TRIGGER_STATE_CHANGED=10,SPLODER.FlowNode.TRIGGER_HEALTH_CHANGED=11,SPLODER.FlowNode.TRIGGER_PLAYER_SCORED=12,SPLODER.FlowNode.TRIGGER_ITEM_PICKED_UP=13,SPLODER.FlowNode.TRIGGER_ITEM_DESTROYED=14,SPLODER.FlowNode.CONDITION_TOUCHING=1,SPLODER.FlowNode.CONDITION_HAS=2,SPLODER.FlowNode.CONDITION_CONTAINS=3,SPLODER.FlowNode.CONDITION_TAG_MATCHES=4,SPLODER.FlowNode.CONDITION_STATE_MATCHES=5,SPLODER.FlowNode.CONDITION_PROPERTY_HEALTH=6,SPLODER.FlowNode.CONDITION_PROPERTY_STRENGTH=7,SPLODER.FlowNode.CONDITION_PROPERTY_RANGE=8,SPLODER.FlowNode.CONDITION_PROPERTY_ARMOR=9,SPLODER.FlowNode.CONDITION_PROPERTY_MEMORY=10,SPLODER.FlowNode.CONDITION_PROPERTY_SCORE=11,SPLODER.FlowNode.ACTION_GOTO_STATE=1,SPLODER.FlowNode.ACTION_ALLOW=2,SPLODER.FlowNode.ACTION_DISALLOW=3,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_HEALTH=4,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_STRENGTH=5,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_RANGE=6,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_ARMOR=7,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_MEMORY=8,SPLODER.FlowNode.ACTION_SPAWN_ITEM=9,SPLODER.FlowNode.ACTION_TELEPORT=10,SPLODER.FlowNode.ACTION_PICKUP=11,SPLODER.FlowNode.ACTION_DROP=12,SPLODER.FlowNode.ACTION_SHOW_TEXT=13,SPLODER.FlowNode.ACTION_SOLID_OFF=14,SPLODER.FlowNode.ACTION_SOLID_ON=15,SPLODER.FlowNode.ACTION_DESTROY=16,SPLODER.FlowNode.ACTION_LOSE_GAME=17,SPLODER.FlowNode.ACTION_WIN_GAME=18,SPLODER.FlowNode.ACTION_FOLLOW=19,SPLODER.FlowNode.ACTION_ATTACK=20,SPLODER.FlowNode.ACTION_FLEE=21,SPLODER.FlowNode.ACTION_GUARD=22,SPLODER.FlowNode.CONTEXT_SUBJECT=1,SPLODER.FlowNode.DELAY_WAIT=1,SPLODER.FlowNode.LOOP_REPEAT=1,SPLODER.FlowNode.OPERATOR_NONE=0,SPLODER.FlowNode.OPERATOR_EQUALS=1,SPLODER.FlowNode.OPERATOR_NOTEQUALS=2,SPLODER.FlowNode.OPERATOR_GREATERTHAN=3,SPLODER.FlowNode.OPERATOR_LESSTHAN=4,SPLODER.FlowNode.TARGET_TYPE_NONE=0,SPLODER.FlowNode.TARGET_TYPE_NUMBER=1,SPLODER.FlowNode.TARGET_TYPE_STATE=2,SPLODER.FlowNode.TARGET_TYPE_TAG=3,SPLODER.FlowNode.TARGET_TYPE_TEXT=4,SPLODER.FlowNode.TAG_ANY=0,SPLODER.FlowNode.TAG_PLAYER=-1,SPLODER.FlowNode.TAG_GROUP_GOOD=-2,SPLODER.FlowNode.TAG_GROUP_BAD=-3,SPLODER.FlowNode.rectWidths=[12,12,12,12,10,8,4],SPLODER.FlowNode.typeVerbStrings=["","ON","IF","","","","REPEAT"],SPLODER.FlowNode.subtypeStrings=[[""],["","frame","start","collision","crush","enter sector","exit sector","sector empty","near","see","text button","state changed","health changed","player scored","item picked up","item destroyed"],["","tagged","state is","picked up","contains","touching","health","strength","range","armor","memory","score"],["","goto","allow","disallow","health","strength","range","armor","memory","spawn item","teleport to","pick up","drop","show text","solid off","solid on","self-destruct","lose game","win game","follow","attack","flee","guard"],["","TELL A","TELL B","TELL"],["","WAIT"],["","LOOP"]],SPLODER.FlowNode.subtypeTargetTypes=(()=>{var e=SPLODER.FlowNode.TARGET_TYPE_NONE,t=SPLODER.FlowNode.TARGET_TYPE_NUMBER,i=SPLODER.FlowNode.TARGET_TYPE_STATE,s=SPLODER.FlowNode.TARGET_TYPE_TAG,o;return[[e],[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],[e,s,i,s,s,s,t,t,t,t,t,t],[e,i,e,e,t,t,t,t,t,s,s,s,s,SPLODER.FlowNode.TARGET_TYPE_TEXT,e,e,e,e,e,s,s,s,s],[e,e,e,s],[e,t],[e,t]]})(),SPLODER.FlowNode.triggerTerminals=[0,1,1,2,2,2,2,1,2,2,1,1,2,1,1,1],SPLODER.FlowNode.triggerTypesByScope=[[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0]],SPLODER.FlowNode.actionTypesByScope=[[0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0],0,[0,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,0,0,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,0,0,1,1,1,0,0,0,0,1,1,1,1]],SPLODER.FlowNode.operatorStrings=["","equal to","not equal to","greater than","less than"],SPLODER.FlowNode.operatorSymbols=["","==","!=",">","<"],SPLODER.FlowNode.targetTypeStrings=["","","state","tag"],SPLODER.FlowNode.tagStrings=["any","player","good group","evil group"],SPLODER.FlowNode.defaults=[],SPLODER.FlowNode.defaultsByType=[],(e=>{e.defaults[e.PROPERTY_SUBTYPE]=1,e.defaults[e.PROPERTY_OPERATOR]=SPLODER.FlowNode.OPERATOR_NONE,e.defaults[e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NUMBER,e.defaults[e.PROPERTY_TARGET]=1;for(var t=e.TYPE_TRIGGER;t<=e.TYPE_LOOP;t++)e.defaultsByType[t]=e.defaults.concat();e.defaultsByType[e.TYPE_TRIGGER][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.CONDITION_TOUCHING,e.defaultsByType[e.TYPE_TRIGGER][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NONE,e.defaultsByType[e.TYPE_TRIGGER][e.PROPERTY_TARGET]=0,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.CONDITION_TOUCHING,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_OPERATOR]=SPLODER.FlowNode.OPERATOR_EQUALS,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_TAG,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_TARGET]=SPLODER.FlowNode.TAG_ANY,e.defaultsByType[e.TYPE_ACTION][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.ACTION_GOTO_STATE,e.defaultsByType[e.TYPE_ACTION][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_STATE,e.defaultsByType[e.TYPE_ACTION][e.PROPERTY_TARGET]=1,e.defaultsByType[e.TYPE_CONTEXT][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.CONTEXT_SUBJECT,e.defaultsByType[e.TYPE_CONTEXT][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_TAG,e.defaultsByType[e.TYPE_CONTEXT][e.PROPERTY_TARGET]=SPLODER.FlowNode.TAG_PLAYER,e.defaultsByType[e.TYPE_DELAY][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.DELAY_WAIT,e.defaultsByType[e.TYPE_DELAY][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NUMBER,e.defaultsByType[e.TYPE_DELAY][e.PROPERTY_TARGET]=3,e.defaultsByType[e.TYPE_LOOP][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.LOOP_REPEAT,e.defaultsByType[e.TYPE_LOOP][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NUMBER,e.defaultsByType[e.TYPE_LOOP][e.PROPERTY_TARGET]=0})(SPLODER.FlowNode),SPLODER.FlowStore=function(){SPLODER.Store.call(this);var t=this,i=0;Object.defineProperty(this,"flowId",{get:function(){return i},set:function(e){isNaN(e)||(i=e,t.selection=[],t.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE))}}),this.ItemClass=SPLODER.FlowNode,this.getItemsUnderPoint=function(e,t,i,s,o,n){i=i||0;for(var a,r=(s=s||this.items).length,h=o?[]:null;r--;)if(a=s[r],(null==n||a.type===n)&&a.flowId==this.flowId&&e>=a.x-i&&t>=a.y-i&&e<=a.x+a.width+i&&t<=a.y+a.height+i){if(!o)return a;h.push(a)}return h},this.onAction=function(e){if(e){var t,i,s,o,n,a,r,h,l,E,d,R,P,c=e[0];switch(c){case SPLODER.ACTION_DESELECT:this.selection.length&&(this.saveUndo(),this.selection=[],this.changed.dispatch(c));break;case SPLODER.ACTION_SELECT_POINT:var i=e[1],s=e[2],R=e[3],u,E=this.getItemUnderPoint(i,s,0,null,e[4]),o=this.selection;if(E&&1<E.length){this.saveUndo(),this.selection=E}else{if(r=E){var O=5;if(5<i-r.x&&5<s-r.y&&5<r.x+r.width-i&&5<r.y+r.height-s)return this.itemIsSelected(r)&&(this.saveUndo(),this.selection=[]),void this.changed.dispatch(SPLODER.ACTION_DESELECT)}R?r&&!this.itemIsSelected(r)?(this.saveUndo(),o.push(r),SPLODER.ShapeUtils.sortByAreaDesc(o)):r||o.length&&(this.saveUndo(),this.selection=[]):r&&!this.itemIsSelected(r)?(this.saveUndo(),this.selection=[r]):o.length&&(this.saveUndo(),this.selection=[])}this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECT_ITEM:e[1]instanceof SPLODER.Item&&(this.selection=[this.getItemById(e[1].id)],this.changed.dispatch(c,this.selection));break;case SPLODER.ACTION_SELECT_WINDOW:r=e[1],this.selection=this.getItemsIntersectingRect(r.x,r.y,r.width,r.height),SPLODER.ShapeUtils.sortByAreaDesc(this.selection),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECT_ALL:this.saveUndo(),this.selection=this.items.concat(),SPLODER.ShapeUtils.sortByAreaDesc(this.selection),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECTION_START:this.saveUndo();break;case SPLODER.ACTION_SELECTION_MOVE:for(t=this.selection.length;t--;)this.selection[t].x+=e[1],this.selection[t].y+=e[2];this.updateBounds(),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECTION_DUPLICATE:for(this.saveUndo(),o=this.selection,this.selection=[],n=this.duplicatedItems=[],t=o.length;t--;)h=o[t],(l=this.addItem()).unserialize(h.serialize(),!0),l.flowId=this.flowId,n.unshift(h),this.selection.unshift(l);SPLODER.FlowStore.remapNodeConnections(n,this.selection),this.updateBounds(),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECTION_RELEASE:(o=this.selection.concat(),n=this.duplicatedItems,o.length&&n.length&&o[0].x==n[0].x&&o[0].y==n[0].y&&o[0].width==n[0].width&&o[0].height==n[0].height)?(this.saveUndo(),this.deleteSelection(),this.duplicatedItems=[],this.changed.dispatch(SPLODER.ACTION_SELECTION_DELETE,o)):(n.length&&this.changed.dispatch(c,o),this.duplicatedItems=[]);break;case SPLODER.ACTION_SELECTION_DELETE:this.selection.length&&(o=this.selection.concat(),this.saveUndo(),this.deleteSelection(),this.changed.dispatch(c,o));break;case SPLODER.ACTION_CREATE:this.saveUndo(),E=e[1],d=e[2],R=e[3],P=e[4],(l=this.addItem(E,i=e[5],s=e[6],e[7],e[8])).flowId=this.flowId;var L=SPLODER.FlowNode.subtypeTargetTypes[E][d];l.setAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE,d),l.setAttrib(SPLODER.FlowNode.PROPERTY_OPERATOR,R),l.setAttrib(SPLODER.FlowNode.PROPERTY_TARGET_TYPE,L),l.setAttrib(SPLODER.FlowNode.PROPERTY_TARGET,P),this.selection=[l],this.changed.dispatch(c,this.selection[0]);break;case SPLODER.ACTION_CHANGE:var a=e[1],S=e[2],T=e[3];for(o=-1==a?this.selection:[r=this.getItemById(a)],t=0;t<o.length;t++){var r,d=(r=o[t]).getAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE),L=SPLODER.FlowNode.subtypeTargetTypes[r.type][d];switch(S){case SPLODER.FlowNode.PROPERTY_SUBTYPE:var D=SPLODER.FlowNode.subtypeStrings[r.type].length-1;SPLODER.incrementAttrib(r,S,T,1,D,0),d=r.getAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE),L=SPLODER.FlowNode.subtypeTargetTypes[r.type][d],isNaN(L)||r.setAttrib(SPLODER.FlowNode.PROPERTY_TARGET_TYPE,L);break;case SPLODER.FlowNode.PROPERTY_OPERATOR:r.type==SPLODER.FlowNode.TYPE_CONDITION&&SPLODER.incrementAttrib(r,S,T,0,4,0);break;case SPLODER.FlowNode.PROPERTY_TARGET_TYPE:SPLODER.incrementAttrib(r,S,T,0,3,0);break;case SPLODER.FlowNode.PROPERTY_TARGET:var D=0;L==SPLODER.FlowNode.TARGET_TYPE_TAG?D=-7:L==SPLODER.FlowNode.TARGET_TYPE_STATE&&(D=1),r.type==SPLODER.FlowNode.TYPE_ACTION&&L==SPLODER.FlowNode.TARGET_TYPE_NUMBER&&(D=-99),SPLODER.incrementAttrib(r,S,T,D,99,0)}}this.updateBounds(),this.changed.dispatch(c,o,S);break;case SPLODER.ACTION_CHANGE_COMPLETE:a=e[1],r=this.getItemById(a),this.changed.dispatch(c,r);break;case SPLODER.ACTION_CONNECT:var i=this.getItemById(e[1]),s=this.getItemById(e[2]);i&&s&&i.addChild(s.id,e[3]),this.changed.dispatch(c,i);break;case SPLODER.ACTION_DISCONNECT:r=this.getItemById(e[1]);var m=e[2];if(r)if(2==m)for(t=this.items.length;t--;)this.items[t].removeChild(r.id);else for(t=r.children.length;t--;)r.childrenTerminal[t]==m&&r.removeChild(r.children[t]);this.changed.dispatch(c,r)}}}},SPLODER.FlowStore.prototype=Object.create(SPLODER.Store.prototype),SPLODER.FlowStore.prototype.constructor=SPLODER.FlowStore,SPLODER.FlowStore.remapNodeConnections=function(e,t){if(t&&e)for(var i,s,o,n,a=e.length,r=function(e,t){for(var i=e.length;i--;)if(e[i]&&e[i].id==t)return i;return-1};a--;)if(e[a]&&t[a]&&(i=e[a],s=t[a],i)&&s&&i.children.length)for(o=i.children.length;o--;)-1!=(n=r(e,i.children[o]))&&(console.log("remapping node child id",s.children[o],t[n].id),s.children[o]=t[n].id)},SPLODER.FlowStore.prototype.pasteSelectionFromClipboard=function(e){if(e&&e.data){for(var t,i=e.data.split("|"),s=[],t=0;t<i.length;t++)(item=this.addItem()).unserialize(i[t]),s.push(item);var o=SPLODER.Store.prototype.pasteSelectionFromClipboard.apply(this,arguments);for(t=o.length;t--;)o[t].flowId=this.flowId,o[t].x+=1,o[t].y+=1;SPLODER.FlowStore.remapNodeConnections(s,o)}},SPLODER.TagModel=function(){this.id=null,this.changed=null,this.bookmarked=null;var o=[],s=this,e=7,t=(this.init=function(){this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++;for(var e=-7;e<=64;e++)o[e+7]=[];return this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.initWithData=function(e){this.init(),t(e)},this.setTag=function(e,t,i){isNaN(e)||isNaN(t)||(i?-1==o[e+7].indexOf(t)&&(o[e+7].push(t),this.changed.dispatch(SPLODER.ACTION_CHANGE,e,t)):-1!=o[e+7].indexOf(t)&&(o[e+7].splice(o[e+7].indexOf(t),1),this.changed.dispatch(SPLODER.ACTION_CHANGE,e,t)))},this.getTags=function(s){return o.reduce(function(e,t,i){return-1!=t.indexOf(s)&&e.push(i-7),e},[])},this.hasTag=function(e,t){return!isNaN(e)&&!isNaN(t)&&-1!=o[e+7].indexOf(t)},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){t(e),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){t(e),this.changed.dispatch(SPLODER.ACTION_REDO)},this.serialize=function(){for(var e=[],t=-7;t<=64;t++)e[t+7]=o[t+7].join(",");return e.join("|")},function(e){for(var t=e.split("|"),i=-7;i<=64;i++)o[i+7]=t[i+7]?SPLODER.parseFloatArray(t[i+7].split(",")):[];s.changed.dispatch(SPLODER.ACTION_CHANGE)});this.onAction=function(e){var t,i,s,o;e&&e[0]===SPLODER.ACTION_CHANGE&&(i=e[1],this.setTag(e[2],i,e[3]),this.saveUndo())}},SPLODER.GamePhysics={},SPLODER.GamePhysics.bufferA=[],SPLODER.GamePhysics.rayCast2d=function(e,t,i,s,o,n){for(var a,r,h,l=t.x/s,E=t.y/s,d=i.x/s,R=i.y/s,t=Math.min(l,d),i=Math.min(E,R),s=Math.abs(l-d),P=Math.abs(E-R),c=e.getItemsIntersectingRect(t,i,s,P),u=[],O=c.length,L=!1;O--;)if(a=c[O],(!o||a.type==o)&&(r=SPLODER.Geom.rectIntersectsLine(a,l,E,d,R)))for(var S=0;S<r.length;S++)h=r[S],u.push({rect:a,pt:h,dist:Math.floor(10*SPLODER.Geom.distanceBetween(l,E,h.x,h.y))/10,area:a.area()}),n&&a==n&&(L=!0);if(u.sort(function(e,t){return e.dist>t.dist?1:e.dist<t.dist||e.area>t.area?-1:e.area<t.area?1:0}),n&&L)for(O=u.length;O--;)if(u[O].rect==n){u.splice(O+1,u.length-O);break}return u},SPLODER.GamePhysics.rayCast3d=function(e,t,i,s,o,n){var a={x:t.x,y:t.z},r={x:i.x,y:i.z};s=s||32;for(var h,l,E,d,R,P=SPLODER.GamePhysics.rayCast2d(e,a,r,s,o,n),c=new THREE.Vector3,u=SPLODER.Geom.distanceBetweenXZ(t,i),O=[],L=0;L<P.length;L++)h=P[L],c.copy(t),c.lerp(i,h.dist*s/u),E=c.y/(.5*s),d=(l=h.rect).getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),R=l.getAttrib(SPLODER.Item.PROPERTY_CEIL)?l.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):128,(l.type==SPLODER.Item.TYPE_WALL&&(E<=d||R<=E)||l.type==SPLODER.Item.TYPE_LIQUID&&E<=d||l.type==SPLODER.Item.TYPE_PLATFORM&&d<E&&E<R)&&O.push(h);return O},SPLODER.GamePhysics.rayCast3db=function(e,t,i,s){var o,n,a,r={x:t.x/(s=s||32),y:t.z/s},h={x:i.x/s,y:i.z/s},l=SPLODER.Geom.gridPointsAlongLine(Math.floor(r.x),Math.floor(r.y),Math.floor(h.x),Math.floor(h.y)),E=e.getItemsIntersectingRect(Math.min(r.x,h.x),Math.min(r.y,h.y),Math.abs(h.x-r.x),Math.abs(h.y-r.y)),d=new THREE.Vector3,R=SPLODER.Geom.distanceBetweenXZ(t,i),P=[],c=.5,u=.5;h.x<r.x&&(c=-.5),h.y<r.y&&(u=-.5);for(var O=0;O<l.length;O+=2){o={x:l[O],y:l[O+1]},a=SPLODER.Geom.distanceBetween(r.x,r.y,o.x+.5,o.y+.5),d.copy(t),d.lerp(i,a*s/R);var n=d.y/(.5*s),n=SPLODER.GamePhysics.checkHitAtGridPoint(o.x,o.y,n,E);n&&n.length&&P.push({rect:n[0],pt:o,dist:a,area:n[0].area(),offsetX:c,offsetY:u})}return P},SPLODER.GamePhysics.checkHitAtGridPoint=function(e,t,i,s){var o,n,a,r,h,l=[];if(s){SPLODER.ShapeUtils.sortByAreaDesc(s);for(var E,d=s.length;d--;)if(!((E=s[d]).x>e||E.x+E.width<=e||E.y>t||E.y+E.height<=t))switch(o=E.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=E.getAttrib(SPLODER.Item.PROPERTY_CEIL)?E.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):128,E.type){case SPLODER.Item.TYPE_WALL:!a&&(i<=o||n<=i)&&l.push(E),a=!0;break;case SPLODER.Item.TYPE_PLATFORM:!r&&o<i&&i<n&&l.push(E),r=!0;break;case SPLODER.Item.TYPE_LIQUID:!h&&E.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR)&&i<=o&&l.push(E),h=!0}}return l},SPLODER.GamePhysics.pointInWallCheck=function(e,t){var i=t.y/16,e=e.getItemsUnderPoint(Math.floor(t.x/32)+.5,Math.floor(t.z/32)+.5,0,!1,!1,SPLODER.Item.TYPE_WALL);return e&&(e.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)>i-1||e.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)<1+i)},SPLODER.GamePhysics.gravityStateCheck=function(e,t,i){var s=16,e=e.getItemsUnderPoint(t.x/32,t.z/32,0,e.items,!1,SPLODER.Item.TYPE_LIQUID);if(e){var e=e.getAttrib(SPLODER.Item.PROPERTY_LIQUIDLEVEL);if(t.y-32<=16*e)return i&&t.y-8<=16*e&&(t.y+=1),SPLODER.GamePhysics.GRAVITY_SWIM;if(t.y-48<=16*e)return SPLODER.GamePhysics.GRAVITY_FLOAT}return SPLODER.GamePhysics.GRAVITY_STANDARD},SPLODER.GamePhysics.GRAVITY_STANDARD=0,SPLODER.GamePhysics.GRAVITY_FLOAT=1,SPLODER.GamePhysics.GRAVITY_SWIM=2,SPLODER.GamePhysics.elevationCheck=function(e,t,i,s,o,n){var e,a,r,h,l,E,a=i.clone().divideScalar(32),d=16,R=e.getItemsIntersectingRect(a.x-s-1,a.z-s-1,2*s+2,2*s+2),P=(SPLODER.ShapeUtils.sortByAreaDesc(R),[e.getItemsUnderPoint(a.x,a.z,0,R,!1,SPLODER.Item.TYPE_PLATFORM)]),c=(0<s&&P.push(e.getItemsUnderPoint(a.x+s,a.z+s,0,R,!1,SPLODER.Item.TYPE_PLATFORM),e.getItemsUnderPoint(a.x+s,a.z-s,0,R,!1,SPLODER.Item.TYPE_PLATFORM),e.getItemsUnderPoint(a.x-s,a.z+s,0,R,!1,SPLODER.Item.TYPE_PLATFORM),e.getItemsUnderPoint(a.x-s,a.z-s,0,R,!1,SPLODER.Item.TYPE_PLATFORM)),[]);if(P)for(E=P.length;E--;)(r=P[E])&&(h=16*r.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),l=16*r.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),h-16<=t?c.push({rect:r,f:h,c:2048}):t<=h-l-16&&c.push({rect:r,f:0,c:l}));var u=[e.getItemsUnderPoint(a.x,a.z,0,R,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID)];if(0<s&&u.push(e.getItemsUnderPoint(a.x+s,a.z+s,0,R,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),e.getItemsUnderPoint(a.x+s,a.z-s,0,R,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),e.getItemsUnderPoint(a.x-s,a.z+s,0,R,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),e.getItemsUnderPoint(a.x-s,a.z-s,0,R,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID)),u)for(E=u.length;E--;)if(r=u[E]){if(h=16*r.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),l=r.getAttrib(SPLODER.Item.PROPERTY_CEIL)?16*r.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):1e4,r.type==SPLODER.Item.TYPE_LIQUID){if(!r.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR))continue;l=1e4}c.push({rect:r,f:h,c:l})}if(!c.length)return[-1e3,i.y+1e3,!1];if(c.sort(function(e,t){return e.f>t.f?-1:e.f<t.f?1:0}),e=c[0].f,c.sort(function(e,t){return e.c>t.c?1:e.c<t.c?-1:0}),(a=c[0].c)<e)return-1;if(o)return e+96<=t&&t<a-48?t:Math.min(e+160,Math.max(a-48,e+.5*(a-e)));var s=Math.max(e,Math.min(Math.max(e+160,i.y),a-48));if(!o&&e+160<s){var R=s-(e+160),o,a;if(n)return(o=a-48<=s)&&(i.y=a-48),(a=SPLODER.GamePhysics.bufferA)[0]=e+160,a[1]=R,a[2]=o,a}return n&&(i.y=s),s},SPLODER.GamePhysics._getCollisionRect=function(e,t,i,s){var o,n,a,r,o=i,n=s,a=1,r=1;return i<t.x?(o-=3,a+=3):i>t.x&&(a+=3),s<t.y?(n-=3,r+=3):s>t.y&&(r+=3),{type:e.type,id:e.id,x:o,y:n,width:a,height:r}},SPLODER.GamePhysics.collisionCheck=function(e,t,i,s,o){var n,a,t=t,r=t.y/16,h={x:Math.floor(t.x/32),y:Math.floor(t.z/32)},l={x:t.x/32,y:t.z/32},E={x:t.x/32,y:t.z/32},d=e.getItemsIntersectingRect(h.x-2,h.y-2,4,4);SPLODER.ShapeUtils.sortByAreaDesc(d);var R,P,c,u,O,L,S,T=[],P=e.getItemsUnderPoint(h.x+.5,h.y+.5,0,d,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),t;for(P&&(n=P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),a=P.type!=SPLODER.Item.TYPE_LIQUID?P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):1e3,r-1<n||a<1+r)&&(S=P),L=h.y-2;L<=h.y+2;L++)for(O=h.x-2;O<=h.x+2;O++)(P=e.getItemsUnderPoint(O+.5,L+.5,n=0,d,!(a=256),SPLODER.Item.TYPE_FILTER_WALL_LIQUID))&&(n=P.type!=SPLODER.Item.TYPE_LIQUID||P.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR)?P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH):-1e3,a=P.type!=SPLODER.Item.TYPE_LIQUID&&P.getAttrib(SPLODER.Item.PROPERTY_CEIL)?P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):256),O==h.x&&L==h.y||!(P&&(r-2<n||a<1+r)&&P!=S||((P=e.getItemsUnderPoint(O+.5,L+.5,0,d,!1,SPLODER.Item.TYPE_PLATFORM))&&(a=(n=P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH))-P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)),P&&2+r<n&&a<2+r)||(P=e.getItemsUnderPoint(O+.5,L+.5,0,d,!1,SPLODER.Item.TYPE_PANEL))&&(n=P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),a=P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),(c=n)<1+r)&&c+Math.max(2*P.width,2*P.height)>r-6)||T.push(SPLODER.GamePhysics._getCollisionRect(P,h,O,L));for(R=T.length;R--;)if(P=T[R],u=SPLODER.Geom.resolvePenetrationCircleRect(l,2,P,1),!o&&u)return!0;return!!o&&(t={x:NaN,y:t.y,z:NaN},1.5<Math.abs(l.x-E.x)||1.5<Math.abs(l.y-E.y)?(console.log("POP POP!",E.x,P,l.x,i.x/32),t.x=i.x,t.y=i.y,t.z=i.z):(l.x!=E.x&&(t.x=32*l.x),l.y!=E.y&&(t.z=32*l.y)),t)},SPLODER.Simple2dGL=function(){var n,a,s,o,e,t,i,r,h=(this.init=function(){return a=document.createElement("canvas"),n=(n=a.getContext("webgl"))||a.getContext("experimental-webgl"),this.resize(),h(),n.useProgram(r),E(),s=0,this},this.updateNumLights=function(e){s=e},function(){e=document.getElementById("fragmentShader_shadows").innerHTML,t=n.createShader(n.VERTEX_SHADER),n.shaderSource(t,SPLODER.Simple2dGL.defaultVertexSrc.join("\n")),n.compileShader(t),i=n.createShader(n.FRAGMENT_SHADER),n.shaderSource(i,e),n.compileShader(i),r=n.createProgram(),n.attachShader(r,t),n.attachShader(r,i),n.linkProgram(r)}),l=(this.resize=function(e,t){a.width=e||128,a.height=t||128,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight)},function(e,t,i,s,o){var n,s=t+s,a,o=i+o;e.bufferData(e.ARRAY_BUFFER,new Float32Array([t,i,s,i,t,o,t,o,s,i,s,o]),e.STATIC_DRAW)}),E=function(){var e=n.getAttribLocation(r,"aTextureCoord"),t=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,t),n.bufferData(n.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),n.STATIC_DRAW),n.enableVertexAttribArray(e),n.vertexAttribPointer(e,2,n.FLOAT,!1,0,0)};this.render=function(e){var t=n.getAttribLocation(r,"a_position"),i=n.createTexture(),i=(n.bindTexture(n.TEXTURE_2D,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),n.getUniformLocation(r,"dimensions")),i=(n.uniform2f(i,a.width,a.height),n.getUniformLocation(r,"numLights"));n.uniform1f(i,s||0),o=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,o),n.enableVertexAttribArray(t),n.vertexAttribPointer(t,2,n.FLOAT,!1,0,0),l(n,0,0,e.width,e.height),n.drawArrays(n.TRIANGLES,0,6)},this.copyToDataTexture=function(e){var t=a.width,i=a.height,s=new Uint8Array(4*t*i),o=n.createRenderbuffer(),o=(n.bindRenderbuffer(n.RENDERBUFFER,o),n.readPixels(0,0,t,i,n.RGBA,n.UNSIGNED_BYTE,s),n.bindRenderbuffer(n.RENDERBUFFER,null),e.image);o&&(o.width=t,o.height=i,o.data=s)}},SPLODER.Simple2dGL.defaultVertexSrc=["attribute vec2 a_position;","attribute vec2 aTextureCoord;","uniform vec2 dimensions;","varying vec2 vTextureCoord;","void main() {","vec2 zeroToOne = a_position / dimensions;","vec2 zeroToTwo = zeroToOne * 2.0;","vec2 clipSpace = zeroToTwo - 1.0;","gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);","vTextureCoord = aTextureCoord;","}"],SPLODER.Simple2dGL.defaultFragmentSrc=["precision highp float;","uniform sampler2D uSampler;","uniform vec2 dimensions;","varying vec2 vTextureCoord;","uniform float numLights;","void main() {","gl_FragColor = texture2D(uSampler, vTextureCoord);","}"],SPLODER.LightMap=function(){var T,D,m,p,f=(this.init=function(){return T=(new SPLODER.ImageMap).initWithDefaultValue(160),m=new THREE.Vector4(-16,-16,32,32),(D=new THREE.DataTexture(null,32,32,THREE.RGBAFormat,THREE.UnsignedByteType)).minFilter=D.magFilter=THREE.NearestFilter,this},function(e,t,i){return Math.pow(Math.max(0,1-i/e),t+1)}),g=function(e){var t,i,s,o,n=e.bounds.x-1,a=e.bounds.y-1,r=e.getItemsByType(SPLODER.Item.TYPE_LIGHT);for(p=[],t=0;t<r.length;t++){i=r[t],p[t]={x:i.x-n,y:i.y-a,color:new THREE.Color(SPLODER.Store.LIGHT_COLOR_CHOICES[i.getAttrib(SPLODER.Item.PROPERTY_COLOR)]),power:i.getAttrib(SPLODER.Item.PROPERTY_POWER)/255,space:16};var o=e.getItemUnderPoint(i.x,i.y,0,SPLODER.Item.TYPE_WALL);o&&(s=o.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),o=o.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),i.space=Math.max(0,o-s))}},y=function(e){return e--,e=(e=(e=(e=(e|=e>>1)|e>>2)|e>>4)|e>>8)|e>>16,++e},i=function(e){g(e);var t,i,e=e.bounds,s=y(e.width+2),o=y(e.height+2),e=(m.x=e.x-1,m.y=e.y-1,m.z=s,m.w=o,D.image.width=s,D.image.height=o,D.image.data=i=new Uint8Array(s*o*4),T.canvas),n=e.width,a=e.height;console.log(s,o);for(var r,h,l,E,d,d,R,P=new THREE.Color,c=new THREE.Color,u=new THREE.Color,O=new THREE.Color,L=0;L<a;L++)for(var S=0;S<n;S++){for(r=4*(L*n+S),h=4*(L*s+S),P.setHex(0),t=0;t<p.length;t++){var R,R,l,E=(l=p[t]).color,d;(d=SPLODER.Geom.distanceBetween(l.x,l.y,S,L))<64&&(u.setRGB(1,1,1),R=100/(l.power*l.power*1e3),R=f(80,R,d)*(1+5*l.power),u.multiplyScalar(R),d=Math.max(0,Math.min(1,I(l.x,l.y,S,L)/Math.max(16*l.space,1))),O.copy(u),O.multiplyScalar(d),E.r>E.b?c.setRGB(1,.7,.5):E.r<E.b?c.setRGB(.5,.7,1):c.setRGB(1,1,1),O.multiply(E),O.multiply(c),P.add(O),P.r=Math.max(0,Math.min(1,P.r)),P.g=Math.max(0,Math.min(1,P.g)),P.b=Math.max(0,Math.min(1,P.b)))}i[h]=Math.floor(255*P.r),i[1+h]=Math.floor(255*P.g),i[2+h]=Math.floor(255*P.b),i[3+h]=T.getData(S,L,1,1)}D.needsUpdate=!0},I=function(e,t,i,s){for(var o,n=SPLODER.Geom.gridPointsAlongLine(e,t,i,s),a=128,r=0;r<n.length;r+=2)if(0==(a=0<=(o=T.getData(n[r],n[r+1],1,0))?Math.min(a,o):a))return 0;return a};this.update=function(e,t){e&&t&&(T.updateBounds(e,1),g(e),T.update(e,null,1),i(e))},Object.defineProperty(this,"texture",{get:function(){return D}}),Object.defineProperty(this,"size",{get:function(){return m}})},SPLODER.ShaderLightMap=function(){var s,o,n,e,u,O,L,a=(this.init=function(){return s=(new SPLODER.ImageMap).initWithDefaultValue(160),n=new THREE.Vector4(-16,-16,32,32),(o=new THREE.DataTexture(null,32,32)).minFilter=o.magFilter=THREE.NearestFilter,L=(new SPLODER.Simple2dGL).init(),u=[0,0,new THREE.Color(0),100,0,12,new THREE.Color(16711680),70,12,0,new THREE.Color(65280),70],this},function(e){var t,i,s,o,n,a,r,h,l,E,i,d,R=e.bounds.x-1,P=e.bounds.y-1,c=e.getItemsByType(SPLODER.Item.TYPE_LIGHT);if(c)for(d=[],t=c.length;t--;)s=c[t],o=SPLODER.Store.LIGHT_COLOR_CHOICES[s.getAttrib(SPLODER.Item.PROPERTY_COLOR)],d.unshift(s.x,s.y,new THREE.Color(o),s.getAttrib(SPLODER.Item.PROPERTY_POWER));else d=u;for(L.updateNumLights(d.length/4),O=[],t=0;t<d.length;t+=4){var n=d[t]-R+1024,a=d[t+1]-P+1024,r=d[t+2],h=d[t+3],l=16,i=e.getItemUnderPoint(d[t],d[t+1],0,SPLODER.Item.TYPE_WALL);i&&(E=i.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),i=i.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),l=Math.max(0,i-E)),O[i=3*t]=n>>8&255,O[1+i]=255&n,O[2+i]=l,O[3+i]=255,O[4+i]=a>>8&255,O[5+i]=255&a,O[6+i]=h,O[7+i]=255,O[8+i]=Math.floor(255*r.r),O[9+i]=Math.floor(255*r.g),O[10+i]=Math.floor(255*r.b),O[11+i]=255}}),r=function(e){return e--,e=(e=(e=(e=(e|=e>>1)|e>>2)|e>>4)|e>>8)|e>>16,++e},t=function(e){a(e);var e=e.bounds,t=r(e.width+2),i=r(e.height+2);n.x=e.x-1,n.y=e.y-1,n.z=t,n.w=i,L.resize(s.canvas.width,s.canvas.height),L.render(s.canvas),L.copyToDataTexture(o),o.needsUpdate=!0};this.update=function(e){e&&(a(e),s.update(e,O,1),t(e))},Object.defineProperty(this,"texture",{get:function(){return o}}),Object.defineProperty(this,"size",{get:function(){return n}})},SPLODER.SceneModel=function(){this.model=null,this.shapes=null,this.shapesById=null,this.ceilingShapes=null,this.tilesize=32,this.tilesizeHalf=16,this.scene=null,this.renderer=null,this.sceneMeshes=null,this.sceneMeshesById=null,this.sceneUniforms=null,this.sceneUniformsById=null,this.sceneMeshesCameraAligned=null,this.light=null,this.camera=null,this.cameraDummy=null,this.cameraAngle=null,this.isDirty=!0,this.assets=null,this.lightMap=null,this.emptyArray=[]},SPLODER.SceneModel.prototype.initWithModelsAndSize=function(e,t,i,s){return this.model=e,this.envModel=t,this.assets=i,this.tilesize=s||32,this.tilesizeHalf=.5*this.tilesize,this.shapesById=[],this.sceneMeshes=[],this.sceneMeshesById=[],this.sceneUniforms=[],this.sceneUniformsById=[],SPLODER.ShapeUtils.errorOccured.add(this.onError),this},SPLODER.SceneModel.prototype.build=function(e){var e,e=(this.renderer=e,this.scene=new THREE.Scene,(e=new THREE.PointLight(16777215,1,2560)).position.y=1152,this.scene.add(e),this.envModel.getEnvs());e?this.setSkyColor(null,e[SPLODER.EnvModel.PROPERTY_SKY_COLOR]):console.log("ENVIRONMENT UNDEFINED")},SPLODER.SceneModel.prototype.watchModel=function(){this.model.changed.add(this.onModelChanged,this),this.envModel.changed.add(this.onEnvModelChanged,this),this.updateModel()},SPLODER.SceneModel.prototype.setAllUniforms=function(e,t){for(var i=this.sceneUniforms,s=i.length;s--;)(u=i[s])&&u.hasOwnProperty(e)&&(u[e].value=t)},SPLODER.SceneModel.prototype.onModelChanged=function(e,t,i){var s,o,n,a,r,h,l=this.sceneUniformsById,E=this.model.selection;if(e==SPLODER.ACTION_DESELECT)this.setAllUniforms("selected",0);else if(e==SPLODER.ACTION_CONTEXT_CHANGE&&(this.setDirty(),this.assets.setLightMapDirty()),t instanceof Array)switch(e){case SPLODER.ACTION_SET_CURRENTSTATE:if(o=t.length)for(;o--;)n=t[o],this.updateMeshPositionById(n.id),this.updateMeshTexturesById(n.id);else this.setDirty();console.log("state changed!");break;case SPLODER.ACTION_SELECT_ALL:case SPLODER.ACTION_SELECT_ITEM:case SPLODER.ACTION_SELECT_POINT:case SPLODER.ACTION_SELECT_WINDOW:for(this.setAllUniforms("selected",0),o=t.length;o--;)if(r=l[(n=t[o]).id])for(s=r.length;s--;)(a=r[s])&&a.selected&&(a.selected.value=1);break;case SPLODER.ACTION_TWEAK:if(i<SPLODER.Item.PROPERTY_HEALTH)for(o=t.length,this.removeMeshesById(t);o--;)n=t[o],this.buildMesh(n);else i==SPLODER.Item.PROPERTY_GRAVITY&&this.updateMeshPositionById(t[0].id);break;case SPLODER.ACTION_CHANGE:for(o=t.length;o--;)switch(n=t[o],r=l[n.id],i){case SPLODER.Item.PROPERTY_FLOORDEPTH:case SPLODER.Item.PROPERTY_CEILDEPTH:n.type==SPLODER.Item.TYPE_WALL||n.type==SPLODER.Item.TYPE_PANEL||n.type==SPLODER.Item.TYPE_ITEM?this.updateMeshPositionById(n.id):n.type==SPLODER.Item.TYPE_PLATFORM?this.updateRectMeshes(n,!0):n.type==SPLODER.Item.TYPE_LIQUID&&(this.updateMeshPositionById(n.id),this.updateVertexColorsIntersecting(n));case SPLODER.Item.PROPERTY_LIGHTLEVEL:case SPLODER.Item.PROPERTY_LIGHTEFFECT:case SPLODER.Item.PROPERTY_COLOR:case SPLODER.Item.PROPERTY_POWER:this.assets.setLightMapDirty();break;case SPLODER.Item.PROPERTY_TOPLEFT:case SPLODER.Item.PROPERTY_TOPRIGHT:case SPLODER.Item.PROPERTY_BOTTOMRIGHT:case SPLODER.Item.PROPERTY_BOTTOMLEFT:if(n.type==SPLODER.Item.TYPE_LIQUID&&this.updateVertexColorsIntersecting(n),1==t.length&&n.type>SPLODER.Item.TYPE_LIQUID)return this.removeMeshesById(t),void this.buildMesh(n);this.updateMeshesNear(E,!0);break;case SPLODER.Item.PROPERTY_FLOORTEXTURE:case SPLODER.Item.PROPERTY_CEILTEXTURE:case SPLODER.Item.PROPERTY_BOTTOMWALLTEXTURE:case SPLODER.Item.PROPERTY_BOTTOMWALLCORNICETEXTURE:case SPLODER.Item.PROPERTY_TOPWALLTEXTURE:case SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE:if(!(n.type<=SPLODER.Item.TYPE_ITEM))return this.removeMeshesById(t),void this.buildMesh(n);this.updateMeshTexturesById(n.id),n.type==SPLODER.Item.TYPE_LIQUID&&this.updateVertexColorsIntersecting(n);break;default:this.setDirty()}break;case SPLODER.ACTION_SELECTION_MOVE:if(1==E.length){if((h=E[0]).type==SPLODER.Item.TYPE_LIGHT)return void this.assets.setLightMapDirty();if(h.type>SPLODER.Item.TYPE_LIQUID)return this.removeMeshesById(h),void this.buildMesh(h)}for(this.updateMeshesNear(E,!0),s=E.length;s--;)(h=E[s])&&h.type==SPLODER.Item.TYPE_LIQUID&&this.updateVertexColorsIntersecting(h);break;case SPLODER.ACTION_SELECTION_DELETE:this.removeShapes(t),this.removeMeshesById(t),this.updateMeshesNear(t);break;default:this.setDirty()}else switch(e){case SPLODER.ACTION_CREATE:this.buildMesh(t),this.assets.setLightMapDirty();break;case SPLODER.ACTION_CHANGE_COMPLETE:t.type>SPLODER.Item.TYPE_LIQUID?(this.removeMeshesById(t),this.buildMesh(t)):this.updateMeshesNear([t]);break;default:this.setDirty()}},SPLODER.SceneModel.prototype.onEnvModelChanged=function(){console.log("ENV MODEL CHANGED",arguments);var e=this.envModel.getEnvs(),t=new THREE.Color;t.setHex(e[SPLODER.EnvModel.PROPERTY_SKY_COLOR]),this.setSkyColor(t)},SPLODER.SceneModel.prototype.setDirty=function(){this.isDirty=!0},SPLODER.SceneModel.prototype.hasObjectWithId=function(e){return null!=this.sceneMeshesById[e]},SPLODER.SceneModel.prototype.getFloorLevel=function(e,t){var i=this.tilesizeHalf,s=0,o=this.model.getItemsUnderPoint(e,t,0,null,!1,SPLODER.Item.TYPE_PLATFORM),n=(o&&(s=Math.max(s,o.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*i)),this.model.getItemsUnderPoint(e,t,0,null,!1,SPLODER.Item.TYPE_WALL)),e=(n&&(s=Math.max(s,n.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*i)),this.model.getItemsUnderPoint(e,t,0,null,!1,SPLODER.Item.TYPE_LIQUID));return e&&(s=Math.max(s,e.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*i-e.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)*i)),s=o||n||!this.camera?s:Math.floor(this.camera.position.y/i)},SPLODER.SceneModel.prototype.removeMeshesById=function(e,t){var i,s=(e=e instanceof Array?e:[e]).length,o=null;for(t&&(o=[]);s--;){var i=e[s].id,n=this.sceneMeshesById[i];if(n){for(var a,r,h=n.length;h--;)((a=n[h])instanceof THREE.Group||a instanceof THREE.Mesh)&&(-1!=(r=this.sceneMeshes.indexOf(a))&&this.sceneMeshes.splice(r,1),t&&(a instanceof THREE.Mesh?o.push(a.material):a.userData.biped&&(o=a.userData.biped.materials)),this.scene.remove(a),SPLODER.MeshUtils.destroyMesh(a,t));this.sceneMeshesById[i]=null,this.sceneUniformsById[i]=null}}return o},SPLODER.SceneModel.prototype.updateMeshPositionById=function(e,t){var i,s,o,n=this.sceneMeshesById[e];if(t=t||0,n)for(i=0;i<2;i++)if(n[s=i]){if(o=n[i].userData.rect,!t&&o.type==SPLODER.Item.TYPE_PLATFORM&&o.root!=o)return void this.updateMeshPositionById(o.root.id);this.updateMeshPosition(n[i],o,s)}if(o&&o.type<=SPLODER.Item.TYPE_PLATFORM&&(i=o.numChildren))for(var a=o.children;i--;)this.updateMeshPositionById(a[i].id,t+1)},SPLODER.SceneModel.prototype.updateMeshPosition=function(e,t,i){if(e&&t){var s,o,n=this.tilesize,a=this.tilesizeHalf,r=t.x,h=t.y,l=t.width,E=t.height,d=0,R=t.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),P=t.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH);switch(t.type){case SPLODER.Item.TYPE_WALL:i?this.placeMesh(e,t,r*n,Math.max(P,R)*a,h*n,90*Math.PI/180,-1):this.placeMesh(e,t,r*n,R*a,h*n,90*Math.PI/180);break;case SPLODER.Item.TYPE_PLATFORM:this.placeMesh(e,t,r*n,R*a,h*n,90*Math.PI/180);break;case SPLODER.Item.TYPE_LIQUID:i?this.placeMesh(e,t,r*n+.5*l*n,t.getAttrib(SPLODER.Item.PROPERTY_LIQUIDLEVEL)*a+.01,h*n+.5*E*n,-90*Math.PI/180):this.placeMesh(e,t,r*n,R*a,h*n,90*Math.PI/180);break;case SPLODER.Item.TYPE_PANEL:s=e.geometry.parameters.width,o=e.geometry.parameters.height,d=0,l<E&&(d=.5*Math.PI),this.placeMesh(e,t,r*n+.5*l*n,R*a+.5*o,h*n+.5*E*n),e.rotation.y=d;break;case SPLODER.Item.TYPE_ITEM:var o=e.geometry.parameters.height,c;t.getAttrib(SPLODER.Item.PROPERTY_GRAVITY)?this.placeMesh(e,t,r*n,this.getFloorLevel(r,h)+.5*o,h*n):this.placeMesh(e,t,r*n,R*a+.5*o,h*n);break;case SPLODER.Item.TYPE_BIPED:this.placeMesh(e,t,r*n,this.getFloorLevel(r,h),h*n,0,1,t.getAttrib(SPLODER.Item.PROPERTY_ROTATION)*Math.PI/180)}}},SPLODER.SceneModel.prototype.updateMeshTexturesById=function(e){var t=this.sceneMeshesById[e];if(t){var e=this.model.getItemById(e);if(t[0]&&this.setTextures(e,t[0].material),t[1]&&this.setTextures(e,t[1].material),e&&e.type<=SPLODER.Item.TYPE_LIQUID){var i=e.numChildren;if(i)for(var s=e.children;i--;)this.updateMeshTexturesById(s[i].id)}}},SPLODER.SceneModel.prototype.setVertexColors=function(e,t){if(e&&t&&t.faces){for(var i,s,o,n,o,a=t.faces.length,r=t.vertices,h=!1;a--;)s=(i=t.faces[a]).normal,i.color.setRGB(0,0,0),o=(r[i.a].x+r[i.b].x+r[i.c].x)/3/32,n=(r[i.a].y+r[i.b].y+r[i.c].y)/3/32,o+=e.x,(o=this.model.getItemUnderPoint(o,n+=e.y,0,SPLODER.Item.TYPE_LIQUID))&&(i.color.setRGB(o.getAttrib(SPLODER.Item.PROPERTY_LIQUIDLEVEL),o.getAttrib(SPLODER.Item.PROPERTY_LIQUIDTYPE),0),h=!0);h&&(t.colorsNeedUpdate=!0)}},SPLODER.SceneModel.prototype.setTextures=function(e,t){if(e&&t){var i,s=t.uniforms,o=s.ceiling?s.ceiling.value:0;e.type!=SPLODER.Item.TYPE_LIQUID||o||(i=SPLODER.SceneAssets.TYPE_WALLS);var n,a,r,h=this.assets.getTextureSet(e,i),l=[];switch(e.type){case SPLODER.Item.TYPE_LIQUID:if(o){s.textureSet.value=[e.getAttrib(SPLODER.Item.PROPERTY_LIQUIDTYPE),0,0];break}case SPLODER.Item.TYPE_WALL:if(o&&e.getAttrib(SPLODER.Item.PROPERTY_CEIL_SKY))return;case SPLODER.Item.TYPE_PLATFORM:if(s.textureSet){for(s.textureSet.value=n=o?h[1]:h[0],r=0;r<3;r++)a=n[r],l=l.concat(this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_WALLS,a));s.frames.value=l}break;case SPLODER.Item.TYPE_PANEL:case SPLODER.Item.TYPE_ITEM:for(s.textureSet.value=n=h,r=0;r<3;r++)a=n[r],l=l.concat(this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,a));s.frames.value=l}s.hasOwnProperty("selected")&&(s.selected.value=this.model.itemWithIdIsSelected(e.id)?1:0)}},SPLODER.SceneModel.prototype.buildMesh=function(t,e,i,s){if(t)if(t instanceof Array)console.log("RECT IS ARRAY",t);else{if(s=s||this.emptyArray,null==e&&(t.type<SPLODER.Item.TYPE_LIQUID||t.type==SPLODER.Item.TYPE_LIQUID&&!i)){var o=i?this.ceilingShapes:this.shapes;if(o)for(var n=o.length;n--;)try{if(o[n].userData.parentNode.id==t.id){e=o[n];break}}catch(e){console.log("error checking rectShape")}if(null==e)return console.log("Error! Item shape not found for rect",t.id,i,this.shapes.length,this.ceilingShapes.length),void this.setDirty()}var a,r,h,l,E,d,R,P,c,u,O,L,S,T,D,u,m=this.tilesize,p=this.tilesizeHalf,O=t.x,L=t.y,S=t.width,T=t.height,f={bevelEnabled:!1},h=t.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),E=t.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),l=t.getAttrib(SPLODER.Item.PROPERTY_CEIL_SKY),d=this.assets.getTextureSet(t),r=null,D,R,P,g,D,u;switch(P=null,t.type){case SPLODER.Item.TYPE_WALL:f.amount=128*p;try{a=new THREE.ExtrudeGeometry(e,f)}catch(e){return void console.log(e.stack)}i&&l?P=(R=this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_SKIES)).uniforms:((P=(R=s[D=i?1:0]instanceof THREE.ShaderMaterial?s[D]:this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_WALLS)).uniforms)&&P.ceiling&&(P.ceiling.value=i?1:0),this.setTextures(t,R),this.setVertexColors(t,a)),r=new THREE.Mesh(a,R),this.updateMeshPosition(r,t,i);break;case SPLODER.Item.TYPE_PLATFORM:f.amount=Math.max(1,E)*p;try{a=new THREE.ExtrudeGeometry(e,f)}catch(e){return void console.log(e.stack)}(P=(R=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_WALLS)).uniforms).ceiling.value=0,this.setTextures(t,R),this.setVertexColors(t,a),r=new THREE.Mesh(a,R),this.updateMeshPosition(r,t);break;case SPLODER.Item.TYPE_LIQUID:if(i)a=new THREE.PlaneBufferGeometry(t.width*m,t.height*m,1),(P=(R=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_LIQUIDS)).uniforms).ceiling.value=1,this.setTextures(t,R);else if(0!=t.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR)){f.amount=128*p;try{a=new THREE.ExtrudeGeometry(e,f)}catch(e){return void console.log(e.stack)}(P=(R=this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_WALLS)).uniforms).ceiling.value=0,this.setTextures(t,R),this.setVertexColors(t,a)}r=new THREE.Mesh(a,R),this.updateMeshPosition(r,t,i);break;case SPLODER.Item.TYPE_PANEL:case SPLODER.Item.TYPE_ITEM:P=(R=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_ITEMS)).uniforms,D=3*(c=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,d[0]))[2]||16,u=3*c[3]||16,t.type==SPLODER.Item.TYPE_PANEL&&(g=D/u,u=(D=T<=S?S:T)/g,D*=m,u*=m),a=new THREE.PlaneGeometry(D,u,1),P.nofollow.value=t.type==SPLODER.Item.TYPE_PANEL&&S!=T?1:0,this.setTextures(t,R),this.setVertexColors(t,a),r=new THREE.Mesh(a,R),this.updateMeshPosition(r,t);break;case SPLODER.Item.TYPE_BIPED:(P=(R=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_BIPEDS)).uniforms).selected.value=this.model.itemWithIdIsSelected(t.id)?1:0;var g=t.getAttrib(SPLODER.Biped.PROPERTY_ITEMFRAME_RIGHT),D=t.getAttrib(SPLODER.Biped.PROPERTY_ITEMFRAME_LEFT),y,I,w,_,a=(0<=g&&(y=s[1]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_BIPEDS),this.assets.setAltTexture(y,SPLODER.SceneAssets.TYPE_ITEMS),I=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,g),y.uniforms.frames.value=I.concat(I,I)),0<=D&&(w=s[2]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_BIPEDS),this.assets.setAltTexture(w,SPLODER.SceneAssets.TYPE_ITEMS),_=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,D),w.uniforms.frames.value=_.concat(_,_)),u=d[0],c=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_BIPEDS,u),(new SPLODER.Biped).initWithRectAndMaterial(t,R,c[0]||0,c[1]||0)),M=(a.setItemMaterials(y,I,w,_),a.build(),r=a.mesh,this);a.geometries.forEach(function(e){M.setVertexColors(t,e)}),this.updateMeshPosition(r,t)}r&&P&&(this.scene.add(r),this.sceneMeshes.push(r),this.sceneMeshesById[t.id]?this.sceneMeshesById[t.id].push(r):this.sceneMeshesById[t.id]=[r],this.sceneUniforms.push(P),this.sceneUniformsById[t.id]?this.sceneUniformsById[t.id].push(P):this.sceneUniformsById[t.id]=[P])}},SPLODER.SceneModel.prototype.placeMesh=function(e,t,i,s,o,n,a,r){e.userData.rect=t,e.position.set(i,s,o),isNaN(n)||(e.rotation.x=n),isNaN(r)||(e.rotation.y=r),isNaN(a)||(e.scale.z=a)},SPLODER.SceneModel.prototype.updateRectMeshes=function(e,t,i){if(e instanceof SPLODER.Item){var s=this.removeMeshesById([e],i);if(this.buildMesh(e,null,!1,s),(e.type==SPLODER.Item.TYPE_LIQUID||e.type==SPLODER.Item.TYPE_WALL&&e.getAttrib(SPLODER.Item.PROPERTY_CEIL))&&this.buildMesh(e,null,!0,s),t&&e.numChildren)for(var o=e.numChildren;o--;)this.updateRectMeshes(e.children[o],!0,i)}},SPLODER.SceneModel.prototype.removeShapes=function(e){for(var t,i,s,o,n,a=[this.shapes,this.ceilingShapes],r=2;r--;)if((t=a[r])instanceof Array)for(s=e.length;s--;)for(o=e[s],i=t.length;i--;){n=t[i];try{if(n.userData.parentNode.id==o.id){t.splice(i,1);break}}catch(e){console.log("Error! Shape does not contain reference to rect.")}}},SPLODER.SceneModel.prototype.updateShapes=function(e){var t,i=(e?(this.removeShapes(e),t=SPLODER.ShapeUtils.getShapes(e,!1,this.tilesize,this.model.items),this.shapes=this.shapes.concat(t),this.ceilingShapes=this.ceilingShapes.concat(SPLODER.ShapeUtils.getShapes(e,!0,this.tilesize,this.model.items))):(console.log("UPDATING SHAPES"),t=this.shapes=SPLODER.ShapeUtils.getShapes(this.model.items,!1,this.tilesize),this.ceilingShapes=SPLODER.ShapeUtils.getShapes(this.model.items,!0,this.tilesize)),this.shapes.length);for(this.shapesById=[];i--;){var s=this.shapes[i];s&&s.userData&&s.userData.parentNode&&(this.shapesById[s.userData.parentNode.id]=s[0])}return t},SPLODER.SceneModel.prototype.updateVertexColorsIntersecting=function(e){var e,i,s;e instanceof SPLODER.Item&&(e=this.model.getItemsIntersectingRect(e.x-1,e.y-1,e.width+2,e.height+2))instanceof Array&&(s=this,e.forEach(function(t){var e=s.sceneMeshesById[t.id];e instanceof Array&&e.length&&(t.type==SPLODER.Item.TYPE_BIPED?(i=e[0].userData.biped).geometries.forEach(function(e){s.setVertexColors(t,e)}):s.setVertexColors(t,e[0].geometry))}))},SPLODER.SceneModel.prototype.updateMeshesNear=function(e,t){if(e instanceof Array)if(16<e.length||e.length>.5*this.model.items.length)this.setDirty();else{var e=SPLODER.ShapeUtils.getBounds(e);if(e){var i=this.model.getItemsIntersectingRect(e.x-8,e.y-8,e.width+16,e.height+16);if(i&&i.length){SPLODER.ShapeUtils.sortByAreaDesc(i),this.updateShapes(i),this.assets.setLightMapDirty();for(var s=i.length;s--;)this.updateRectMeshes(i[s],!1,t)}}}},SPLODER.SceneModel.prototype.updateLightMap=function(e){this.assets.updateLightMap(this.model,this.shapes,e)},SPLODER.SceneModel.prototype.setSkyColor=function(e,t){e&&!t&&(t=e.getHex()),this.scene.fog=new THREE.Fog(t,1200,2400),this.renderer.setClearColor(t)},SPLODER.SceneModel.prototype.updateModel=function(){if(this.isDirty){this.updateShapes();for(var e,t,i=this.scene.children.length;i--;)(t=this.scene.children[i]).hasOwnProperty("children")&&0<t.children.length?this.scene.remove(t):t instanceof THREE.Mesh&&(this.scene.remove(t),t.geometry.dispose());this.sceneMeshes=[],this.sceneMeshesById=[],this.sceneUniforms=[],this.sceneUniformsById=[];for(var s,o,n=this.shapes,a=this.ceilingShapes,e=n.length;e--;)!(o=(s=n[e]).userData.parentNode)||o.width<=0||o.height<=0||this.buildMesh(o,s);for(e=a.length;e--;)(o=(s=a[e]).userData.parentNode).width<=0||o.height<=0||this.buildMesh(o,s,!0);for(e=n.length;e--;)(o=(s=n[e]).userData.parentNode)&&o.type==SPLODER.Item.TYPE_LIQUID&&this.buildMesh(o,s,!0);var r=this.model.items;for(e=r.length;e--;)(o=r[e]).type!=SPLODER.Item.TYPE_ITEM&&o.type!=SPLODER.Item.TYPE_BIPED&&o.type!=SPLODER.Item.TYPE_PANEL||this.buildMesh(o);this.isDirty=!1,this.assets.forcedUpdateOnly||this.assets.setLightMapDirty()}},SPLODER.SceneModel.prototype.update=function(){this.isDirty&&this.updateModel(),this.updateLightMap()},SPLODER.SceneModel.prototype.onError=function(e){console.log("Triangulation error in rect",e.id)},function(){var i=Date.now(),s=i,o=0,n=1/0,a=0,r=0,h=1/0,l=0,E=0,t=0,e=document.createElement("div"),d=(e.id="stats",e.addEventListener("mousedown",function(e){e.preventDefault(),S(++t%2)},!1),e.style.cssText="width:80px;opacity:0.9;cursor:pointer",document.createElement("div")),R=(d.id="fps",d.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",e.appendChild(d),document.createElement("div")),P=(R.id="fpsText",R.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",R.innerHTML="FPS",d.appendChild(R),document.createElement("div"));for(P.id="fpsGraph",P.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",d.appendChild(P);P.children.length<74;){var c=document.createElement("span");c.style.cssText="width:1px;height:30px;float:left;background-color:#113",P.appendChild(c)}var u=document.createElement("div"),O=(u.id="ms",u.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",e.appendChild(u),document.createElement("div")),L=(O.id="msText",O.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",O.innerHTML="MS",u.appendChild(O),document.createElement("div"));for(L.id="msGraph",L.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",u.appendChild(L);L.children.length<74;)(c=document.createElement("span")).style.cssText="width:1px;height:30px;float:left;background-color:#131",L.appendChild(c);var S=function(e){switch(t=e){case 0:d.style.display="block",u.style.display="none";break;case 1:d.style.display="none",u.style.display="block"}};return{REVISION:12,domElement:e,setMode:S,begin:function(){i=Date.now()},end:function(){var e=Date.now(),t=(o=e-i,n=Math.min(n,o),a=Math.max(a,o),O.textContent=o+" MS ("+n+"-"+a+")",Math.min(30,30-o/200*30));return L.appendChild(L.firstChild).style.height=t+"px",E++,s+1e3<e&&(r=Math.round(1e3*E/(e-s)),h=Math.min(h,r),l=Math.max(l,r),R.textContent=r+" FPS ("+h+"-"+l+")",t=Math.min(30,30-r/100*30),P.appendChild(P.firstChild).style.height=t+"px",s=e,E=0),e},update:function(){i=this.end()}}});"object"==typeof module&&(module.exports=Stats),SPLODER.GameCamera=function(e,t,i,s){THREE.PerspectiveCamera.call(this,e,t,i,s),this.easeFactor=.1;var o=1,n=(this.model=null,this.tilesize=null,this.tilesizeHalf=null,this.changed=new signals.Signal,this.completed=new signals.Signal,this.idle=!0,this.strideOffset=0,new THREE.Camera),a=(n.position.copy(this.position),new THREE.Vector3),r=this.position.clone().setZ(this.position.z-2e3),h=(a.copy(r),new THREE.Vector3),l=new THREE.Vector3,E=new THREE.Vector3,d=new THREE.Vector3,R=this,P=THREE.PerspectiveCamera.prototype;this.setModel=function(e,t){this.model=e,this.tilesize=t||32,this.tilesizeHalf=.5*this.tilesize},this.setPosition=function(e,t,i){isNaN(e)||(this.position.setX(e),n.position.setX(e)),isNaN(t)||(this.position.setY(t),n.position.setY(t)),isNaN(i)||(this.position.setZ(i),n.position.setZ(i))},this.gotoPosition=function(e,t,i){isNaN(e)||n.position.setX(e),isNaN(t)||n.position.setY(t),isNaN(i)||n.position.setZ(i),n.lookAt(r)},this.offsetBy=function(e){e instanceof THREE.Vector3&&(n.position.add(e),r.add(e)),n.lookAt(r)},this.goto=function(e,t){e&&(this.gotoPosition(e.x,e.y,e.z),n.lookAt(r),isNaN(t)||n.translateZ(t))},this.translateTo=function(e,t,i){var e=new THREE.Vector3(e-n.position.x,t-n.position.y,i-n.position.z);isNaN(e.x)&&(e.x=0),isNaN(e.y)&&(e.y=0),isNaN(e.y)&&(e.z=0),n.position.add(e),r.add(e),n.lookAt(r)},this.setTarget=function(e,t,i){isNaN(e)||r.setX(e),isNaN(t)||r.setY(t),isNaN(i)||r.setZ(i),n.lookAt(r)},this.lookAt=function(e){r=e.clone(),n.lookAt(r)},this.level=function(){r.y=n.position.y,n.lookAt(r)},this.setZoom=function(e){n.zoom=e},this.translateX=function(e){n.translateX(e)},this.translateY=function(e){n.translateY(e)},this.translateZ=function(e){n.translateZ(e)},this.getEyeLevel=function(e){var t=this.orbitMode||this.flyMode,i=n.position.y;return SPLODER.Physics.elevationCheck(this.model,i,e,0,t,!1)},this.update=function(){E.copy(this.position).sub(n.position),d.copy(r).sub(a);var e=E.lengthSq(),t=d.lengthSq(),e,t;1<e||1<t?(this.idle=!1,e=this.easeFactor,t=2*this.easeFactor,this.position.lerp(n.position,e),a.lerp(r,t),P.lookAt.call(this,a),this.position.y+=this.strideOffset,this.position.y=Math.max(-1e3,Math.min(2048,this.position.y)),h.copy(this.position),l.copy(a),this.changed.dispatch(h,l)):this.idle||(h.copy(this.position),l.copy(a),this.idle=!0,this.completed.dispatch(h,l))},Object.defineProperty(this,"destination",{get:function(){return n.position.clone()}}),Object.defineProperty(this,"targetDestination",{get:function(){return r.clone()}}),Object.defineProperty(this,"source",{get:function(){return R.position.clone()}}),Object.defineProperty(this,"target",{get:function(){return r.clone()}}),this.alignMaskObject=function(e,t){t=t||-32,e.position.copy(a),e.position.y=this.position.y,e.lookAt(this.position),e.position.copy(this.position),e.translateZ(t)}},SPLODER.GameCamera.prototype=Object.create(THREE.PerspectiveCamera.prototype),SPLODER.GameCamera.prototype.constructor=SPLODER.GameCamera,SPLODER.GameCameraControls=function(){this.camera=null,this.model=null,this.sceneModel=null,this.domElement=null,this.target=null,this.quat=null,this.enabled=!1,this.movementSpeed=.5,this.shiftKey=!1,this.activeLook=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.startMouseX=0,this.startMouseY=0,this.mouseX=0,this.mouseY=0,this.touchMoving=!1,this.touchMoveStartX=0,this.touchMoveStartY=0,this.touchMoveX=0,this.touchMoveY=0,this.numTouches=0,this.startLat=0,this.startLon=270,this.lat=0,this.lon=270,this.phi=1.82,this.theta=-1.57,this.moveForward=!1,this.moveBackward=!1,this.turnLeft=!1,this.turnRight=!1,this.strafeLeft=!1,this.strafeRight=!1,this.jump=!1,this.jumping=!1,this.lastJump=0,this.falling=!1,this.fallVelocity=new THREE.Vector3(0,0,0),this.floating=!1,this.viewHalfX=0,this.viewHalfY=0,this.canLockPointer=!1,this.pointerLocked=!1,this.prevPos={x:0,y:0,z:0};var o=this,n=(this.init=function(e,t,i,s){this.camera=e,this.model=t,this.sceneModel=i,this.domElement=void 0!==s?s:document,this.domElement!==document&&this.domElement.setAttribute("tabindex","-1");var t=this.camera.position;return this.target=new THREE.Object3D,this.target.position.x=t.x,this.target.position.y=t.y,this.target.position.z=t.z-2e3,this.quat=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),this.enabled=!0,n(),a(),r(),this},function(){o.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),o.domElement.addEventListener("mousedown",SPLODER.bind(o,o.onMouseDown),!1),o.domElement.addEventListener("mousemove",SPLODER.bind(o,o.onMouseMove),!1),o.domElement.addEventListener("mouseup",SPLODER.bind(o,o.onMouseUp),!1),o.domElement.addEventListener("mouseout",SPLODER.bind(o,o.onMouseUp),!1),o.domElement.addEventListener("touchstart",SPLODER.bind(o,o.onTouchStart),!1),o.domElement.addEventListener("touchmove",SPLODER.bind(o,o.onTouchMove),!1),o.domElement.addEventListener("touchend",SPLODER.bind(o,o.onTouchEnd),!1),document.addEventListener("pointerlockchange",SPLODER.bind(o,o.onPointerChange,!1),!1),document.addEventListener("mozpointerlockchange",SPLODER.bind(o,o.onPointerChange,!1),!1),document.addEventListener("webkitpointerlockchange",SPLODER.bind(o,o.onPointerChange,!1),!1),o.handleResize()}),a=function(){Mousetrap.bind(["w","a","s","d","up","down","left","right","shift+w","shift+a","shift+s","shift+d","shift+up","shift+down","shift+left","shift+right"],function(e){if(e&&!1!==o.enabled)switch(e.preventDefault(),o.shiftKey=e.shiftKey,e.keyCode){case 38:case 87:o.moveForward=!0;break;case 37:case 65:e.shiftKey||o.pointerLocked?o.strafeLeft=!0:o.turnLeft=!0;break;case 40:case 83:o.moveBackward=!0;break;case 39:case 68:e.shiftKey||o.pointerLocked?o.strafeRight=!0:o.turnRight=!0}},"keydown"),Mousetrap.bind(["w","a","s","d","up","down","left","right","shift+w","shift+a","shift+s","shift+d","shift+up","shift+down","shift+left","shift+right"],function(e){if(!1!==o.enabled)switch(e.keyCode){case 38:case 87:o.moveForward=!1;break;case 37:case 65:o.turnLeft=o.strafeLeft=!1;break;case 40:case 83:o.moveBackward=!1;break;case 39:case 68:o.turnRight=o.strafeRight=!1}},"keyup"),Mousetrap.bind(["space","shift+space"],function(){!1!==o.enabled&&!o.jumping&&!o.falling&&1e3<Date.now()-o.lastJump&&(o.jump=!0,o.lastJump=Date.now())},"keydown"),Mousetrap.bind("shift",function(){o.shiftKey=!0},"keydown"),Mousetrap.bind("shift",function(){o.shiftKey=!1},"keyup")},r=function(){o.canLockPointer="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document},t=function(){var e;o.canLockPointer&&(e=o.domElement,o.pointerLocked||(e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock()))};this.handleResize=function(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)},this.onMouseDown=function(e){!1!==this.enabled&&(this.domElement!==document&&(this.domElement.focus(),this.pointerLocked||t()),this.startMouseX=e.clientX,this.startMouseY=e.clientY,this.startLon=this.lon,this.startLat=this.lat,this.activeLook=!0)},this.onMouseUp=function(e){!1!==this.enabled&&(e&&(e.preventDefault(),e.stopPropagation()),this.activeLook=!1)},this.onMouseMove=function(e){var t,i;!1!==this.enabled&&(this.pointerLocked?(t=e.movementX||e.mozMovementX||e.webkitMovementX||0,i=e.movementY||e.mozMovementY||e.webkitMovementY||0,this.mouseX+=.75*t,this.mouseY+=2*i):this.domElement===document?(this.mouseX=e.pageX,this.mouseY=e.pageY):(this.mouseX=e.clientX,this.mouseY=e.clientY))},this.onPointerChange=function(){this.pointerLocked=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement||!1,console.log("pointer lock",this.pointerLocked)},this.onTouchStart=function(e){this.numTouches=e.touches.length;for(var t=0;t<e.touches.length;t++)e.touches[t].clientX<this.viewHalfX?this.touchMoving||(this.touchMoveStartX=e.clientX=e.touches[this.numTouches-1].clientX,this.touchMoveStartY=e.clientY=e.touches[this.numTouches-1].clientY,this.touchMoveX=this.touchMoveY=0,this.touchMoving=!0):this.activeLook||(this.startMouseX=this.mouseX=e.clientX=e.touches[this.numTouches-1].clientX,this.startMouseY=this.mouseY=e.clientY=e.touches[this.numTouches-1].clientY,this.activeLook=!0);this.startLon=this.lon,this.startLat=this.lat},this.onTouchMove=function(e){if(e.touches){if(e.touches.length<this.numTouches)return;for(var t=0;t<e.touches.length;t++)e.touches[t].clientX<this.viewHalfX?(this.touchMoveX=e.touches[t].clientX-this.touchMoveStartX,this.touchMoveY=e.touches[t].clientY-this.touchMoveStartY,this.moveForward=this.moveBackward=this.turnLeft=this.turnRight=!1,36<this.touchMoveX?this.turnRight=!0:this.touchMoveX<-36&&(this.turnLeft=!0),this.touchMoveY<-10?this.moveForward=!0:10<this.touchMoveY&&(this.moveBackward=!0)):(this.mouseX=e.touches[t].clientX,this.mouseY=e.touches[t].clientY)}e.preventDefault()},this.onTouchEnd=function(e){this.touchMoving=this.activeLook=!1,this.activeLook=!1;for(var t=0;t<e.touches.length;t++)e.touches[t].clientX<this.viewHalfX?this.touchMoving=!0:this.activeLook=!0;this.touchMoving||(this.moveForward=this.moveBackward=this.turnLeft=this.turnRight=!1,this.touchMoveStartX=this.touchMoveStartY=NaN,this.touchMoveX=this.touchMoveY=NaN),this.numTouches=e.touches.length},this.scroll=function(e,t){var i;!1!==this.enabled&&(e=Math.max(-6,Math.min(6,e)),t=Math.max(-6,Math.min(6,t)),i=this.camera.position.y,this.shiftKey||this.pointerLocked||1<this.numTouches?(this.camera.translateX(0-e),this.camera.translateZ(0-.4*t)):(this.target.lookAt(this.camera.position),this.target.translateX(0-16*e),this.camera.translateZ(0-.4*t),this.updateRotations(),this.updateTarget()),this.shiftKey||1<this.numTouches||(this.camera.position.y=i),this.collisionCheck())},this.collisionCheck=function(){(this.jumping&&0<this.fallVelocity.y||this.falling)&&(this.camera.offsetBy(this.fallVelocity),this.fallVelocity.y-=3,this.fallVelocity.y=Math.max(this.fallVelocity.y,-32));var e=this.camera.destination,t=(this.floating=SPLODER.GamePhysics.gravityStateCheck(this.model,e,!0),SPLODER.GamePhysics.elevationCheck(this.model,e.y,e,1,this.floating,!0));!this.floating&&t instanceof Array?4<t[1]&&(this.falling=!0):this.falling=!1,e=SPLODER.GamePhysics.collisionCheck(this.model,e,this.prevPos,this.floating,!0),this.camera.goto(e)},this.update=function(e,t){var e,i,s,i,e;this.shiftKey||this.pointerLocked||(this.strafeRight&&(this.turnRight=!0,this.strafeRight=!1),this.strafeLeft&&(this.turnLeft=!0,this.strafeLeft=!1)),!1!==this.enabled&&(this.prevPos.x=this.camera.destination.x,this.prevPos.y=this.camera.destination.y,this.prevPos.z=this.camera.destination.z,i=e=(e=Math.min(.01,e))*this.movementSpeed,(this.shiftKey||46<Math.abs(this.touchMoveY))&&(i*=2),this.floating&&(e*=.5,i*=.5),s=this.camera.position.y,this.jumping||(this.moveForward&&this.camera.translateZ(0-i),this.moveBackward&&this.camera.translateZ(i),this.shiftKey||this.pointerLocked||1<this.numTouches?(this.strafeLeft&&this.camera.translateX(0-2*e),this.strafeRight&&this.camera.translateX(2*e)):(this.turnLeft||this.turnRight)&&(this.updateTarget(),this.target.lookAt(this.camera.position),i=70*e*(1-this.camera.easeFactor),this.target.translateX(this.turnLeft?0-i:i),this.updateRotations(),this.updateTarget())),(this.activeLook||this.pointerLocked)&&(this.lon=(this.mouseX-this.startMouseX)/this.viewHalfX*180,this.lon+=this.startLon,this.lat=85*(0-(this.mouseY-this.startMouseY)/this.viewHalfY),this.lat+=this.startLat,this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.Math.degToRad(90-this.lat),this.theta=THREE.Math.degToRad(this.lon),this.phi=THREE.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax)),!this.jump||this.jumping||this.falling||this.floating==SPLODER.GamePhysics.GRAVITY_SWIM?this.falling?(this.updateTarget(),t=!0):this.floating?(this.updateTarget(),this.camera.strideOffset=2*Math.sin(Date.now()/250)-2,this.camera.position.y+=.1,t=!0):(this.jumping||this.turnLeft||this.turnRight||this.strafeLeft||this.strafeRight||this.moveForward||this.moveBackward||this.activeLook||this.pointerLocked||this.touchMoving)&&(this.jumping||this.falling||(this.camera.position.y=s),(this.strafeLeft||this.strafeRight||this.moveForward||this.moveBackward)&&!this.jumping&&(this.camera.strideOffset=2+2*Math.sin(Date.now()/50)),this.updateTarget(),t=!0):(this.jumping=this.falling=!0,this.fallVelocity.x=this.strafeLeft?5:this.strafeRight?-5:0,this.fallVelocity.y=this.floating?24:36,this.fallVelocity.z=this.moveBackward?5:this.moveForward?-5:0,this.shiftKey&&(this.fallVelocity.z*=2),e=this.camera.rotation.clone(),1.57<Math.abs(e.z)&&(e.y=Math.PI-e.y),e.x=e.z=0,this.fallVelocity.applyEuler(e),console.log(this.fallVelocity),this.jump=!1,setTimeout(function(){o.jumping=!1},250),t=!0),t)&&this.collisionCheck()},this.reset=function(){this.camera.level()},this.onCameraChanged=function(e,t){this.target.position.copy(t),this.updateRotations()},this.updateRotations=function(){var e=this.camera.position,t=new THREE.Vector3;t.copy(e).sub(this.target.position),t.applyQuaternion(this.quat),this.theta=Math.atan2(0-t.z,0-t.x),this.lon=THREE.Math.radToDeg(this.theta),this.phi=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),0-t.y),this.lat=0-(THREE.Math.radToDeg(this.phi)-90)},this.updateTarget=function(){var e=this.target.position,t=this.camera.position;this.phi-=.5*Math.PI,this.phi*=.9,this.phi+=.5*Math.PI,e.x=t.x+2e3*Math.sin(this.phi)*Math.cos(this.theta),e.y=t.y+2e3*Math.cos(this.phi),e.z=t.z+2e3*Math.sin(this.phi)*Math.sin(this.theta),this.camera.lastTargetRectId="",this.camera.lookAt(e)}},SPLODER.Broadcaster=function(){this.hasOwnProperty("_listeners")||(this._listeners=[]),this.hasOwnProperty("_callbacks")||(this._callbacks=[]),this.addListener=function(e,t,i){this._listeners.push(e),this._callbacks.push(i&&t?this.bind(i,t):t||null)},this.bind=function(e,t){return function(){t.apply(e,arguments)}},this.removeListener=function(e){for(var t=this._listeners.length;t--;)this._listeners[t]===e&&(this._listeners.splice(t,1),this._callbacks.splice(t,1))},this.broadcast=function(e,t){if(0!==this._listeners.length)for(var i,s=0;s<this._listeners.length;s++)"string"==typeof(i=this._listeners[s])?i!==e&&"all"!==i||null===this._callbacks[s]||(t&&(t.type=e),this._callbacks[s](t)):i[e]&&i[e](t)},this.mousedown||(this.mousedown=function(e){this.broadcast("mousedown",e)}),this.mousemove||(this.mousemove=function(e){this.broadcast("mousemove",e)}),this.mouseover||(this.mouseover=function(e){this.broadcast("mouseover",e)}),this.mouseup||(this.mouseup=function(e){this.broadcast("mouseup",e)}),this.mouseupoutside||(this.mouseupoutside=function(e){this.broadcast("mouseupoutside",e)}),this.mouseout||(this.mouseout=function(e){this.broadcast("mouseout",e)}),this.touchstart||(this.touchstart=function(e){this.broadcast("touchstart",e)}),this.touchmove||(this.touchmove=function(e){this.broadcast("touchmove",e)}),this.touchend||(this.touchend=function(e){this.broadcast("touchend",e)}),this.touchendoutside||(this.touchendoutside=function(e){this.broadcast("touchendoutside",e)})},SPLODER.GameView=function(){this.domElement=null,this.renderer=null,this.model=null,this.envModel=null,this.sceneAssets=null,this.loadComplete=null,this.selected=null,this.selectedMeshId=null,this.shiftKey=!1,this.width=0,this.height=0,this.tilesize=32,this.tilesizeHalf=16,this.sceneModel=null,this.pixelRatio=null,this.sceneMeshesCameraAligned=null,this.camera=null,this.cameraDummy=null,this.cameraAngle=null,this.camControls=null,this.raycaster=null,this.mouse=null,this.isDirty=!0;var t=!(this.ready=!1),i=this;Object.defineProperty(this,"autoCamera",{get:function(){return t},set:function(e){this.selected.dispatch([SPLODER.ACTION_DESELECT]),t=!!e,i.camControls.autoTracking=t}})},SPLODER.GameView.prototype.initWithModelsAndSize=function(e,t,i,s,o,n){return this.model=e,this.envModel=t,this.width=i,this.height=s,this.tilesize=o||32,this.tilesizeHalf=.5*this.tilesize,this.pixelRatio=n||1,this.selected=new signals.Signal,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.sceneAssets=(new SPLODER.SceneAssets).init(this.tilesize,this.pixelRatio),this.loadComplete=new signals.Signal,this},SPLODER.GameView.prototype.setSize=function(e,t){this.width=e,this.height=t,this.camera.aspect=e/t,this.camera.updateProjectionMatrix()},SPLODER.GameView.prototype.build=function(e,t){this.domElement=e,this.renderer=t,this.camera=new SPLODER.GameCamera(90,this.width/this.height,10,2400),this.cameraAngle=new THREE.Vector3,this.sceneMeshesCameraAligned=[],this.sceneAssets.prepared.addOnce(this.onAssetsPrepared,this),this.sceneAssets.load()},SPLODER.GameView.prototype.onAssetsPrepared=function(){this.sceneAssets.assignUniformValue("cameraAngle",this.cameraAngle),this.buildScene(),this.loadComplete.dispatch(!0),this.sceneAssets.forcedUpdateOnly=!1,this.sceneModel.updateLightMap(!0)},SPLODER.GameView.prototype.buildScene=function(){this.sceneModel=(new SPLODER.SceneModel).initWithModelsAndSize(this.model,this.envModel,this.sceneAssets,this.tilesize),this.sceneModel.build(this.renderer),this.sceneModel.watchModel(),this.camera.setModel(this.model,this.tilesize),this.camera.setPosition(0,72*this.tilesizeHalf,10*this.tilesize),this.camera.setTarget(0,76*this.tilesizeHalf,10*this.tilesize-2e3),this.camera.easeFactor=.25;var e=this.sceneModel.scene,e=(e.add(this.camera),this.cameraDummy=new THREE.Camera,e.add(this.cameraDummy),this.camControls=(new SPLODER.GameCameraControls).init(this.camera,this.model,this.sceneModel,this.domElement));e.lookSpeed=.1,e.movementSpeed=800,e.noFly=!0,e.lookVertical=!0,e.constrainVertical=!0,e.verticalMin=.7,e.verticalMax=2.2,this.camera.changed.add(e.onCameraChanged,e),this.ready=!0,e.collisionCheck(),this.updatePreview(),this.model.changed.add(this.onModelChanged,this)},SPLODER.GameView.prototype.onMouseDown=function(e){this.mouse.x=e.offsetX,this.mouse.y=e.offsetY},SPLODER.GameView.prototype.onMouseUp=function(e){if(Math.abs(this.mouse.x-e.offsetX)+Math.abs(this.mouse.y-e.offsetY)<10){var e=new THREE.Vector2;e.x=this.mouse.x/this.width*2-1,e.y=-(this.mouse.y/this.height)*2+1,this.raycaster.setFromCamera(e,this.camera);for(var t=this.raycaster.intersectObjects(this.sceneModel.scene.children,!0),i=0;i<t.length;i++)if(t[i].hasOwnProperty("object")&&t[i].object instanceof THREE.Mesh){var s,o=t[i].object;if(o.userData.hasOwnProperty("rect")){if(s=o.userData.rect,this.model.itemWithIdIsSelected(s.id,!0))break;return this.selectedMeshId=o.uuid,void this.selected.dispatch([SPLODER.ACTION_SELECT_ITEM,s])}}this.selected.dispatch([SPLODER.ACTION_DESELECT])}},SPLODER.GameView.prototype.scroll=function(e,t){this.camControls.scroll(e,t)},SPLODER.GameView.prototype.setDirty=function(){this.isDirty=!0},SPLODER.GameView.prototype.onModelChanged=function(e,t,i){if(this.sceneModel){this.isDirty=!0;var s=(this.model.selection.length,this.tilesize),o=this.tilesizeHalf;if(this.autoCamera&&!(e>=SPLODER.ACTION_SELECTION_DUPLICATE&&e<=SPLODER.ACTION_CLIPBOARD_PASTE)){var n,a,r,o=(t instanceof Array&&(1==t.length?t=t[0]:t.length&&(n=SPLODER.ShapeUtils.getBounds(this.model.selection))&&this.camera.setTarget((n.x+.5*n.width)*s,n.depth*o+2*s,(n.y+.5*n.height)*s)),e==SPLODER.ACTION_CREATE&&t instanceof SPLODER.Item&&t.type==SPLODER.Item.TYPE_ITEM&&!this.sceneModel.hasObjectWithId(t.id)&&(a=this,r=arguments,setTimeout(function(){a.onModelChanged.apply(a,r)},100)),this.sceneModel.sceneMeshesById);if(t instanceof SPLODER.Item&&o[t.id]&&!SPLODER.Geom.pointWithinRect(this.camera.position.x,this.camera.position.z,t,this.tilesize)){var n=o[t.id],h,s;if(!n)return;this.selectedMeshId&&(n[1]&&n[1].uuid==this.selectedMeshId?h=n[1]:n[0]&&n[0].uuid==this.selectedMeshId&&(h=n[0])),h||(s=0,i!=SPLODER.Item.PROPERTY_CEILDEPTH&&i!=SPLODER.Item.PROPERTY_CEILTEXTURE&&i!=SPLODER.Item.PROPERTY_CEIL_SKY&&i!=SPLODER.Item.PROPERTY_TOPWALLTEXTURE&&i!=SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE||(s=1),t.type==SPLODER.Item.TYPE_LIQUID&&i!=SPLODER.Item.PROPERTY_CEILTEXTURE&&i!=SPLODER.Item.PROPERTY_FLOORTEXTURE&&(s=s?0:1),h=o[t.id][s]),h&&this.camControls.focusOn(h)}this.selectedMeshId=null,this.setDirty()}}},SPLODER.GameView.prototype.updatePreview=function(){this.ready&&(this.isDirty=!1)},SPLODER.GameView.prototype.update=function(e){if(this.ready){var t=this.sceneModel.isDirty,s=(this.sceneModel.update(),(this.isDirty||t)&&this.updatePreview(),this.cameraAngle);s.x=0,s.y=0,s.z=1,s.x=1,s.y=0,s.z=.1,s.normalize(),s.applyQuaternion(this.camera.quaternion),s.z<-1&&(s.z+=2),s.x=Math.atan(s.x)/Math.PI,s.y=Math.acos(s.y)/Math.PI,s.z=Math.asin(s.z)/Math.PI,this.camControls.update(e,t),this.sceneAssets.setTime(Date.now()/1e3%8),this.camera.update();var o,n=this.sceneMeshesCameraAligned;for(i=0;i<n.length;i++)o=n[i],this.cameraDummy.position.copy(this.camera.position),this.cameraDummy.position.y=o.position.y;this.testLiquidMask&&(this.camera.alignMaskObject(this.testLiquidMask,-24),this.testLiquidMask.position.y=Math.min(960,this.camera.position.y),this.testLiquidMask.visible=this.camera.position.y<=1088)}},SPLODER.GameView.prototype.render=function(e){e.render(this.sceneModel.scene,this.camera),this.isDirty=!1},SPLODER.Game=function(){SPLODER.Broadcaster.call(this),this.model=null,this.dispatcher=null,this.levels=null,this.levelsDispatcher=null,this.envModel=null,this.envDispatcher=null,this.tagModel=null,this.tagDispatcher=null,this.flowModel=null,this.flowDispatcher=null,this.width=0,this.height=0,this.container=null,this.stage3d=null,this.renderer3d=null,this.pixelRatio=null,this.stats=null,this.clock=null,this.gameView=null,this.history=null,this.destroyed=!1},SPLODER.Game.prototype.initWithSize=function(e,t){this.model=(new SPLODER.GameStore).init(),this.envModel=(new SPLODER.EnvModel).init(),this.levels=(new SPLODER.Levels).initWithModels(this.model,this.envModel);var i=this.width=Math.max(640,Math.min(800,window.innerWidth)),s=this.height=Math.max(480,Math.min(600,window.innerHeight));768<=s&&this.bottomPanelTab&&(panelHeight-=270),this.tilesize=e,this.pixelRatio=t||1,this.dispatcher=new signals.Signal,this.model.registerWithDispatcher(this.dispatcher),this.dispatcher.add(this.onModelChanged,this),this.model.changed.add(this.onModelChanged,this),this.levelsDispatcher=new signals.Signal,this.levels.registerWithDispatcher(this.levelsDispatcher),this.levels.changed.add(this.onLevelsChanged,this),this.envDispatcher=new signals.Signal,this.envModel.registerWithDispatcher(this.envDispatcher),this.envModel.changed.add(this.onEnvModelChanged,this),this.gameView=(new SPLODER.GameView).initWithModelsAndSize(this.model,this.envModel,i,s,32,this.pixelRatio),this.gameView.selected.add(this.onPreviewSelect,this),this.tagModel=(new SPLODER.TagModel).init(),this.tagDispatcher=new signals.Signal,this.tagModel.registerWithDispatcher(this.tagDispatcher),this.flowModel=(new SPLODER.FlowStore).init(),this.flowDispatcher=new signals.Signal,this.flowModel.registerWithDispatcher(this.flowDispatcher),this.history=(new SPLODER.ModelHistory).init(),this.history.registerModel(this.model),this.history.registerModel(this.levels),this.history.registerModel(this.flowModel),this.history.registerModel(this.tagModel),this.history.registerModel(this.envModel),window.addEventListener("mouseup",SPLODER.bind(this,this.onMouseUp),!1),window.addEventListener("keyup",SPLODER.bind(this,this.onMouseUp),!1),window.addEventListener("touchend",SPLODER.bind(this,this.onMouseUp),!1)},SPLODER.Game.prototype.build=function(e){this.container=document.getElementById(e);var e=this.width=Math.max(640,Math.min(800,window.innerWidth)),t=this.height=Math.max(480,Math.min(600,window.innerHeight)),e=Math.floor(.5*e),i=Math.floor(t)-96,s,t,o,n,a,e;768<=t&&this.bottomPanelTab&&(i-=270),this.container&&(t=function(e){var t=null,i=null;"wheelDeltaX"in(e=window.event||e)?(t=.25*e.wheelDeltaX,i=.25*e.wheelDeltaY):"deltaX"in e&&(t=0-.25*e.deltaX,i=0-.25*e.deltaY),s.scroll(t,i,e)},"addEventListener"in(o=(s=this).container)?(o.addEventListener("mousewheel",t,!1),o.addEventListener("wheel",t,!1)):o.attachEvent("onmousewheel",t),n=document.getElementById("gameview"),this.clock=new THREE.Clock,a=this.renderer3d=new THREE.WebGLRenderer({premultipliedAlpha:!1,antialias:!1,alpha:!1,overdraw:1}),n.style.cursor="cell",a.premultipliedAlpha=!0,a.sortObjects=!1,a.setPixelRatio(this.pixelRatio),a.setSize(e,i),a.setClearColor(0,1),this.stage3d=a.domElement,n.appendChild(this.stage3d),this.gameView.loadComplete.addOnce(this.onLoadComplete,this),this.gameView.build(this.stage3d,a),"addEventListener"in o?(n.addEventListener("mousewheel",t,!1),n.addEventListener("wheel",t,!1)):n.attachEvent("onmousewheel",t),a.domElement.addEventListener("mouseup",SPLODER.bind(this.gameView,this.gameView.onMouseUp),!1),a.domElement.addEventListener("mousedown",SPLODER.bind(this.gameView,this.gameView.onMouseDown),!1),(e=this.stats=new Stats).setMode(0),e.domElement.style.position="absolute",e.domElement.style.left="0",e.domElement.style.top="0",document.body.appendChild(e.domElement),this.onResize(!0))},SPLODER.Game.prototype.onResize=function(e){console.log("RESIZE CALLED",window.orientation,e);var t=this.width=Math.max(640,Math.min(800,window.innerWidth)),i=this.height=Math.max(480,Math.min(600,window.innerHeight)),s=(this.renderer3d.setPixelRatio(this.pixelRatio),this.renderer3d.setSize(t,i),this);e&&setTimeout(function(){s.onResize()},1e3)},SPLODER.Game.prototype.start=function(){var t,i;this.started||(this.gameView.sceneAssets.forcedUpdateOnly=!1,i=function(){var e;t.destroyed||(requestAnimationFrame(i),t.stats&&t.stats.begin(),(e=t.gameView)&&e.ready&&(e.update(t.clock.getDelta()),e.render(t.renderer3d),t.stats)&&t.stats.end())},(t=this).updateButtonStates(),window.addEventListener("resize",SPLODER.bind(this,this.onResize),!1),window.addEventListener("orientationchange",SPLODER.bind(this,this.onResize),!1),window.scrollTo(0,1),this.started=!0,requestAnimationFrame(i))},SPLODER.Game.prototype.scroll=function(e,t,i){var s;i&&i.target&&i.target.parentNode&&"gameview"===i.target.parentNode.id&&(this.gameView.scroll(e,t),i.preventDefault())},SPLODER.Game.prototype.onLoadComplete=function(){console.log("ASSETS LOAD COMPLETE"),this.dispatcher.dispatch("loadComplete")},SPLODER.Game.prototype.onModelChanged=function(){},SPLODER.Game.prototype.onLevelsChanged=function(e){e!=SPLODER.ACTION_CONTEXT_CHANGE&&e!=SPLODER.ACTION_CHANGE||(this.gameView.setDirty(),!this.gameView.sceneModel)||this.gameView.sceneModel.setDirty()},SPLODER.Game.prototype.onEnvModelChanged=function(e){e&&this.envDispatcher.dispatch(e)},SPLODER.Game.prototype.onPreviewSelect=function(e){this.dispatcher.dispatch(e)},SPLODER.Game.prototype.onMouseUp=function(){},SPLODER.Game.prototype.updateButtonStates=function(e){var t;e instanceof Array&&e[0]},SPLODER.Game.prototype.onButtonPress=function(e,t){if(!(null==e||t&&t.classList.contains("disabled"))){var t=e.split("-")[0],e=e.split("-")[1];switch(null==e&&(e=t,t=""),console.log(t,e),t,e){case"fullscreen":var i=document.body;i.requestFullscreen?i.requestFullscreen():i.msRequestFullscreen?i.msRequestFullscreen():i.mozRequestFullScreen?i.mozRequestFullScreen():i.webkitRequestFullscreen&&i.webkitRequestFullscreen(),document.body.classList.add("fullscreen");break;case"exitfullscreen":document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),document.body.classList.remove("fullscreen")}}};var perimSegments,holeSegments,game=new SPLODER.Game;document.body.onload=function(){console.log("DOCUMENT LOADED");var e=1280<=window.screen.width?1:.5;game.initWithSize(16,e),game.build("game_container"),game.start(),game.dispatcher.addOnce(function(e){"loadComplete"==e&&(console.log("GAMEMAIN: ASSETS LOAD COMPLETED!"),game.model.unserialize("118,0,-51,7,28,25,[[@,75,73,@,@,@,@,@,@,@,@,20]]|216,0,21,7,28,25,[[@,75,73,@,@,46,9,@,@,@,@,20]]|215,0,21,-26,27,25,[[@,75,73,@,@,75,72,@,@,@,@,20]]|32,0,-51,-26,27,25,[[@,75,73,@,@,@,@,@,@,@,@,20]]|33,0,-50,-23,25,21,[[@,68,87]]|213,0,22,-23,25,21,[[@,68,97]]|117,0,-49,10,25,21,[[@,68,87]]|214,0,23,10,25,21,[[@,68,87]]|294,0,-23,-5,18,22,[[@,33,@,@,@,@,@,@,@,@,@,@,@,@,@,0]]|61,0,-4,-16,9,44,[[@,83,83,@,@,79,70,@,@,@,@,10,@,@,@,1]]|212,0,68,-16,9,44,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|140,0,-4,-15,8,42,[[@,64,103,@,@,78,@,@,@,@,@,10,3]]|253,0,5,-22,14,22,[[@,46,46,@,@,24,44,@,@,@,@,10]]|287,0,-59,32,36,8,[[@,91,91]]|211,0,48,-16,20,11,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|52,0,-24,-16,20,11,[[@,80,80,@,@,78,70,@,@,@,@,240,1]]|210,0,49,17,19,11,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|116,0,-23,17,19,11,[[@,80,80,@,@,78,71,@,@,@,@,240,1]]|209,0,48,-15,20,9,[[@,64,85,@,@,@,@,@,@,@,@,150,1]]|51,0,-24,-15,20,9,[[@,64,85,@,@,@,@,@,@,@,@,80,3]]|208,0,49,18,19,9,[[@,64,85,@,@,@,@,@,@,@,@,150,1]]|115,0,-23,18,19,9,[[@,82,103,@,@,@,@,@,@,@,@,90,3]]|276,0,-59,11,8,21,[[@,91,91]]|295,2,-21,-3,12,14,[[@,4,@,@,@,@,@,@,@,@,@,@,@,31]]|206,2,30,15,12,12,[[@,60,@,@,@,@,@,@,@,@,@,@,@,66,1,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|114,2,-42,15,12,12,[[@,60,@,@,@,@,@,@,@,@,@,@,@,66,0,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|257,0,-16,-22,21,6,[[@,46,46,@,@,24,44,@,@,@,@,10]]|274,0,-57,13,6,19,[[@,63,99]]|204,0,68,13,8,14,[[@,64,85,@,@,@,@,@,@,@,@,150,4]]|205,0,29,-1,14,8,[[@,79,79,@,@,@,@,@,@,@,@,10]]|121,0,-43,-1,14,8,[[@,79,79,@,@,@,@,@,@,@,@,10]]|268,0,-23,28,9,12,[[@,91,91]]|48,2,-50,-19,12,9,[[@,55,@,@,@,@,@,@,@,@,@,@,@,66,2,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|203,0,30,-1,12,8,[[@,68,93]]|120,0,-42,-1,12,8,[[@,68,83]]|207,2,22,-18,12,8,[[@,55,@,@,@,@,@,@,@,@,@,@,@,66,0,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|286,0,-59,40,43,2,[[@,73,73,@,@,@,@,@,@,@,@,@,@,@,@,@,1]]|202,0,68,-15,8,10,[[@,64,85,@,@,@,@,@,@,@,@,150,6]]|252,0,12,-16,5,15,[[@,34,50]]|267,0,-23,28,7,10,[[@,79,111]]|131,0,-67,1,16,4,[[@,60,79,@,@,@,@,@,@,@,@,10]]|201,0,5,1,16,4,[[@,60,79,@,@,@,@,@,@,@,@,10]]|256,0,5,-21,12,5,[[@,34,51]]|273,0,-57,32,10,6,[[@,63,99]]|249,0,-4,20,8,7,[[@,82,103]]|231,0,15,12,6,9,[[@,83,83,@,@,18,18,@,@,@,@,10,3]]|290,1,-4,8,9,6,[[@,64,@,@,@,78],@,[@,@,@,33,-7]]|110,0,-40,17,7,7,[[@,57,90,@,@,@,@,@,@,@,@,150,@,@,@,@,1]]|107,1,-49,24,7,7,[[@,75],@,[@,@,@,77,-24]]|289,0,-4,8,8,6,[[@,34]]|196,0,68,-5,8,6,[[@,64,85,@,@,@,@,@,@,@,@,150,4]]|246,0,-4,-6,8,6,[[@,34]]|198,0,68,1,8,6,[[@,64,85,@,@,@,@,@,@,@,@,150,5]]|197,0,68,7,8,6,[[@,64,85,@,@,@,@,@,@,@,@,150,6]]|298,2,-29,-1,6,8,[[@,0,@,@,@,@,@,@,@,@,@,@,@,3,2,@,@,0]]|187,1,24,-9,7,6,[[@,73,1,@,@,87,87],@,[@,78]]|293,0,5,7,5,8,[[@,83,83,@,@,79,70,@,@,@,@,10,2,@,@,1]]|45,0,-43,-26,13,3,[[@,68,83]]|217,3,-43,-26,13,3,[[@,68,@,@,@,71]]|195,0,30,7,12,3,[[@,68,93]]|271,0,-41,32,6,6,[[@,67,99]]|112,0,-42,7,12,3,[[@,68,83]]|269,0,-29,32,6,6,[[@,75,111]]|272,0,-47,32,6,6,[[@,63,99]]|270,0,-35,32,6,6,[[@,71,111]]|200,0,33,18,6,6,[[@,57,101,@,@,53,@,@,@,@,@,50,8,@,@,@,0]]|65,1,-42,-19,4,9,[[@,75],@,[@,@,@,71,16]]|230,0,16,13,5,7,[[@,71,83]]|251,0,5,-6,7,5,[[@,34,51]]|132,0,-67,5,16,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|248,0,-4,16,8,4,[[@,76,103]]|134,0,-67,-1,16,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|193,0,5,5,16,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|191,0,29,-26,13,2,[[@,68]]|12,0,-46,-9,5,5,[[@,65,81]]|264,0,-15,-21,5,5,[[@,58,79]]|9,0,-32,-20,5,5,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|292,0,5,8,4,6,[[@,34]]|188,0,67,-5,1,22,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|123,0,-5,-5,1,22,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|68,1,-50,-13,2,11,[[@,76,4],@,[@,78]]|234,3,18,11,2,11,[[@,60,@,@,@,5,6,7]]|105,1,-49,10,7,3,[[@,76,4],@,[@,78]]|254,3,-11,-26,9,2,[[@,42,@,@,@,5,6,7]]|192,0,5,0,16,1,[[@,75,75,@,@,@,@,@,@,@,@,10]]|130,0,-51,-1,2,8,[[@,62,79,@,@,@,@,@,@,@,@,10]]|129,0,-49,-1,2,8,[[@,64,83,@,@,@,@,@,@,@,@,10]]|183,0,21,-1,2,8,[[@,62,79,@,@,@,@,@,@,@,@,10]]|184,0,23,-1,2,8,[[@,64,83,@,@,@,@,@,@,@,@,10]]|182,0,27,-1,2,8,[[@,68,83,@,@,@,@,@,@,@,@,10]]|127,0,-47,-1,2,8,[[@,66,83,@,@,@,@,@,@,@,@,10]]|181,0,25,-1,2,8,[[@,66,83,@,@,@,@,@,@,@,@,10]]|135,0,-69,-1,2,8,[[@,75,75,@,@,@,@,@,@,@,@,10]]|125,0,-45,-1,2,8,[[@,68,83,@,@,@,@,@,@,@,@,10]]|219,3,-5,1,4,4,[[@,75,@,@,@,4,5,6]]|218,3,1,-13,4,4,[[@,75,@,@,@,4,5,6]]|220,3,1,24,4,4,[[@,93,@,@,@,4,5,6]]|263,0,-10,-21,3,5,[[@,54,79]]|260,0,-4,-21,3,5,[[@,46,67]]|261,0,-7,-21,3,5,[[@,50,71]]|259,0,-1,-21,3,5,[[@,42,63]]|258,0,2,-21,3,5,[[@,38,59]]|180,0,21,13,2,7,[[@,71,83,@,@,@,@,@,@,@,@,@,3]]|103,0,-51,13,2,7,[[@,71,83]]|179,0,30,-2,12,1,[[@,68,93]]|47,0,-42,-2,12,1,[[@,68,83]]|171,0,21,-22,1,12,[[@,71,83]]|242,3,-9,-17,6,2,[[@,56,@,@,@,49]]|178,0,42,20,2,5,[[@,66,100,@,@,@,@,@,@,@,@,@,@,@,@,0]]|111,0,-30,20,2,5,[[@,66,100,@,@,@,@,@,@,@,@,@,@,@,@,0]]|241,3,-5,6,2,5,[[@,69,@,@,@,48]]|175,1,70,20,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|173,1,70,-12,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|176,1,70,-3,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|174,1,70,3,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|177,1,70,9,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|170,0,47,-14,1,7,[[@,66,83]]|172,0,48,19,1,7,[[@,66,83]]|44,0,-25,-14,1,7,[[@,66,83]]|46,0,-51,-19,1,6,[[@,71,83]]|104,0,-22,27,6,1,[[@,82,96]]|229,3,-51,-19,1,6,[[@,71,@,@,@,71]]|227,3,21,-16,1,6,[[@,71,@,@,@,71]]|228,3,21,-22,1,6,[[@,71,@,@,@,71]]|281,0,-39,38,2,2,[[@,83,95]]|282,0,-33,38,2,2,[[@,87,99]]|291,0,-5,9,1,4,[[@,34,51,@,@,@,@,@,@,@,@,10]]|283,0,-27,38,2,2,[[@,91,103]]|262,0,-15,-16,4,1,[[@,60,81,@,@,@,@,@,@,@,@,10]]|167,0,75,16,1,4,[[@,76,82,@,@,@,@,@,@,@,@,@,@,@,@,0],@,[@,80]]|279,0,-51,38,2,2,[[@,75,87]]|168,0,34,-12,2,2,[[@,82,82,@,@,@,45,@,@,@,@,@,@,@,@,1],@,[@,80]]|185,0,4,1,1,4,[[@,62,76,@,@,@,@,@,@,@,@,10]]|169,0,29,1,1,4,[[@,68,79,@,@,@,@,@,@,@,@,10]]|250,0,4,9,1,4,[[@,34,76,@,@,@,@,@,@,@,@,10]]|280,0,-57,38,2,2,[[@,75,87]]|285,0,19,-2,2,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|277,0,-45,38,2,2,[[@,79,91]]|288,0,-21,38,2,2,[[@,95,107]]|124,0,-43,1,1,4,[[@,68,79,@,@,@,@,@,@,@,@,10]]|296,0,4,-5,1,4,[[@,34,76,@,@,@,@,@,@,@,@,10]]|10,0,-33,-10,2,2,[[@,82,82,@,@,@,@,@,@,@,@,@,@,@,@,1],@,[@,80]]|59,0,-9,-15,3,1,[[@,72,72]]|97,0,-8,26,3,1,[[@,72,72]]|157,0,58,18,3,1,[[@,72,72]]|102,0,-8,18,3,1,[[@,72,72]]|60,0,-15,-7,3,1,[[@,72,72]]|98,0,-20,18,3,1,[[@,72,72]]|161,0,64,26,3,1,[[@,72,72]]|163,0,63,-7,3,1,[[@,72,72]]|109,0,-43,24,1,3,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|57,0,-9,-7,3,1,[[@,72,72]]|101,0,-14,18,3,1,[[@,72,72]]|165,0,52,26,3,1,[[@,72,72]]|100,0,-14,26,3,1,[[@,72,72]]|53,0,-21,-7,3,1,[[@,72,72]]|156,0,58,26,3,1,[[@,72,72]]|158,0,29,24,1,3,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|159,0,51,-15,3,1,[[@,72,72]]|160,0,51,-7,3,1,[[@,72,72]]|162,0,57,-15,3,1,[[@,72,72]]|54,0,-21,-15,3,1,[[@,72,72]]|155,0,64,18,3,1,[[@,72,72]]|164,0,57,-7,3,1,[[@,72,72]]|166,0,52,18,3,1,[[@,72,72]]|266,0,-8,-22,2,1,[[@,58,66,@,@,@,@,@,@,@,@,10]]|237,0,29,-8,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|239,0,29,-5,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|236,0,25,-8,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|238,0,25,-5,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|235,4,72,7,0,0,[[@,77,@,@,@,@,35,36,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,0]]|154,4,72,-6,0,0,[[@,77,@,@,@,@,35,36,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,0]]|64,4,-44,-6,0,0,[[@,68]]|150,5,37,-19,0,0,[[0,68,@,@,@,1,100,30,100,252,100,178,7,@,@],@,@,[],@,@,@,@,@,@,[],[]]|62,5,-13,-11,0,0,[[-180,64,@,@,@,2,181,@,127,@,183,163,201,55,56,@,@,75,57,56,60,71],[],[@,@,@,43,16],[],@,@,@,@,@,@,@,[]]|63,5,-36,-18,0,0,[[0,68,@,@,@,@,100,@,100,@,100,178,216,69,50],@,@,[],@,@,@,@,@,@,[],[]]|153,5,60,22,0,0,[[-90,64,@,@,@,3,181,@,127,@,183,163,201,@,@,@,@,75,57,56,60,71],[],[@,@,@,-30,-17],[],@,@,@,@,@,@,@,[]]|95,5,-12,22,0,0,[[-270,64,@,@,@,2,181,@,127,@,183,163,201,55,56,@,@,75,57,56,60,71],[],[@,@,@,42,-17],[],@,@,@,@,@,@,@,[]]|151,5,59,-11,0,0,[[-90,64,@,@,@,3,181,@,127,@,183,163,201,@,@,@,@,75,57,56,60,71],[],[@,@,@,-29,16],[],@,@,@,@,@,@,@,[]]|152,5,35,27,0,0,[[-180,68,@,@,@,@,100,@,100,@,100,178,216,69,49],@,@,[],@,@,@,@,@,@,[],[]]|94,5,-35,15,0,0,[[-180,68,@,@,@,@,100,@,100,@,100,178,216,69,51],@,@,[],@,@,@,@,@,@,[],[]]|91,6,-45,-17,0,0,[[@,@,@,@,@,@,@,@,@,@,@,35,3]]|226,6,10,18,0,0,[[]]|222,6,-3,3,0,0,[[@,@,@,@,@,@,@,@,@,@,@,@,2]]|148,6,29,-15,0,0,[[@,@,@,@,@,@,@,@,@,@,@,35,0]]|225,6,10,-25,0,0,[[]]|221,6,2,25,0,0,[[@,@,@,@,@,@,@,@,@,@,@,@,2]]|265,6,-7,-20,0,0,[[@,@,@,@,@,@,@,@,@,@,@,15,7]]|297,6,-14,5,0,0,[[@,@,@,@,@,@,@,@,@,@,@,75]]|147,6,32,35,0,0,[[@,@,@,@,@,@,@,@,@,@,@,55,7]]|223,6,3,-11,0,0,[[@,@,@,@,@,@,@,@,@,@,@,15,2]]|232,6,18,16,0,0,[[@,@,@,@,@,@,@,@,@,@,@,40,3]]|149,6,36,20,0,0,[[@,@,@,@,@,@,@,@,@,@,@,30,8]]|88,6,-36,16,0,0,[[@,@,@,@,@,@,@,@,@,@,@,55,7]]|92,6,-40,35,0,0,[[@,@,@,@,@,@,@,@,@,@,@,55,7]]~"))})};